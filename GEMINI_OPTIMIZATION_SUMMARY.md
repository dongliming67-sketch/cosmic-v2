# COSMIC拆分智能体优化总结 - 融合Gemini四阶段方法论

## 优化概述

本次优化基于Gemini提出的COSMIC拆分四阶段方法论，对现有智能体进行了全面升级，确保输出的功能过程具备：
1. **立体化建模**：超越平面CRUD思维
2. **物理层唯一性**：数据属性组合的绝对不重复
3. **全生命周期覆盖**：从预审到归档的完整路径

---

## Gemini四阶段方法论详解

### 第一阶段：文档解耦（理解层 - Document Decoupling）

**目标**：将杂乱的叙述转化为COSMIC的三大核心要素

#### 1. 锁定「功能用户」（Functional User）
- **做法**：无视业务逻辑，只找「边界交互者」
- **分类标准**：
  * 用户触发：人工操作、界面点击、手动输入
  * 时钟触发：定时任务、周期执行、自动调度
  * 接口触发：外部系统调用、API推送、消息队列

#### 2. 识别「数据对象」（Object of Interest）
- **判断标准**：该实体是否具有独立的状态或属性集合
- **建立实体字段池**：为后续去重做准备

#### 3. 定义「触发事件」（Triggering Event）
- **寻找启动开关**：点击、调用接口、定时器到期、消息到达

---

### 第二阶段：过程膨胀与维度扩展（策略层 - Process Expansion）

**目标**：当文档内容显得单薄时，如何合理地拆分出更多不重复的功能点

#### 1. 生命周期全路径拆解（纵向 - 流程轴）
不要只拆「业务处理」，要将一个事务的生命周期拆开：
- **预审准入**：参数校验、身份鉴权、格式验证、前置条件检查
- **主体执行**：核心数据处理、业务逻辑运算、状态转换
- **异步反馈**：结果通知、回调同步、消息推送、事件发布
- **历史追踪**：审计日志生成、操作快照备份、版本记录

#### 2. 专项管理维度拆解（横向 - 管理轴）
如果一个接口涉及多个数据对象，强制将其「降维」：
- **归因维度**：追溯操作来源、记录操作路径
- **资产更新维度**：变更资产状态、更新资源配置
- **效能统计维度**：性能指标采集、业务数据汇总
- **合规审计维度**：权限验证、操作审计、数据脱敏

#### 3. 负向与异常路径拆解（深度 - 颗粒度）
- **逻辑失败分支**：驳回、撤回、挂起、超时
- **系统防御分支**：接口超限拦截、格式非法过滤、并发冲突检测

#### 4. 字段级颗粒度切片
- 每一个核心字段（状态码、时间戳、流水号）都应作为独立功能过程的支撑点
- 例如：「设备上报接口」→「设备状态上报」+「设备告警上报」+「设备性能指标上报」

---

### 第三阶段：ERWX原子化对照（执行层 - Atomic Decomposition）

**目标**：将识别出的功能过程（FP）填入标准格式，确保逻辑闭环

#### 对于每一个FP，机械化地填充以下四个动作：

**E (Entry - 接收/门卫)**：数据跨越边界进入
- 职责：接收原始请求、解析协议头、校验调用者身份令牌
- 属性通常包含：请求标识、触发源、核心业务ID、请求时间戳
- 描述公式：接收 + [场景化业务对象] + [协议类型/数据形态] + 指令/包
- 示例：「接收低空任务配置信息异步提交参数包」

**R (Read - 读取/大脑)**：系统为了处理该请求而必须查询的数据
- 职责：从数据库检索业务配置、对齐标准字典、检查历史冲突状态
- 属性包含：映射规则、配置参数、历史快照、关联实体
- 描述公式：检索 + [业务状态/字典] + [关联关系] + 集合/数据
- 示例：「检索低空任务执行前置条件配置规则集合」

**W (Write - 写入/执行)**：系统处理后的结果保存
- 职责：更新业务逻辑主表、原子化写入操作日志、持久化中间态数据
- 属性包含：更新后的状态、操作时间、执行日志、版本号
- 描述公式：持久化/记录 + [更新行为] + [表族名] + 事务流水
- 示例：「持久化低空任务配置变更事务流水表」

**X (eXit - 输出/反馈)**：数据跨越边界返回
- 职责：封装标准响应协议体、映射层级化错误码、记录接口处理耗时
- 属性包含：返回码、提示语、业务处理回执、响应时间戳
- 描述公式：封装 + [响应等级] + [返回码映射] + 响应体
- 示例：「封装低空任务配置确认回执响应体」

---

### 第四阶段：全局数据查重（质量层 - Global Deduplication）

**目标**：确保数据属性组合在50个（或更多）过程点中唯一

#### 核心字段 + 随机辅助字段的动态组合算法

**1. 核心字段占位**
- 根据FP的含义分配专属字段（如：若FP涉及硬件，则必选SN类字段）
- 每个功能过程必须有一个「锚定字段」作为身份标识

**2. 辅助字段填充**
- 从通用字段池（ID、Time、Operator、Status、Code、Version、Source、Target）中随机抽取
- 确保不同功能过程使用不同的辅助字段组合

**3. 查重算法**
- **语义去重**：确保过程名称的「动作+对象」组合唯一
- **物理去重**：检查当前属性组（Attribute Group）的字段集合
  * 如果A过程用了(字段A, B, C)，B过程即便必须用字段A，也会强迫它搭配(D, E)
  * 从而使指纹唯一，实现物理排他性

**4. 字段互斥原则**
- 同一表格中，相邻的两个功能过程，其数据属性重合度不得超过30%
- 必须包含业务字段（如：sn、code、type）和管理字段（如：timestamp、retry_count、operator_id）

---

## 已实施的优化内容

### 1. 增强COSMIC_SYSTEM_PROMPT（`@server/index.js:75-217`）

**优化点**：
- ✅ 融合四阶段方法论的完整描述
- ✅ 明确文档解耦的三大要素识别方法
- ✅ 详细说明过程膨胀的3D轴向分析（纵向、横向、深度）
- ✅ 规范ERWX原子化建模的描述公式
- ✅ 引入全局数据查重的核心字段+辅助字段动态组合算法
- ✅ 强调字段互斥原则（重合度不得超过30%）

### 2. 优化文档理解阶段（`@server/index.js:1077-1205`）

**优化点**：
- ✅ 引入第一阶段「文档解耦」的任务分解
- ✅ 引入第二阶段「过程膨胀」的3D轴向分析框架
- ✅ 要求输出**字段池（Field Pool）**：
  * businessFields：业务字段（锚定字段候选）
  * managementFields：管理字段（辅助字段候选）
- ✅ 要求为每个功能指定**anchorField**（锚定字段）
- ✅ 要求提供**suggestedAttributes**（建议的字段组合，体现互斥性）
- ✅ 应用7状态扩容法：预查、执行、审核、校对、转存、归档、异常重试、补发

### 3. 命名规范强化

**Object + Action + State格式**：
- ❌ 严禁：「接收任务请求」
- ✅ 推荐：「接收【低空任务】【配置信息】【异步提交】参数包」

**数据组命名**：
- ❌ 禁止：「请求」、「响应」、「表格」、「记录」
- ✅ 推荐：「业务负荷包」、「状态统一库」、「反馈确认包」、「事务流水表」、「配置规则集」

---

## 核心改进效果

### 1. 立体化建模（3D Modeling）

**纵向（流程轴）**：
- 原来：只有「创建任务」
- 现在：「任务创建预校验」→「任务创建执行」→「任务创建结果异步通知」→「任务创建操作审计」

**横向（管理轴）**：
- 原来：只关注业务功能
- 现在：自动补全「操作审计」、「权限核查」、「字典对齐」、「系统日志」、「合规自检」

**深度（颗粒度）**：
- 原来：一个接口一个功能
- 现在：按字段切片，一个接口拆分为多个功能（状态上报、告警上报、性能指标上报）

### 2. 物理层唯一性保证

**字段组合互斥**：
- 功能A：设备ID + 设备SN + 操作人ID + 时间戳
- 功能B：设备ID + 设备类型 + 流水号 + 版本号
- 重合度：1/4 = 25% < 30% ✅

**锚定字段机制**：
- 硬件相关功能 → 必选SN类字段
- 用户相关功能 → 必选用户ID字段
- 任务相关功能 → 必选任务ID字段

### 3. 全生命周期覆盖

**传统CRUD**：
- 创建、查询、修改、删除（4个功能）

**立体化拆分**：
- 创建预校验、创建执行、创建审核、创建归档
- 查询参数验证、查询执行、查询日志记录、查询结果封装
- 修改权限核查、修改执行、修改版本记录、修改通知推送
- 删除前置检查、删除执行、删除快照备份、删除审计记录
- **总计：16+个功能**

---

## 使用建议

### 智能体指令（Prompt）终极建议

**请不要转述文档，而是将文档视为『数据字典』和『流程引擎』。**

以文档中的接口为锚点，按以下五个维度进行FP膨胀：

1. **正向执行**：核心业务流程的标准路径
2. **逆向驳回**：业务流程的回退、撤销、驳回路径
3. **异常拦截**：参数校验、权限验证、格式检查、并发控制
4. **管理审计**：操作日志、审计记录、版本管理、快照备份
5. **数据合规**：数据脱敏、权限控制、字典对齐、合规自检

**并确保每个FP的数据属性组合具有物理排他性。**

---

## 后续优化方向

### 1. 实时去重验证
在生成过程中实时检查数据属性组合的重合度，动态调整字段选择

### 2. 字段池智能推荐
基于文档内容自动提取字段池，并为每个功能推荐最优的字段组合

### 3. 质量评分机制
对生成的功能过程进行质量评分：
- 命名规范性（Object+Action+State）
- 子过程完整性（E+R+W+X）
- 字段组合唯一性（重合度<30%）
- 业务场景覆盖度（3D轴向完整性）

### 4. 可视化展示
将3D轴向分析结果可视化展示，帮助用户理解功能过程的立体结构

---

## 总结

通过融合Gemini的四阶段方法论，COSMIC拆分智能体实现了从「平面」到「立体」的质的飞跃：

✅ **文档解耦**：精准识别功能用户、数据对象、触发事件  
✅ **过程膨胀**：3D轴向分析，全生命周期覆盖  
✅ **ERWX原子化**：机械化填充，确保逻辑闭环  
✅ **全局查重**：物理层唯一性，字段组合互斥  

**核心价值**：确保输出的功能过程超越简单的CRUD，具备极高的实战价值与差异化，数据属性组合在50+过程点中保持绝对唯一。
