# Cosmic拆分智能体 - 触发类型识别与文档理解优化

## 优化日期
2025年1月

## 优化背景
用户反馈两个核心问题：
1. **智能体不能准确判断功能是前台还是后台、用户触发还是定时触发**
2. **文档深度理解质量不够，拆分出来的功能质量有待提升**

## 优化方案

### 一、文档深度理解阶段优化（最关键！）

#### 1.1 采用"四遍阅读法"
原来是"三遍阅读法"，现在增强为"四遍阅读法"，增加了专门的触发方式分析环节：

- **第一遍**：整体理解与系统架构
  - 识别业务领域、目标用户、核心价值
  - 理解系统边界
  - 梳理业务实体及其关系
  - **新增**：识别系统架构（前台交互系统 vs 后台服务系统 vs 定时任务系统）

- **第二遍**：功能枚举与场景分析
  - 识别显式功能，**并明确触发方式**
  - 识别隐式功能，**拆分时必须标注触发方式**
  - 识别界面元素对应功能（都是用户触发）
  - 识别数据操作功能（需判断触发方式）
  - 识别系统级功能（大多是用户触发）
  - **重点识别后台自动化功能**，明确区分定时任务、接口触发、用户发起的异步任务

- **第三遍**：触发方式深度分析（新增，极其重要！）
  - **判断规则一：用户触发的特征**
    - 包含"点击"、"选择"、"输入"等用户动作词汇
    - 界面元素对应的功能
    - 即使是后台执行的长耗时任务，只要是用户点击按钮发起，也是用户触发
  
  - **判断规则二：时钟触发的特征**
    - 包含"定时"、"每日"、"每周"、"周期"、"自动执行"等时间关键词
    - 必须有明确的时间触发条件
    - 无需人工干预，系统按时间自动执行
  
  - **判断规则三：接口触发的特征**
    - 包含"接收推送"、"回调"、"Webhook"、"外部系统调用"等词汇
    - 由外部系统主动推送数据或事件驱动
  
  - **常见误判纠正**：
    - ❌ "批量处理任务是后台执行 → 时钟触发"
    - ✅ 如果是用户点击"批量处理"按钮发起 → 用户触发
    - ❌ "搭建集群是后台任务 → 时钟触发"
    - ✅ 用户点击"搭建"按钮发起 → 用户触发（虽然后台执行，但触发源是用户）

- **第四遍**：功能补全与验证
  - 检查CRUD操作完整性（标注触发方式）
  - 检查批量操作、导入导出功能（标注触发方式）
  - 检查查询、统计、报表功能（判断触发方式）
  - 检查审批、流程功能（标注触发方式）
  - **检查定时任务、自动化功能（时钟触发）**
  - **检查接口对接、消息接收功能（接口触发）**
  - **验证每个功能的触发方式是否正确标注**

#### 1.2 增强JSON输出格式
在文档理解阶段返回的JSON结构中，每个功能必须包含：
```json
{
  "functionName": "功能名称（动词+名词格式）",
  "triggerType": "用户触发/时钟触发/接口触发",
  "triggerDescription": "触发方式描述（如：用户点击按钮、每天凌晨3点、接收外部推送）",
  "scenario": "功能使用场景简述（谁在什么情况下使用该功能）"
}
```

增加触发方式统计：
```json
{
  "functionBreakdown": {
    "userTriggeredFunctions": "用户触发类功能数量",
    "timerTriggeredFunctions": "时钟触发类功能数量",
    "interfaceTriggeredFunctions": "接口触发类功能数量",
    ...
  }
}
```

增加定时任务明细：
```json
{
  "timedTasks": [
    {
      "taskName": "定时任务名称",
      "schedule": "执行频率（如：每天凌晨3点、每小时一次）",
      "description": "任务描述"
    }
  ]
}
```

#### 1.3 增强分析示例
在prompt中增加了6个详细示例，展示如何正确识别触发方式：

**示例1**：用户管理功能（都是用户触发）
- 创建、修改、删除、查询、详情、批量导入、导出等，全部标注为"用户触发"

**示例2**：审批流程功能（都是用户触发）
- 提交审批、审批通过、审批驳回、撤回审批、查询审批历史等，全部标注为"用户触发"

**示例3**：定时清理功能（时钟触发）
- "每天凌晨3点自动清理过期日志" → 时钟触发

**示例4**：告警推送功能（接口触发）
- "接收外部监控平台的告警推送" → 接口触发
- "自动创建告警工单" → 接口触发

**示例5**：批量加工功能（用户触发，不是时钟触发！）
- "用户选择数据后点击'批量加工'按钮，加工过程在后台异步执行" → 用户触发
- 虽然是后台异步执行，但触发源是用户点击按钮

**示例6**：数据同步功能（需判断）
- "手动同步数据" → 用户触发
- "定时同步数据" → 时钟触发

### 二、COSMIC拆分阶段优化

#### 2.1 利用文档理解结果
在进行COSMIC拆分时，将文档理解中识别的触发方式传递给AI：

```javascript
## 文档深度理解结果（含触发方式标注）：
- 项目名称：XXX
- 系统架构：XXX
- 触发方式分布：
  - 用户触发功能：80个
  - 时钟触发功能：5个
  - 接口触发功能：3个
- 核心模块及功能（含触发方式）：
  - 模块A: 
    · 创建任务 [用户触发] - 用户在需要创建新任务时点击按钮
    · 定时同步任务 [时钟触发] - 系统每小时自动同步任务状态
    · 接收任务推送 [接口触发] - 接收外部系统的任务推送
```

#### 2.2 明确填写规范
在拆分prompt中明确要求：

**触发方式填写规范（必须严格遵守）：**
- 用户触发 → 功能用户列填"用户触发"，触发事件列填"用户请求"
- 时钟触发 → 功能用户列填"时钟触发"，触发事件列填"定时任务"
- 接口触发 → 功能用户列填"接口触发"，触发事件列填"接口调用"

### 三、前端展示优化

#### 3.1 文档理解结果展示
在前端展示文档理解结果时，增加触发方式的可视化：

```markdown
## 📋 文档深度理解完成（含触发方式识别）

**系统架构**：前台交互系统 + 后台服务系统 + 定时任务系统

**触发方式分布**：
- 👤 用户触发：80个
- ⏰ 时钟触发：5个
- 🔌 接口触发：3个

### 🧩 识别到的核心模块

**1. 任务管理模块** (15个功能)
   功能列表：
      1. 👤 创建任务 [用户触发]
         场景：用户在需要创建新任务时点击"新增"按钮
      2. ⏰ 定时同步任务 [时钟触发]
         场景：系统每小时自动同步任务状态
      3. 🔌 接收任务推送 [接口触发]
         场景：接收外部系统的任务推送通知
```

#### 3.2 使用图标区分触发方式
- 👤 用户触发
- ⏰ 时钟触发
- 🔌 接口触发

### 四、系统提示词优化

#### 4.1 增强核心原则
在系统提示词的开头就强调触发方式的重要性：

```markdown
## 核心原则：深度理解文档后再拆分
**在开始拆分之前，你必须：**
1. 完整阅读文档
2. 识别业务实体
3. 理解业务流程
4. 区分功能类型
5. **识别触发方式**（新增）：仔细判断每个功能是用户主动触发、定时自动执行、还是外部接口推送
6. **理解功能场景**（新增）：每个功能在什么场景下使用，由谁发起，达到什么目的
```

#### 4.2 完善触发类型判断规则
在系统提示词中增加详细的判断规则和误区纠正：

**判断关键点**：
- **用户点击按钮发起** → 用户触发（即使是搭建集群、加工数据等耗时操作）
- **系统按时间自动执行** → 时钟触发（必须有明确的定时/周期关键词）
- **外部系统推送/回调** → 接口触发（接收推送、Webhook回调等）

**常见误区纠正**：
- ❌ "搭建集群是后台任务，所以是时钟触发" → ✅ 用户点击"搭建"按钮发起，是用户触发
- ❌ "加工数据需要很长时间，所以是时钟触发" → ✅ 用户点击"加工"按钮发起，是用户触发
- ❌ "批量处理是后台执行，所以是时钟触发" → ✅ 用户点击"批量处理"按钮发起，是用户触发
- ✅ "每日凌晨自动清理过期数据" → 系统按时间自动执行，是时钟触发
- ✅ "定时同步外部数据" → 系统按时间自动执行，是时钟触发

## 优化效果

### 1. 触发类型识别准确率提升
- **优化前**：AI容易将"后台执行"、"异步任务"等误判为时钟触发
- **优化后**：通过"四遍阅读法"和详细的判断规则，准确识别功能的触发源

### 2. 文档理解质量提升
- **优化前**：文档理解相对简单，只识别功能名称
- **优化后**：深度分析每个功能的触发方式、使用场景、业务上下文

### 3. 拆分结果质量提升
- **优化前**：触发类型列可能出现错误或不一致
- **优化后**：根据文档理解阶段的标注，准确填写"功能用户"和"触发事件"列

### 4. 用户体验提升
- **优化前**：用户需要手动修正触发类型
- **优化后**：AI自动识别并正确标注，减少人工干预

## 使用建议

1. **上传文档时**：尽量提供详细的功能描述，包括：
   - 功能的使用场景
   - 谁来使用该功能
   - 如何触发该功能（点击按钮、定时执行、接收推送等）

2. **查看文档理解结果**：
   - 仔细检查触发方式是否正确
   - 如果发现错误，可以在对话中纠正AI

3. **验证拆分结果**：
   - 检查"功能用户"和"触发事件"列是否符合实际
   - 用户触发的功能应该是"用户触发 + 用户请求"
   - 时钟触发的功能应该是"时钟触发 + 定时任务"
   - 接口触发的功能应该是"接口触发 + 接口调用"

## 技术实现细节

### 1. 文档理解API增强
- 路由：`POST /api/quality-analyze/understand`
- 增强了prompt，包含"四遍阅读法"和详细的触发方式判断规则
- 返回的JSON结构中每个功能都包含`triggerType`、`triggerDescription`、`scenario`字段

### 2. COSMIC拆分API优化
- 路由：`POST /api/quality-continue-analyze` 和 `POST /api/continue-analyze`
- 在拆分时传入文档理解结果（包含触发方式标注）
- AI根据文档理解结果准确填写"功能用户"和"触发事件"列

### 3. 前端展示优化
- 文件：`client/src/App.jsx`
- 在文档理解结果中展示触发方式分布统计
- 使用图标（👤⏰🔌）区分不同的触发方式
- 展示每个功能的触发方式和使用场景

## 后续优化方向

1. **增加触发方式的智能校验**：
   - 在解析表格时，检查触发方式是否合理
   - 例如：功能名称包含"定时"但触发类型是"用户触发"，给出警告

2. **增加触发方式的统计分析**：
   - 在最终结果中展示触发方式的分布图表
   - 帮助用户了解系统的交互模式

3. **支持复杂触发场景**：
   - 混合触发：既可以用户触发，也可以定时触发
   - 条件触发：满足特定条件时自动触发

4. **增加触发方式的最佳实践建议**：
   - 如果时钟触发功能过多，建议优化系统架构
   - 如果用户触发功能过于复杂，建议拆分成多个功能

## 总结

通过这次优化，Cosmic拆分智能体在以下方面有了显著提升：

1. **准确性**：触发类型识别准确率大幅提升
2. **全面性**：文档理解更加深入和全面
3. **智能性**：AI能够理解功能的业务场景和触发方式
4. **易用性**：前端展示更加直观，用户无需手动修正

这些优化使得智能体能够更准确地理解需求文档，生成高质量的COSMIC拆分结果，减少用户的手动修正工作，提升整体使用体验。




































