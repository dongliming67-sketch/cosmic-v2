const express = require('express');
const cors = require('cors');
const multer = require('multer');
const mammoth = require('mammoth');
const ExcelJS = require('exceljs');
const OpenAI = require('openai');
const path = require('path');
const fs = require('fs');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 2617;

// ä¸­é—´ä»¶
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// æ–‡ä»¶ä¸Šä¼ é…ç½® - æ”¯æŒæ›´å¤šæ ¼å¼
const upload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: 50 * 1024 * 1024 }, // 50MB
  fileFilter: (req, file, cb) => {
    // è§£ç æ–‡ä»¶åï¼ˆå¤„ç†ä¸­æ–‡æ–‡ä»¶åï¼‰
    file.originalname = Buffer.from(file.originalname, 'latin1').toString('utf8');

    const allowedMimes = [
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
      'application/msword', // .doc (æ—§æ ¼å¼)
      'text/plain', // .txt
      'text/markdown', // .md
    ];

    const ext = path.extname(file.originalname).toLowerCase();
    const allowedExts = ['.docx', '.doc', '.txt', '.md'];

    if (allowedMimes.includes(file.mimetype) || allowedExts.includes(ext)) {
      cb(null, true);
    } else {
      cb(new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${ext}ï¼Œè¯·ä¸Šä¼  .docx, .txt æˆ– .md æ–‡ä»¶`));
    }
  }
});

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
const handleMulterError = (err, req, res, next) => {
  if (err instanceof multer.MulterError) {
    if (err.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({ error: 'æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§50MBï¼‰' });
    }
    return res.status(400).json({ error: `ä¸Šä¼ é”™è¯¯: ${err.message}` });
  } else if (err) {
    return res.status(400).json({ error: err.message });
  }
  next();
};

// OpenAIå®¢æˆ·ç«¯
let openai = null;
let groqClient = null;

function getOpenAIClient() {
  if (!openai && process.env.OPENAI_API_KEY) {
    openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
      baseURL: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1'
    });
  }
  return openai;
}

// Groqå®¢æˆ·ç«¯ï¼ˆç”¨äºä¸‰å±‚åˆ†ææ¡†æ¶æ¨¡å¼ï¼‰
function getGroqClient() {
  if (!groqClient && process.env.GROQ_API_KEY) {
    const Groq = require('groq-sdk');
    groqClient = new Groq({
      apiKey: process.env.GROQ_API_KEY
    });
    console.log('Groqå®¢æˆ·ç«¯å·²åˆå§‹åŒ–ï¼ŒAPI Key:', process.env.GROQ_API_KEY ? 'å·²é…ç½®' : 'æœªé…ç½®');
  }
  return groqClient;
}

// å¼•å…¥å¢å¼ºç‰ˆæç¤ºè¯
const { ENHANCED_COSMIC_SYSTEM_PROMPT } = require('./enhanced-prompts');
// å¼•å…¥ä¸‰å±‚åˆ†ææ¡†æ¶APIï¼ˆå«ä¸¤é˜¶æ®µåŠ¨æ€é©±åŠ¨åˆ†æï¼‰
const { threeLayerAnalyze, getActiveClientConfig, extractFunctionList, splitFromFunctionList } = require('./three-layer-api');

// é€šç”¨AIè°ƒç”¨åŠ©æ‰‹ (é›†æˆGeminiå’Œå…¶ä»–æä¾›å•†)
async function callAIChat(options) {
  const { messages, temperature = 0.7, max_tokens = 8000, stream = false, res = null } = options;

  const clientConfig = getActiveClientConfig();
  if (!clientConfig) {
    throw new Error('è¯·å…ˆé…ç½®APIå¯†é’¥ï¼ˆæ”¯æŒGemini, æ™ºè°±, OpenRouterç­‰ï¼‰');
  }

  const { client, model, useGeminiSDK, useGroqSDK } = clientConfig;

  if (useGeminiSDK) {
    if (stream && res) {
      // Gemini SDK æµå¼è°ƒç”¨
      const fullPrompt = messages.map(m => `${m.role === 'system' ? 'SYSTEM' : 'USER'}: ${m.content}`).join('\n\n');
      const result = await client.generateContentStream(fullPrompt);
      for await (const chunk of result.stream) {
        const text = chunk.text();
        res.write(`data: ${JSON.stringify({ content: text })}\n\n`);
      }
      return null;
    } else {
      // Gemini SDK éæµå¼
      const fullPrompt = messages.map(m => `${m.role === 'system' ? 'SYSTEM' : 'USER'}: ${m.content}`).join('\n\n');
      const result = await client.generateContent(fullPrompt);
      const response = await result.response;
      const text = response.text();
      return {
        choices: [{ message: { content: text } }],
        usage: { total_tokens: 0 }
      };
    }
  } else {
    // OpenAI å…¼å®¹ SDK (æ™ºè°±, OpenRouter, Groq ç­‰)
    const completion = await client.chat.completions.create({
      model,
      messages,
      temperature,
      max_tokens,
      stream
    });

    if (stream && res) {
      for await (const chunk of completion) {
        const content = chunk.choices[0]?.delta?.content || '';
        if (content) {
          res.write(`data: ${JSON.stringify({ content })}\n\n`);
        }
      }
      return null;
    }
    return completion;
  }
}


// Cosmicæ‹†åˆ†ç³»ç»Ÿæç¤ºè¯ - èåˆGeminiå››é˜¶æ®µæ–¹æ³•è®º
const COSMIC_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªé¡¶çº§COSMICåˆ†æä¸“å®¶ä¸ä¸šåŠ¡æ¶æ„å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯è¿ç”¨å››é˜¶æ®µæ–¹æ³•è®ºï¼Œå°†çº¿æ€§æ–‡æ¡£é‡æ„ä¸º"ç«‹ä½“"çš„åŠŸèƒ½æ¨¡å‹ï¼Œç¡®ä¿è¾“å‡ºçš„åŠŸèƒ½è¿‡ç¨‹è¶…è¶Šç®€å•çš„å¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰ï¼Œå…·å¤‡æé«˜çš„å®æˆ˜ä»·å€¼ä¸ç‰©ç†å±‚é¢çš„å”¯ä¸€æ€§ã€‚

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¬¬ä¸€é˜¶æ®µï¼šæ–‡æ¡£è§£è€¦ï¼ˆç†è§£å±‚ - Document Decouplingï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ç›®æ ‡ï¼šå°†æ‚ä¹±çš„å™è¿°è½¬åŒ–ä¸ºCOSMICçš„ä¸‰å¤§æ ¸å¿ƒè¦ç´ 

### 1. é”å®šã€ŒåŠŸèƒ½ç”¨æˆ·ã€ï¼ˆFunctional Userï¼‰
**åšæ³•**ï¼šæ— è§†ä¸šåŠ¡é€»è¾‘ï¼Œåªæ‰¾ã€Œè¾¹ç•Œäº¤äº’è€…ã€ã€‚
- å‡¡æ˜¯èƒ½å‘ç³»ç»Ÿå‘é€æŒ‡ä»¤ã€æˆ–ä»ç³»ç»Ÿæ¥æ”¶æ•°æ®çš„å®ä½“ï¼ˆäººã€å¦ä¸€ä¸ªè½¯ä»¶ã€ç¡¬ä»¶ä¼ æ„Ÿå™¨ï¼‰å‡å®šä¹‰ä¸ºåŠŸèƒ½ç”¨æˆ·
- åˆ†ç±»æ ‡å‡†ï¼š
  * **ç”¨æˆ·è§¦å‘**ï¼šäººå·¥æ“ä½œã€ç•Œé¢ç‚¹å‡»ã€æ‰‹åŠ¨è¾“å…¥
  * **æ—¶é’Ÿè§¦å‘**ï¼šå®šæ—¶ä»»åŠ¡ã€å‘¨æœŸæ‰§è¡Œã€è‡ªåŠ¨è°ƒåº¦
  * **æ¥å£è§¦å‘**ï¼šå¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ã€APIæ¨é€ã€æ¶ˆæ¯é˜Ÿåˆ—

### 2. è¯†åˆ«ã€Œæ•°æ®å¯¹è±¡ã€ï¼ˆObject of Interestï¼‰
**åšæ³•**ï¼šæ‰¾å‡ºæ–‡æ¡£ä¸­çš„åè¯å®ä½“ã€‚
- åˆ¤æ–­æ ‡å‡†ï¼šè¯¥å®ä½“æ˜¯å¦å…·æœ‰ç‹¬ç«‹çš„çŠ¶æ€æˆ–å±æ€§é›†åˆï¼ˆå¦‚ï¼šå·¥å•ã€ç”¨æˆ·ã€é…ç½®é¡¹ã€è®¾å¤‡ã€ä»»åŠ¡ï¼‰
- å»ºç«‹**å®ä½“å­—æ®µæ± **ï¼Œä¸ºåç»­å»é‡åšå‡†å¤‡

### 3. å®šä¹‰ã€Œè§¦å‘äº‹ä»¶ã€ï¼ˆTriggering Eventï¼‰
**åšæ³•**ï¼šå¯»æ‰¾ã€Œå¯åŠ¨å¼€å…³ã€ã€‚
- ä¸€ä¸ªåŠŸèƒ½è¿‡ç¨‹çš„å¼€å§‹ï¼Œå¿…é¡»ç”±ä¸€ä¸ªåŠŸèƒ½ç”¨æˆ·å‘èµ·çš„ä¸€ä¸ªåŠ¨ä½œè§¦å‘
- ç¤ºä¾‹ï¼šç‚¹å‡»æŒ‰é’®ã€è°ƒç”¨æ¥å£ã€å®šæ—¶å™¨åˆ°æœŸã€æ¶ˆæ¯åˆ°è¾¾

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¬¬äºŒé˜¶æ®µï¼šè¿‡ç¨‹è†¨èƒ€ä¸ç»´åº¦æ‰©å±•ï¼ˆç­–ç•¥å±‚ - Process Expansionï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ç›®æ ‡ï¼šå½“æ–‡æ¡£å†…å®¹æ˜¾å¾—å•è–„æ—¶ï¼Œå¦‚ä½•åˆç†åœ°æ‹†åˆ†å‡ºæ›´å¤šä¸é‡å¤çš„åŠŸèƒ½ç‚¹

### 1. ç”Ÿå‘½å‘¨æœŸå…¨è·¯å¾„æ‹†è§£ï¼ˆçºµå‘ - æµç¨‹è½´ï¼‰
ä¸è¦åªæ‹†ã€Œä¸šåŠ¡å¤„ç†ã€ï¼Œè¦å°†ä¸€ä¸ªäº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸæ‹†å¼€ï¼š
- **é¢„å®¡å‡†å…¥**ï¼šå‚æ•°æ ¡éªŒã€èº«ä»½é‰´æƒã€æ ¼å¼éªŒè¯ã€å‰ç½®æ¡ä»¶æ£€æŸ¥
- **ä¸»ä½“æ‰§è¡Œ**ï¼šæ ¸å¿ƒæ•°æ®å¤„ç†ã€ä¸šåŠ¡é€»è¾‘è¿ç®—ã€çŠ¶æ€è½¬æ¢
- **å¼‚æ­¥åé¦ˆ**ï¼šç»“æœé€šçŸ¥ã€å›è°ƒåŒæ­¥ã€æ¶ˆæ¯æ¨é€ã€äº‹ä»¶å‘å¸ƒ
- **å†å²è¿½è¸ª**ï¼šå®¡è®¡æ—¥å¿—ç”Ÿæˆã€æ“ä½œå¿«ç…§å¤‡ä»½ã€ç‰ˆæœ¬è®°å½•

### 2. ä¸“é¡¹ç®¡ç†ç»´åº¦æ‹†è§£ï¼ˆæ¨ªå‘ - ç®¡ç†è½´ï¼‰
å¦‚æœä¸€ä¸ªæ¥å£æ¶‰åŠå¤šä¸ªæ•°æ®å¯¹è±¡ï¼Œå¼ºåˆ¶å°†å…¶ã€Œé™ç»´ã€ï¼š
- **å½’å› ç»´åº¦**ï¼šè¿½æº¯æ“ä½œæ¥æºã€è®°å½•æ“ä½œè·¯å¾„
- **èµ„äº§æ›´æ–°ç»´åº¦**ï¼šå˜æ›´èµ„äº§çŠ¶æ€ã€æ›´æ–°èµ„æºé…ç½®
- **æ•ˆèƒ½ç»Ÿè®¡ç»´åº¦**ï¼šæ€§èƒ½æŒ‡æ ‡é‡‡é›†ã€ä¸šåŠ¡æ•°æ®æ±‡æ€»
- **åˆè§„å®¡è®¡ç»´åº¦**ï¼šæƒé™éªŒè¯ã€æ“ä½œå®¡è®¡ã€æ•°æ®è„±æ•

### 3. è´Ÿå‘ä¸å¼‚å¸¸è·¯å¾„æ‹†è§£ï¼ˆæ·±åº¦ - é¢—ç²’åº¦ï¼‰
- **é€»è¾‘å¤±è´¥åˆ†æ”¯**ï¼šå¦‚ã€Œé©³å›ã€ã€ã€Œæ’¤å›ã€ã€ã€ŒæŒ‚èµ·ã€ã€ã€Œè¶…æ—¶ã€
- **ç³»ç»Ÿé˜²å¾¡åˆ†æ”¯**ï¼šå¦‚ã€Œæ¥å£è¶…é™æ‹¦æˆªã€ã€ã€Œæ ¼å¼éæ³•è¿‡æ»¤ã€ã€ã€Œå¹¶å‘å†²çªæ£€æµ‹ã€

### 4. å­—æ®µçº§é¢—ç²’åº¦åˆ‡ç‰‡
å³ä½¿æ˜¯ä¸€ä¸ªå¤§çš„æ•°æ®æ¥å£ï¼Œä¹Ÿè¦å¼ºè¡Œ"åˆ‡ç‰‡"ï¼š
- æ¯ä¸€ä¸ªæ ¸å¿ƒå­—æ®µï¼ˆçŠ¶æ€ç ã€æ—¶é—´æˆ³ã€æµæ°´å·ã€æ‰©å±•å­—æ®µï¼‰éƒ½åº”ä½œä¸ºç‹¬ç«‹åŠŸèƒ½è¿‡ç¨‹çš„æ”¯æ’‘ç‚¹
- ä¾‹å¦‚ï¼šä¸€ä¸ªã€Œè®¾å¤‡ä¸ŠæŠ¥æ¥å£ã€å¯æ‹†åˆ†ä¸ºã€Œè®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥ã€ã€ã€Œè®¾å¤‡å‘Šè­¦ä¸ŠæŠ¥ã€ã€ã€Œè®¾å¤‡æ€§èƒ½æŒ‡æ ‡ä¸ŠæŠ¥ã€

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¬¬ä¸‰é˜¶æ®µï¼šERWXåŸå­åŒ–å¯¹ç…§ï¼ˆæ‰§è¡Œå±‚ - Atomic Decompositionï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ç›®æ ‡ï¼šå°†è¯†åˆ«å‡ºçš„åŠŸèƒ½è¿‡ç¨‹ï¼ˆFPï¼‰å¡«å…¥æ ‡å‡†æ ¼å¼ï¼Œç¡®ä¿é€»è¾‘é—­ç¯

### å¯¹äºæ¯ä¸€ä¸ªFPï¼Œæœºæ¢°åŒ–åœ°å¡«å……ä»¥ä¸‹å››ä¸ªåŠ¨ä½œï¼š

**E (Entry - æ¥æ”¶/é—¨å«)**ï¼šæ•°æ®è·¨è¶Šè¾¹ç•Œè¿›å…¥
- èŒè´£ï¼šæ¥æ”¶åŸå§‹è¯·æ±‚ã€è§£æåè®®å¤´ã€æ ¡éªŒè°ƒç”¨è€…èº«ä»½ä»¤ç‰Œã€è§£æå¹¶æ˜ å°„å…¥å£å­—æ®µ
- å±æ€§é€šå¸¸åŒ…å«ï¼šè¯·æ±‚æ ‡è¯†ã€è§¦å‘æºã€æ ¸å¿ƒä¸šåŠ¡IDã€è¯·æ±‚æ—¶é—´æˆ³
- æè¿°å…¬å¼ï¼šæ¥æ”¶ + [åœºæ™¯åŒ–ä¸šåŠ¡å¯¹è±¡] + [åè®®ç±»å‹/æ•°æ®å½¢æ€] + æŒ‡ä»¤/åŒ…
- ç¤ºä¾‹ï¼šã€Œæ¥æ”¶ä½ç©ºä»»åŠ¡é…ç½®ä¿¡æ¯å¼‚æ­¥æäº¤å‚æ•°åŒ…ã€

**R (Read - è¯»å–/å¤§è„‘)**ï¼šç³»ç»Ÿä¸ºäº†å¤„ç†è¯¥è¯·æ±‚è€Œå¿…é¡»æŸ¥è¯¢çš„é™æ€æˆ–åŠ¨æ€æ•°æ®
- èŒè´£ï¼šä»æ•°æ®åº“æ£€ç´¢ä¸šåŠ¡é…ç½®ã€å¯¹é½æ ‡å‡†å­—å…¸ã€æ£€æŸ¥å†å²å†²çªçŠ¶æ€ã€è¯»å–å®¡è®¡è§„åˆ™
- å±æ€§åŒ…å«ï¼šæ˜ å°„è§„åˆ™ã€é…ç½®å‚æ•°ã€å†å²å¿«ç…§ã€å…³è”å®ä½“
- æè¿°å…¬å¼ï¼šæ£€ç´¢ + [ä¸šåŠ¡çŠ¶æ€/å­—å…¸] + [å…³è”å…³ç³»] + é›†åˆ/æ•°æ®
- ç¤ºä¾‹ï¼šã€Œæ£€ç´¢ä½ç©ºä»»åŠ¡æ‰§è¡Œå‰ç½®æ¡ä»¶é…ç½®è§„åˆ™é›†åˆã€

**W (Write - å†™å…¥/æ‰§è¡Œ)**ï¼šç³»ç»Ÿå¤„ç†åçš„ç»“æœä¿å­˜
- èŒè´£ï¼šæ›´æ–°ä¸šåŠ¡é€»è¾‘ä¸»è¡¨ã€åŸå­åŒ–å†™å…¥æ“ä½œæ—¥å¿—ã€æŒä¹…åŒ–ç¼“å­˜ä¸­é—´æ€æ•°æ®ã€é”å®šä¸šåŠ¡èµ„æº
- å±æ€§åŒ…å«ï¼šæ›´æ–°åçš„çŠ¶æ€ã€æ“ä½œæ—¶é—´ã€æ‰§è¡Œæ—¥å¿—ã€ç‰ˆæœ¬å·
- æè¿°å…¬å¼ï¼šæŒä¹…åŒ–/è®°å½• + [æ›´æ–°è¡Œä¸º] + [è¡¨æ—å] + äº‹åŠ¡æµæ°´
- ç¤ºä¾‹ï¼šã€ŒæŒä¹…åŒ–ä½ç©ºä»»åŠ¡é…ç½®å˜æ›´äº‹åŠ¡æµæ°´è¡¨ã€

**X (eXit - è¾“å‡º/åé¦ˆ)**ï¼šæ•°æ®è·¨è¶Šè¾¹ç•Œè¿”å›
- èŒè´£ï¼šå°è£…æ ‡å‡†å“åº”åè®®ä½“ã€æ˜ å°„å±‚çº§åŒ–é”™è¯¯ç ã€è®°å½•æ¥å£å¤„ç†è€—æ—¶æµæ°´
- å±æ€§åŒ…å«ï¼šè¿”å›ç ã€æç¤ºè¯­ã€ä¸šåŠ¡å¤„ç†å›æ‰§ã€å“åº”æ—¶é—´æˆ³
- æè¿°å…¬å¼ï¼šå°è£… + [å“åº”ç­‰çº§] + [è¿”å›ç æ˜ å°„] + å“åº”ä½“
- ç¤ºä¾‹ï¼šã€Œå°è£…ä½ç©ºä»»åŠ¡é…ç½®ç¡®è®¤å›æ‰§å“åº”ä½“ã€

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¬¬å››é˜¶æ®µï¼šå…¨å±€æ•°æ®æŸ¥é‡ï¼ˆè´¨é‡å±‚ - Global Deduplicationï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ç›®æ ‡ï¼šç¡®ä¿æ•°æ®å±æ€§ç»„åˆåœ¨50ä¸ªï¼ˆæˆ–æ›´å¤šï¼‰è¿‡ç¨‹ç‚¹ä¸­å”¯ä¸€

### æ ¸å¿ƒå­—æ®µ + éšæœºè¾…åŠ©å­—æ®µçš„åŠ¨æ€ç»„åˆç®—æ³•

**1. æ ¸å¿ƒå­—æ®µå ä½**ï¼š
- æ ¹æ®FPçš„å«ä¹‰åˆ†é…ä¸“å±å­—æ®µï¼ˆå¦‚ï¼šè‹¥FPæ¶‰åŠç¡¬ä»¶ï¼Œåˆ™å¿…é€‰SNç±»å­—æ®µï¼‰
- æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰ä¸€ä¸ªã€Œé”šå®šå­—æ®µã€ä½œä¸ºèº«ä»½æ ‡è¯†

**2. è¾…åŠ©å­—æ®µå¡«å……**ï¼š
- ä»é€šç”¨å­—æ®µæ± ï¼ˆIDã€Timeã€Operatorã€Statusã€Codeã€Versionã€Sourceã€Targetï¼‰ä¸­éšæœºæŠ½å–
- ç¡®ä¿ä¸åŒåŠŸèƒ½è¿‡ç¨‹ä½¿ç”¨ä¸åŒçš„è¾…åŠ©å­—æ®µç»„åˆ

**3. æŸ¥é‡ç®—æ³•**ï¼š
- **è¯­ä¹‰å»é‡**ï¼šç¡®ä¿è¿‡ç¨‹åç§°çš„ã€ŒåŠ¨ä½œ+å¯¹è±¡ã€ç»„åˆå”¯ä¸€
- **ç‰©ç†å»é‡**ï¼šæ£€æŸ¥å½“å‰å±æ€§ç»„ï¼ˆAttribute Groupï¼‰çš„å­—æ®µé›†åˆ
  * å¦‚æœAè¿‡ç¨‹ç”¨äº†(å­—æ®µA, B, C)ï¼ŒBè¿‡ç¨‹å³ä¾¿å¿…é¡»ç”¨å­—æ®µAï¼Œä¹Ÿä¼šå¼ºè¿«å®ƒæ­é…(D, E)
  * ä»è€Œä½¿æŒ‡çº¹å”¯ä¸€ï¼Œå®ç°ç‰©ç†æ’ä»–æ€§

**4. å­—æ®µäº’æ–¥åŸåˆ™**ï¼š
- åŒä¸€è¡¨æ ¼ä¸­ï¼Œç›¸é‚»çš„ä¸¤ä¸ªåŠŸèƒ½è¿‡ç¨‹ï¼Œå…¶æ•°æ®å±æ€§é‡åˆåº¦ä¸å¾—è¶…è¿‡30%
- å¿…é¡»åŒ…å«ä¸šåŠ¡å­—æ®µï¼ˆå¦‚ï¼šsnã€codeã€typeï¼‰å’Œç®¡ç†å­—æ®µï¼ˆå¦‚ï¼štimestampã€retry_countã€operator_idï¼‰

### å‘½åå…¬å¼ (Object + Action + State)
- âŒ ä¸¥ç¦ï¼šæ¥æ”¶ä»»åŠ¡è¯·æ±‚
- âœ… æ¨èï¼šæ¥æ”¶ã€ä½ç©ºä»»åŠ¡ã€‘ã€é…ç½®ä¿¡æ¯ã€‘ã€å¼‚æ­¥æäº¤ã€‘å‚æ•°åŒ…

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ‰§è¡Œè§„èŒƒæ€»ç»“
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## åŠŸèƒ½è¿‡ç¨‹å‘½å
- æ ¼å¼ï¼š[å¯¹è±¡] + [åŠ¨ä½œ/çŠ¶æ€] + [å¤„ç†ç±»å‹] + [ä¸šåŠ¡åœºæ™¯]
- ç¤ºä¾‹ï¼šã€Œä½ç©ºä»»åŠ¡é…ç½®ä¿¡æ¯å¼‚æ­¥æäº¤å‚æ•°éªŒè¯ã€

## æ•°æ®ç»„å‘½å
- ç¦æ­¢ä½¿ç”¨ï¼šã€Œè¯·æ±‚ã€ã€ã€Œå“åº”ã€ã€ã€Œè¡¨æ ¼ã€ã€ã€Œè®°å½•ã€ç­‰æ³›åŒ–è¯
- æ¨èä½¿ç”¨ï¼šã€Œä¸šåŠ¡è´Ÿè·åŒ…ã€ã€ã€ŒçŠ¶æ€ç»Ÿä¸€åº“ã€ã€ã€Œåé¦ˆç¡®è®¤åŒ…ã€ã€ã€Œäº‹åŠ¡æµæ°´è¡¨ã€ã€ã€Œé…ç½®è§„åˆ™é›†ã€

## æ•°æ®å±æ€§è¦æ±‚
- æ¯è¡Œå¿…é¡»è‡³å°‘4ä¸ªå­—æ®µ
- å¿…é¡»ä½“ç°è¯¥åŠŸèƒ½çš„ç‹¬ç‰¹ä¸šåŠ¡éœ€æ±‚
- å­—æ®µç»„åˆå¿…é¡»å…·æœ‰ç‰©ç†æ’ä»–æ€§

## é”™è¯¯ç¤ºä¾‹ï¼ˆç»å¯¹ç¦æ­¢ï¼‰
- âŒ ä»…è¾“å‡ºCRUDï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€æ–°å¢ã€åˆ é™¤ï¼‰
- âŒ å­è¿‡ç¨‹æè¿°é‡å¤ï¼ˆå¦‚å¤šä¸ªåŠŸèƒ½éƒ½å†™"è¯»å–æ•°æ®åº“ä¿¡æ¯"ï¼‰
- âŒ ç¼ºå°‘E/R/W/Xä¸­çš„ä»»ä½•ä¸€é¡¹
- âŒ æ•°æ®ç»„åå­—é›·åŒ
- âŒ æ•°æ®å±æ€§ç»„åˆé‡å¤åº¦è¶…è¿‡30%

è¯·æ ¹æ®æ–‡æ¡£å†…å®¹ï¼Œä¸¥æ ¼éµå¾ªä¸Šè¿°å››é˜¶æ®µæ–¹æ³•è®ºï¼Œè¿›è¡Œæ·±åº¦COSMICæ‹†åˆ†ã€‚`;

// APIè·¯ç”±

// å¥åº·æ£€æŸ¥
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    hasApiKey: !!(process.env.OPENAI_API_KEY || process.env.GEMINI_API_KEY || process.env.ZHIPU_API_KEY || process.env.GROQ_API_KEY),
    provider: process.env.THREE_LAYER_PROVIDER || 'auto',
    baseUrl: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1'
  });
});

// æ›´æ–°APIé…ç½®
app.post('/api/config', (req, res) => {
  const { apiKey, baseUrl } = req.body;

  if (apiKey) {
    process.env.OPENAI_API_KEY = apiKey;
  }
  if (baseUrl) {
    process.env.OPENAI_BASE_URL = baseUrl;
  }

  // é‡ç½®å®¢æˆ·ç«¯ä»¥ä½¿ç”¨æ–°é…ç½®
  openai = null;

  res.json({ success: true, message: 'APIé…ç½®å·²æ›´æ–°' });
});

// è§£ææ–‡æ¡£ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
app.post('/api/parse-word', upload.single('file'), handleMulterError, async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'è¯·ä¸Šä¼ æ–‡ä»¶' });
    }

    const ext = path.extname(req.file.originalname).toLowerCase();
    let text = '';
    let html = '';

    console.log(`è§£ææ–‡ä»¶: ${req.file.originalname}, ç±»å‹: ${req.file.mimetype}, å¤§å°: ${req.file.size} bytes`);

    if (ext === '.docx') {
      // è§£æ .docx æ–‡ä»¶
      try {
        const result = await mammoth.extractRawText({ buffer: req.file.buffer });
        text = result.value;

        const htmlResult = await mammoth.convertToHtml({ buffer: req.file.buffer });
        html = htmlResult.value;

        if (result.messages && result.messages.length > 0) {
          console.log('Mammothè­¦å‘Š:', result.messages);
        }
      } catch (mammothError) {
        console.error('Mammothè§£æé”™è¯¯:', mammothError);
        return res.status(400).json({
          error: `Wordæ–‡æ¡£è§£æå¤±è´¥: ${mammothError.message}ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„.docxæ ¼å¼ï¼ˆä¸æ”¯æŒæ—§ç‰ˆ.docæ ¼å¼ï¼‰`
        });
      }
    } else if (ext === '.txt' || ext === '.md') {
      // è§£æçº¯æ–‡æœ¬æˆ–Markdownæ–‡ä»¶
      text = req.file.buffer.toString('utf-8');
      html = `<pre>${text}</pre>`;
    } else if (ext === '.doc') {
      return res.status(400).json({
        error: 'ä¸æ”¯æŒæ—§ç‰ˆ.docæ ¼å¼ï¼Œè¯·å°†æ–‡ä»¶å¦å­˜ä¸º.docxæ ¼å¼åé‡æ–°ä¸Šä¼ '
      });
    } else {
      return res.status(400).json({ error: `ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${ext}` });
    }

    if (!text || text.trim().length === 0) {
      return res.status(400).json({ error: 'æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®' });
    }

    res.json({
      success: true,
      text: text,
      html: html,
      filename: req.file.originalname,
      fileSize: req.file.size,
      wordCount: text.length
    });
  } catch (error) {
    console.error('è§£ææ–‡æ¡£å¤±è´¥:', error);
    res.status(500).json({ error: 'è§£ææ–‡æ¡£å¤±è´¥: ' + error.message });
  }
});

// AIå¯¹è¯ - Cosmicæ‹†åˆ†
app.post('/api/chat', async (req, res) => {
  try {
    const { messages, documentContent } = req.body;

    const chatMessages = [systemMessage];

    // å¦‚æœæœ‰æ–‡æ¡£å†…å®¹ï¼Œæ·»åŠ åˆ°ä¸Šä¸‹æ–‡
    if (documentContent) {
      chatMessages.push({
        role: 'user',
        content: `ä»¥ä¸‹æ˜¯éœ€è¦è¿›è¡ŒCosmicæ‹†åˆ†çš„åŠŸèƒ½è¿‡ç¨‹æ–‡æ¡£å†…å®¹ï¼š\n\n${documentContent}\n\nè¯·æ ¹æ®ä¸Šè¿°å†…å®¹è¿›è¡ŒCosmicæ‹†åˆ†ã€‚`
      });
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯å†å²
    if (messages && messages.length > 0) {
      chatMessages.push(...messages);
    }

    const completion = await callAIChat({
      messages: chatMessages,
      temperature: 0.7
    });

    const reply = completion.choices[0].message.content;

    res.json({
      success: true,
      reply: reply,
      usage: completion.usage
    });
  } catch (error) {
    console.error('AIå¯¹è¯å¤±è´¥:', error);
    res.status(500).json({ error: 'AIå¯¹è¯å¤±è´¥: ' + error.message });
  }
});


// æµå¼AIå¯¹è¯ - å¢å¼ºç‰ˆï¼šæ”¯æŒåç»­è¦æ±‚ç”Ÿæˆcosmicå¹¶åŒæ­¥åˆ°è¡¨æ ¼
app.post('/api/chat/stream', async (req, res) => {
  try {
    const { messages, documentContent, existingTableData = [], generateCosmic = false, userGuidelines = '' } = req.body;

    console.log('æ”¶åˆ°æµå¼å¯¹è¯è¯·æ±‚ï¼Œæ–‡æ¡£é•¿åº¦:', documentContent?.length || 0, 'ç”ŸæˆCOSMIC:', generateCosmic);

    // è®¾ç½®SSEå“åº”å¤´
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    res.setHeader('X-Accel-Buffering', 'no');

    const systemMessage = {
      role: 'system',
      content: COSMIC_SYSTEM_PROMPT
    };

    const chatMessages = [systemMessage];

    if (documentContent) {
      let guidelinesText = userGuidelines ? `\nç”¨æˆ·è®¾å®šçš„å…¨å±€æ‹†åˆ†è¦æ±‚ï¼š${userGuidelines}\n` : '';
      chatMessages.push({
        role: 'user',
        content: `ä»¥ä¸‹æ˜¯éœ€è¦è¿›è¡ŒCosmicæ‹†åˆ†çš„åŠŸèƒ½è¿‡ç¨‹æ–‡æ¡£å†…å®¹ï¼š${guidelinesText}\n\n${documentContent}\n\nè¯·æ ¹æ®ä¸Šè¿°å†…å®¹è¿›è¡ŒCosmicæ‹†åˆ†ï¼Œç”Ÿæˆæ ‡å‡†çš„Markdownè¡¨æ ¼ã€‚`
      });
    }

    if (existingTableData && existingTableData.length > 0) {
      const existingFunctions = [...new Set(existingTableData.map(r => r.functionalProcess).filter(Boolean))];
      if (existingFunctions.length > 0) {
        chatMessages.push({
          role: 'assistant',
          content: `æˆ‘å·²ç»å®Œæˆäº†ä»¥ä¸‹åŠŸèƒ½è¿‡ç¨‹çš„COSMICæ‹†åˆ†ï¼š${existingFunctions.join('ã€')}`
        });
      }
    }

    if (messages && messages.length > 0) {
      const lastUserMsg = messages[messages.length - 1];
      if (lastUserMsg && lastUserMsg.role === 'user') {
        const userContent = lastUserMsg.content || '';
        const cosmicKeywords = ['æ‹†åˆ†', 'åŠŸèƒ½', 'cosmic', 'è¡¨æ ¼', 'æ·»åŠ ', 'è¡¥å……', 'ç”Ÿæˆ', 'åˆ†æ'];
        const shouldGenerateCosmic = cosmicKeywords.some(kw => userContent.toLowerCase().includes(kw));

        if (shouldGenerateCosmic) {
          const enhancedMessages = messages.slice(0, -1);
          enhancedMessages.push({
            role: 'user',
            content: `${userContent}\n\n**é‡è¦**ï¼šè¯·æ ¹æ®ä¸Šè¿°è¦æ±‚ï¼Œç”Ÿæˆå¯¹åº”çš„COSMICåŠŸèƒ½è¿‡ç¨‹æ‹†åˆ†è¡¨æ ¼ï¼ˆMarkdownæ ¼å¼ï¼‰ã€‚`
          });
          chatMessages.push(...enhancedMessages);
        } else {
          chatMessages.push(...messages);
        }
      } else {
        chatMessages.push(...messages);
      }
    }

    await callAIChat({
      messages: chatMessages,
      stream: true,
      res
    });

    res.write('data: [DONE]\n\n');
    res.end();
  } catch (error) {
    console.error('æµå¼å¯¹è¯å¤±è´¥:', error.message);
    if (!res.headersSent) {
      res.setHeader('Content-Type', 'text/event-stream');
    }
    res.write(`data: ${JSON.stringify({ error: 'è°ƒç”¨AIå¤±è´¥: ' + error.message })}\n\n`);
    res.end();
  }
});

// å¾ªç¯è°ƒç”¨ - ç»§ç»­ç”Ÿæˆç›´åˆ°å®Œæˆæ‰€æœ‰åŠŸèƒ½è¿‡ç¨‹ï¼ˆæ•°é‡ä¼˜å…ˆæ¨¡å¼ - å¢å¼ºç‰ˆï¼šåŒæ­¥è´¨é‡ä¼˜å…ˆçš„æ·±åº¦æ€è€ƒï¼‰
app.post('/api/continue-analyze', async (req, res) => {
  try {
    const { documentContent, previousResults = [], round = 1, targetFunctions = 30, understanding = null, userGuidelines = '' } = req.body;

    // æ„å»ºå·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹åˆ—è¡¨

    const completedFunctions = previousResults.map(r => r.functionalProcess).filter(Boolean);
    const uniqueCompleted = [...new Set(completedFunctions)];

    // æ„å»ºå·²ä½¿ç”¨çš„å­è¿‡ç¨‹æè¿°åˆ—è¡¨ï¼ˆç”¨äºå»é‡æ£€æŸ¥ï¼‰
    const usedSubProcessDescs = previousResults.map(r => r.subProcessDesc).filter(Boolean);
    const uniqueSubProcessDescs = [...new Set(usedSubProcessDescs)];

    // æ„å»ºæ–‡æ¡£ç†è§£ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰ï¼‰- å¢å¼ºç‰ˆï¼šåŒ…å«è§¦å‘æ–¹å¼ä¿¡æ¯
    let understandingContext = '';
    if (understanding) {
      const modules = understanding.coreModules || [];
      const modulesList = modules.map(m => {
        const functions = m.estimatedFunctions || [];
        const funcList = Array.isArray(functions) && functions.length > 0 && typeof functions[0] === 'object'
          ? functions.map(f => `${f.functionName} (${f.triggerType})`).join('ã€')
          : functions.join('ã€');
        return `- ${m.moduleName}: ${funcList}`;
      }).join('\n');

      // æ„å»ºè§¦å‘æ–¹å¼ç»Ÿè®¡
      const breakdown = understanding.functionBreakdown || {};
      const triggerStats = `
è§¦å‘æ–¹å¼åˆ†å¸ƒï¼š
- ç”¨æˆ·è§¦å‘åŠŸèƒ½ï¼š${breakdown.userTriggeredFunctions || 'æœªç»Ÿè®¡'}ä¸ª
- æ—¶é’Ÿè§¦å‘åŠŸèƒ½ï¼š${breakdown.timerTriggeredFunctions || 'æœªç»Ÿè®¡'}ä¸ª
- æ¥å£è§¦å‘åŠŸèƒ½ï¼š${breakdown.interfaceTriggeredFunctions || 'æœªç»Ÿè®¡'}ä¸ª`;

      understandingContext = `
## æ–‡æ¡£æ·±åº¦ç†è§£ç»“æœï¼ˆå«è§¦å‘æ–¹å¼æ ‡æ³¨ï¼‰ï¼š
- é¡¹ç›®åç§°ï¼š${understanding.projectName || 'æœªçŸ¥'}
- é¡¹ç›®æè¿°ï¼š${understanding.projectDescription || 'æ— '}
- ç³»ç»Ÿæ¶æ„ï¼š${understanding.systemArchitecture || 'å¾…ç¡®å®š'}
- ç³»ç»Ÿè¾¹ç•Œï¼š${understanding.systemBoundary || 'å¾…ç¡®å®š'}
- ç”¨æˆ·è§’è‰²ï¼š${(understanding.userRoles || []).join('ã€') || 'ç”¨æˆ·'}
- æ•°æ®å®ä½“ï¼š${(understanding.dataEntities || []).join('ã€') || 'å¾…è¯†åˆ«'}
${triggerStats}
- æ ¸å¿ƒæ¨¡å—åŠåŠŸèƒ½ï¼ˆå«è§¦å‘æ–¹å¼ï¼‰ï¼š
${modulesList || 'æš‚æ— '}
- é¢„ä¼°åŠŸèƒ½è¿‡ç¨‹æ€»æ•°ï¼š${understanding.totalEstimatedFunctions || targetFunctions}

**è¯·åŸºäºä»¥ä¸Šç†è§£ï¼Œç¡®ä¿æ‹†åˆ†çš„åŠŸèƒ½è¿‡ç¨‹ä¸æ–‡æ¡£å®é™…å†…å®¹ä¸€è‡´ï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§æ ‡æ³¨çš„è§¦å‘æ–¹å¼å¡«å†™"åŠŸèƒ½ç”¨æˆ·"å’Œ"è§¦å‘äº‹ä»¶"åˆ—ï¼**

**è§¦å‘æ–¹å¼å¡«å†™è§„èŒƒï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š**
- ç”¨æˆ·è§¦å‘ â†’ åŠŸèƒ½ç”¨æˆ·åˆ—å¡«"ç”¨æˆ·è§¦å‘"ï¼Œè§¦å‘äº‹ä»¶åˆ—å¡«"ç”¨æˆ·è¯·æ±‚"
- æ—¶é’Ÿè§¦å‘ â†’ åŠŸèƒ½ç”¨æˆ·åˆ—å¡«"æ—¶é’Ÿè§¦å‘"ï¼Œè§¦å‘äº‹ä»¶åˆ—å¡«"å®šæ—¶ä»»åŠ¡"
- æ¥å£è§¦å‘ â†’ åŠŸèƒ½ç”¨æˆ·åˆ—å¡«"æ¥å£è§¦å‘"ï¼Œè§¦å‘äº‹ä»¶åˆ—å¡«"æ¥å£è°ƒç”¨"

`;
    }

    let userPrompt = '';
    if (round === 1) {
      // æ„å»ºç”¨æˆ·æŒ‡å¯¼æŒ‡å¯¼ä¸Šä¸‹æ–‡
      let guidelinesContext = '';
      if (userGuidelines) {
        guidelinesContext = `\n\n## ç”¨æˆ·ç‰¹å®šçš„æ‹†åˆ†è¦æ±‚ï¼ˆè¯·åŠ¡å¿…ä¸¥æ ¼éµå®ˆï¼‰ï¼š\n**${userGuidelines}**\n`;
      }

      userPrompt = `ä»¥ä¸‹æ˜¯åŠŸèƒ½æ–‡æ¡£å†…å®¹ï¼š
${guidelinesContext}
${documentContent}

${understandingContext}
## é‡è¦ï¼šæ·±åº¦æ€è€ƒè¦æ±‚
åœ¨å¼€å§‹æ‹†åˆ†ä¹‹å‰ï¼Œè¯·å…ˆæ·±åº¦ç†è§£æ–‡æ¡£ï¼š
1. **é€šè¯»å…¨æ–‡**ï¼šç†è§£ä¸šåŠ¡èƒŒæ™¯ã€ç”¨æˆ·è§’è‰²ã€ç³»ç»Ÿè¾¹ç•Œ
2. **è¯†åˆ«æ ¸å¿ƒåŠŸèƒ½**ï¼šåªè¯†åˆ«æ–‡æ¡£ä¸­æ˜ç¡®æè¿°çš„åŠŸèƒ½ï¼Œä¸è¦è‡†é€ 
3. **åˆ†æåŠŸèƒ½å…³ç³»**ï¼šç†è§£åŠŸèƒ½ä¹‹é—´çš„ä¾èµ–å’Œè°ƒç”¨å…³ç³»

## æ ¸å¿ƒåŸåˆ™ï¼šè´¨é‡ç¬¬ä¸€
- **å®ç¼ºæ¯‹æ»¥**ï¼šåªæ‹†åˆ†æ–‡æ¡£ä¸­æ˜ç¡®æè¿°çš„åŠŸèƒ½ï¼Œä¸è¦ä¸ºäº†å‡‘æ•°é‡è€Œä¹±æ‹†
- **ç²¾å‡†å‘½å**ï¼šåŠŸèƒ½è¿‡ç¨‹åç§°å¿…é¡»ä¸æ–‡æ¡£æè¿°ä¸€è‡´
- **å­è¿‡ç¨‹å”¯ä¸€**ï¼šæ¯ä¸ªå­è¿‡ç¨‹æè¿°åœ¨æ•´ä¸ªåˆ†æç»“æœä¸­å¿…é¡»å”¯ä¸€ï¼Œä¸èƒ½é‡å¤

è¯·å¯¹æ–‡æ¡£ä¸­çš„åŠŸèƒ½è¿›è¡Œé«˜è´¨é‡COSMICæ‹†åˆ†ã€‚

## è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆæå…¶é‡è¦ï¼‰ï¼š
**åªè¾“å‡ºä¸€ä¸ªMarkdownæ•°æ®è¡¨æ ¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•æ ¼å¼è¯´æ˜ã€ç¤ºä¾‹è¡¨æ ¼æˆ–å…¶ä»–è§£é‡Šæ–‡å­—ï¼**
ç›´æ¥è¾“å‡ºä»¥ä¸‹æ ¼å¼çš„è¡¨æ ¼ï¼š

|åŠŸèƒ½ç”¨æˆ·|è§¦å‘äº‹ä»¶|åŠŸèƒ½è¿‡ç¨‹|å­è¿‡ç¨‹æè¿°|æ•°æ®ç§»åŠ¨ç±»å‹|æ•°æ®ç»„|æ•°æ®å±æ€§|
|:---|:---|:---|:---|:---|:---|:---|
|ç”¨æˆ·è§¦å‘|ç”¨æˆ·è¯·æ±‚|åˆ›å»ºé£è¡Œè®¡åˆ’|æ¥æ”¶åˆ›å»ºé£è¡Œè®¡åˆ’è¯·æ±‚å‚æ•°|E|åˆ›å»ºé£è¡Œè®¡åˆ’è¯·æ±‚|è®¡åˆ’åç§°ã€èµ·é£æ—¶é—´ã€èˆªçº¿ID|
||||è¯»å–åˆ›å»ºé£è¡Œè®¡åˆ’èˆªçº¿é…ç½®|R|åˆ›å»ºé£è¡Œè®¡åˆ’èˆªçº¿è¡¨|èˆªçº¿IDã€èˆªçº¿åç§°ã€èµ·ç‚¹|
||||ä¿å­˜åˆ›å»ºé£è¡Œè®¡åˆ’è®°å½•|W|åˆ›å»ºé£è¡Œè®¡åˆ’æ•°æ®è¡¨|è®¡åˆ’IDã€åˆ›å»ºæ—¶é—´ã€çŠ¶æ€|
||||è¿”å›åˆ›å»ºé£è¡Œè®¡åˆ’ç»“æœ|X|åˆ›å»ºé£è¡Œè®¡åˆ’å“åº”|è®¡åˆ’IDã€çŠ¶æ€ã€æ¶ˆæ¯|
|ç”¨æˆ·è§¦å‘|ç”¨æˆ·è¯·æ±‚|æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨|æ¥æ”¶æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨è¯·æ±‚å‚æ•°|E|æŸ¥è¯¢ä»»åŠ¡è¯·æ±‚|æŸ¥è¯¢æ¡ä»¶ã€åˆ†é¡µå‚æ•°|
||||è¯»å–æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨æ•°æ®|R|ä»»åŠ¡æ•°æ®è¡¨|ä»»åŠ¡IDã€ä»»åŠ¡åç§°ã€çŠ¶æ€|
||||è®°å½•æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨æ“ä½œæ—¥å¿—|W|ä»»åŠ¡æŸ¥è¯¢æ—¥å¿—è¡¨|æŸ¥è¯¢äººã€æŸ¥è¯¢æ—¶é—´ã€æŸ¥è¯¢æ¡ä»¶|
||||è¿”å›æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨ç»“æœ|X|ä»»åŠ¡åˆ—è¡¨å“åº”|ä»»åŠ¡åˆ—è¡¨ã€æ€»æ•°|

## é«˜è´¨é‡æ‹†åˆ†æ ¸å¿ƒè¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼ï¼‰ï¼š
1. **æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰4ä¸ªå­è¿‡ç¨‹ï¼šE + R + W + X**
   - âœ… æ­£ç¡®ï¼šE â†’ R â†’ W â†’ Xï¼ˆ4ä¸ªå­è¿‡ç¨‹ï¼Œæ ‡å‡†ç»“æ„ï¼‰
   - âŒ é”™è¯¯ï¼šåªæœ‰Eï¼ˆç¼ºå°‘Rã€Wã€Xï¼‰
   - âŒ é”™è¯¯ï¼šE â†’ R â†’ Xï¼ˆç¼ºå°‘Wï¼‰
   - âŒ é”™è¯¯ï¼šE â†’ W â†’ Xï¼ˆç¼ºå°‘Rï¼‰
   - **å³ä½¿æ˜¯æŸ¥è¯¢åŠŸèƒ½ï¼Œä¹Ÿè¦æœ‰Wï¼ˆè®°å½•æŸ¥è¯¢æ—¥å¿—ï¼‰**
   - **å³ä½¿æ˜¯ç®€å•æ“ä½œï¼Œä¹Ÿè¦æœ‰Rï¼ˆè¯»å–ç›¸å…³æ•°æ®ï¼‰**
2. **åŠŸèƒ½è¿‡ç¨‹åç§°**ï¼šåŠ¨è¯+å…·ä½“ä¸šåŠ¡å¯¹è±¡ï¼Œå¦‚"åˆ›å»ºé£è¡Œè®¡åˆ’"
3. **å­è¿‡ç¨‹æè¿°å¿…é¡»åŒ…å«åŠŸèƒ½è¿‡ç¨‹å…³é”®è¯**ï¼šå¦‚"è¯»å–åˆ›å»ºé£è¡Œè®¡åˆ’èˆªçº¿é…ç½®"
4. **æ•°æ®ç»„å‘½åè¦å…·ä½“**ï¼šåŒ…å«åŠŸèƒ½è¿‡ç¨‹å…³é”®è¯ï¼Œå¦‚"åˆ›å»ºé£è¡Œè®¡åˆ’è¯·æ±‚"

## ä¸¥æ ¼é™åˆ¶ï¼š
1. **æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰Eã€Rã€Wã€Xå››ç§ç±»å‹ï¼Œç¼ºä¸€ä¸å¯ï¼**
2. é¡ºåºå¿…é¡»æ˜¯ï¼šE â†’ R â†’ W â†’ X
3. ç›®æ ‡è¯†åˆ«çº¦ ${targetFunctions} ä¸ªåŠŸèƒ½è¿‡ç¨‹
4. **åªè¾“å‡ºæ•°æ®è¡¨æ ¼ï¼Œä¸è¦è¾“å‡ºæ ¼å¼è¯´æ˜æˆ–ç¤ºä¾‹ï¼**`;
    } else {
      // æ„å»ºå·²ä½¿ç”¨å­è¿‡ç¨‹æè¿°çš„æç¤ºï¼ˆé¿å…é‡å¤ï¼‰
      const usedDescsHint = uniqueSubProcessDescs.length > 0
        ? `\n\n## å·²ä½¿ç”¨çš„å­è¿‡ç¨‹æè¿°ï¼ˆç»å¯¹ä¸èƒ½é‡å¤ä½¿ç”¨ï¼‰ï¼š\n${uniqueSubProcessDescs.slice(0, 50).join('\n')}${uniqueSubProcessDescs.length > 50 ? '\n...(æ›´å¤š)' : ''}\n`
        : '';

      userPrompt = `ç»§ç»­åˆ†ææ–‡æ¡£ä¸­å°šæœªæ‹†åˆ†çš„åŠŸèƒ½è¿‡ç¨‹ã€‚

å·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹ï¼ˆ${uniqueCompleted.length}ä¸ªï¼‰ï¼š
${uniqueCompleted.slice(0, 30).join('ã€')}${uniqueCompleted.length > 30 ? '...' : ''}

ç›®æ ‡è¦†ç›–çº¦ ${targetFunctions} ä¸ªåŠŸèƒ½è¿‡ç¨‹ï¼Œ**è´¨é‡ä¼˜å…ˆäºæ•°é‡**ã€‚

## è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆæå…¶é‡è¦ï¼‰ï¼š
**åªè¾“å‡ºä¸€ä¸ªMarkdownæ•°æ®è¡¨æ ¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•æ ¼å¼è¯´æ˜æˆ–è§£é‡Šæ–‡å­—ï¼**

## å­è¿‡ç¨‹å®Œæ•´æ€§è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼ï¼‰ï¼š
**æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰4ä¸ªå­è¿‡ç¨‹ï¼šE + R + W + Xï¼Œç¼ºä¸€ä¸å¯ï¼**
- æ‰€æœ‰åŠŸèƒ½ï¼šE â†’ R â†’ W â†’ Xï¼ˆ4ä¸ªå­è¿‡ç¨‹ï¼‰
- **å³ä½¿æ˜¯æŸ¥è¯¢åŠŸèƒ½ï¼Œä¹Ÿè¦æœ‰Wï¼ˆè®°å½•æŸ¥è¯¢æ—¥å¿—ï¼‰**
- **å³ä½¿æ˜¯ç®€å•æ“ä½œï¼Œä¹Ÿè¦æœ‰Rï¼ˆè¯»å–ç›¸å…³æ•°æ®ï¼‰**

æ­£ç¡®ç¤ºä¾‹ï¼ˆæ³¨æ„æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹éƒ½æœ‰Eã€Rã€Wã€Xå››ä¸ªå­è¿‡ç¨‹ï¼‰ï¼š
|åŠŸèƒ½ç”¨æˆ·|è§¦å‘äº‹ä»¶|åŠŸèƒ½è¿‡ç¨‹|å­è¿‡ç¨‹æè¿°|æ•°æ®ç§»åŠ¨ç±»å‹|æ•°æ®ç»„|æ•°æ®å±æ€§|
|:---|:---|:---|:---|:---|:---|:---|
|ç”¨æˆ·è§¦å‘|ç”¨æˆ·è¯·æ±‚|åˆ é™¤ä»»åŠ¡è®°å½•|æ¥æ”¶ä»»åŠ¡åˆ é™¤è¯·æ±‚å‚æ•°|E|ä»»åŠ¡åˆ é™¤è¯·æ±‚|ä»»åŠ¡IDã€åˆ é™¤åŸå› |
||||è¯»å–ä»»åŠ¡å½“å‰çŠ¶æ€|R|ä»»åŠ¡çŠ¶æ€è¡¨|ä»»åŠ¡IDã€çŠ¶æ€ã€åˆ›å»ºæ—¶é—´|
||||æ‰§è¡Œä»»åŠ¡åˆ é™¤æ“ä½œ|W|ä»»åŠ¡æ“ä½œæ—¥å¿—|ä»»åŠ¡IDã€æ“ä½œç±»å‹ã€æ“ä½œæ—¶é—´|
||||è¿”å›ä»»åŠ¡åˆ é™¤ç»“æœ|X|ä»»åŠ¡åˆ é™¤å“åº”|æ“ä½œçŠ¶æ€ã€æ¶ˆæ¯|
|ç”¨æˆ·è§¦å‘|ç”¨æˆ·è¯·æ±‚|æŸ¥è¯¢è®¾å¤‡åˆ—è¡¨|æ¥æ”¶è®¾å¤‡åˆ—è¡¨æŸ¥è¯¢è¯·æ±‚|E|è®¾å¤‡æŸ¥è¯¢è¯·æ±‚|æŸ¥è¯¢æ¡ä»¶ã€åˆ†é¡µå‚æ•°|
||||è¯»å–è®¾å¤‡åˆ—è¡¨æ•°æ®|R|è®¾å¤‡æ•°æ®è¡¨|è®¾å¤‡IDã€è®¾å¤‡åç§°ã€çŠ¶æ€|
||||è®°å½•è®¾å¤‡åˆ—è¡¨æŸ¥è¯¢æ—¥å¿—|W|è®¾å¤‡æŸ¥è¯¢æ—¥å¿—è¡¨|æŸ¥è¯¢äººã€æŸ¥è¯¢æ—¶é—´ã€æŸ¥è¯¢æ¡ä»¶|
||||è¿”å›è®¾å¤‡åˆ—è¡¨ç»“æœ|X|è®¾å¤‡åˆ—è¡¨å“åº”|è®¾å¤‡åˆ—è¡¨ã€æ€»æ•°|

## æ ¸å¿ƒè¦æ±‚ï¼š
1. **æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰Eã€Rã€Wã€Xå››ç§ç±»å‹ï¼Œç¼ºä¸€ä¸å¯ï¼**
2. **ç»å¯¹ç¦æ­¢**åªè¾“å‡ºEè¡Œè€Œæ²¡æœ‰åç»­Rã€Wã€Xè¡Œçš„æƒ…å†µï¼
3. **åŠŸèƒ½è¿‡ç¨‹åç§°åªåœ¨Eè¡Œå¡«å†™**ï¼Œåç»­R/W/Xè¡Œçš„åŠŸèƒ½è¿‡ç¨‹åˆ—ç•™ç©º
4. **ä¸èƒ½ä¸å·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹é‡å¤**

è¯·ç»§ç»­æ‹†åˆ†å°šæœªå¤„ç†çš„åŠŸèƒ½ï¼Œ**åªè¾“å‡ºæ•°æ®è¡¨æ ¼**ã€‚
å¦‚æœæ‰€æœ‰åŠŸèƒ½éƒ½å·²å®Œæˆï¼Œå›å¤"[ALL_DONE]"ã€‚`;
    }

    const systemMessage = {
      role: 'system',
      content: COSMIC_SYSTEM_PROMPT
    };

    console.log(`æ•°é‡ä¼˜å…ˆç¬¬ ${round} è½®åˆ†æå¼€å§‹ï¼Œå·²å®Œæˆ ${uniqueCompleted.length} ä¸ªåŠŸèƒ½è¿‡ç¨‹ï¼Œå·²æœ‰ ${uniqueSubProcessDescs.length} ä¸ªå­è¿‡ç¨‹æè¿°...`);

    const completion = await callAIChat({
      messages: [
        systemMessage,
        { role: 'user', content: userPrompt }
      ],
      temperature: 0.5
    });


    const reply = completion.choices[0].message.content;
    console.log(`æ•°é‡ä¼˜å…ˆç¬¬ ${round} è½®å®Œæˆï¼Œå“åº”é•¿åº¦: ${reply.length}`);

    // å¢å¼ºçš„å®Œæˆåˆ¤æ–­é€»è¾‘
    let isDone = false;

    // 1. æ˜ç¡®çš„å®Œæˆæ ‡è®°
    if (reply.includes('[ALL_DONE]') || reply.includes('å·²å®Œæˆ') || reply.includes('å…¨éƒ¨æ‹†åˆ†') || reply.includes('æ— éœ€è¡¥å……')) {
      isDone = true;
      console.log('æ•°é‡ä¼˜å…ˆ - æ£€æµ‹åˆ°å®Œæˆæ ‡è®°');
    }

    // 2. å¦‚æœå›å¤ä¸­æ²¡æœ‰æœ‰æ•ˆçš„è¡¨æ ¼æ•°æ®ï¼Œè®¤ä¸ºå·²å®Œæˆ
    const hasValidTable = reply.includes('|') && (reply.includes('|E|') || reply.includes('| E |') || reply.match(/\|[^|]*\|[^|]*\|[^|]*\|[^|]*\|E\|/));
    if (!hasValidTable && round > 1) {
      isDone = true;
      console.log('æ•°é‡ä¼˜å…ˆ - å›å¤ä¸­æ²¡æœ‰æœ‰æ•ˆè¡¨æ ¼ï¼Œè®¤ä¸ºå·²å®Œæˆ');
    }

    // 3. å¦‚æœå·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹æ•°é‡è¾¾åˆ°æˆ–è¶…è¿‡ç›®æ ‡ï¼Œè®¤ä¸ºå·²å®Œæˆ
    if (uniqueCompleted.length >= targetFunctions) {
      isDone = true;
      console.log(`æ•°é‡ä¼˜å…ˆ - å·²å®Œæˆ ${uniqueCompleted.length} ä¸ªåŠŸèƒ½è¿‡ç¨‹ï¼Œè¾¾åˆ°ç›®æ ‡ ${targetFunctions}`);
    }

    // 4. å¦‚æœè½®æ¬¡è¿‡å¤šï¼ˆè¶…è¿‡10è½®ï¼‰ï¼Œå¼ºåˆ¶åœæ­¢
    if (round >= 10) {
      isDone = true;
      console.log('æ•°é‡ä¼˜å…ˆ - è½®æ¬¡è¾¾åˆ°ä¸Šé™(10è½®)ï¼Œå¼ºåˆ¶åœæ­¢');
    }

    // 5. å¦‚æœå›å¤å†…å®¹è¿‡çŸ­ï¼ˆå°‘äº100å­—ç¬¦ï¼‰ï¼Œå¯èƒ½æ˜¯AIè®¤ä¸ºå·²å®Œæˆ
    if (reply.length < 100 && round > 1) {
      isDone = true;
      console.log('æ•°é‡ä¼˜å…ˆ - å›å¤å†…å®¹è¿‡çŸ­ï¼Œè®¤ä¸ºå·²å®Œæˆ');
    }

    res.json({
      success: true,
      reply: reply,
      round: round,
      isDone: isDone,
      completedFunctions: uniqueCompleted.length,
      targetFunctions
    });
  } catch (error) {
    console.error('åˆ†æå¤±è´¥:', error);
    res.status(500).json({ error: 'åˆ†æå¤±è´¥: ' + error.message });
  }
});

// ========== è´¨é‡ä¼˜å…ˆå¾ªç¯åˆ†æ API ==========
// ä¸æ•°é‡ä¼˜å…ˆç±»ä¼¼çš„å¾ªç¯è°ƒç”¨æ–¹å¼ï¼Œä½†ä½¿ç”¨æ›´é«˜è´¨é‡çš„promptç¡®ä¿åŠŸèƒ½è¿‡ç¨‹è´¨é‡
app.post('/api/quality-continue-analyze', async (req, res) => {
  try {
    const { documentContent, previousResults = [], round = 1, targetFunctions = 30, understanding = null, userGuidelines = '' } = req.body;

    // æ„å»ºå·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹åˆ—è¡¨

    const completedFunctions = previousResults.map(r => r.functionalProcess).filter(Boolean);
    const uniqueCompleted = [...new Set(completedFunctions)];

    // æ„å»ºæ–‡æ¡£ç†è§£ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰ï¼‰- è´¨é‡ä¼˜å…ˆå¢å¼ºç‰ˆï¼šåŒ…å«è§¦å‘æ–¹å¼ä¿¡æ¯
    let understandingContext = '';
    if (understanding) {
      const modules = understanding.coreModules || [];
      const modulesList = modules.map(m => {
        const functions = m.estimatedFunctions || [];
        const funcList = Array.isArray(functions) && functions.length > 0 && typeof functions[0] === 'object'
          ? functions.map(f => `  Â· ${f.functionName} [${f.triggerType}] - ${f.scenario || ''}`).join('\n')
          : functions.map(f => `  Â· ${f}`).join('\n');
        return `- **${m.moduleName}**ï¼š\n${funcList}`;
      }).join('\n\n');

      // æ„å»ºè§¦å‘æ–¹å¼ç»Ÿè®¡
      const breakdown = understanding.functionBreakdown || {};
      const triggerStats = breakdown.userTriggeredFunctions || breakdown.timerTriggeredFunctions || breakdown.interfaceTriggeredFunctions
        ? `
**è§¦å‘æ–¹å¼åˆ†å¸ƒç»Ÿè®¡**ï¼š
- ç”¨æˆ·è§¦å‘åŠŸèƒ½ï¼š${breakdown.userTriggeredFunctions || 0}ä¸ª (ç”¨æˆ·ç‚¹å‡»ã€æ“ä½œã€æŸ¥è¯¢ç­‰)
- æ—¶é’Ÿè§¦å‘åŠŸèƒ½ï¼š${breakdown.timerTriggeredFunctions || 0}ä¸ª (å®šæ—¶ã€å‘¨æœŸã€è‡ªåŠ¨æ‰§è¡Œ)
- æ¥å£è§¦å‘åŠŸèƒ½ï¼š${breakdown.interfaceTriggeredFunctions || 0}ä¸ª (æ¥æ”¶æ¨é€ã€å›è°ƒã€å¤–éƒ¨è°ƒç”¨)`
        : '';

      // æ„å»ºå®šæ—¶ä»»åŠ¡åˆ—è¡¨
      const timedTasks = understanding.timedTasks || [];
      const timedTasksList = timedTasks.length > 0
        ? `\n**å®šæ—¶ä»»åŠ¡æ˜ç»†**ï¼š\n${timedTasks.map(t => `- ${t.taskName} (${t.schedule}): ${t.description}`).join('\n')}`
        : '';

      understandingContext = `
## æ–‡æ¡£æ·±åº¦ç†è§£ç»“æœï¼ˆå«è§¦å‘æ–¹å¼è¯¦ç»†æ ‡æ³¨ï¼‰ï¼š
- é¡¹ç›®åç§°ï¼š${understanding.projectName || 'æœªçŸ¥'}
- é¡¹ç›®æè¿°ï¼š${understanding.projectDescription || 'æ— '}
- ç³»ç»Ÿæ¶æ„ï¼š${understanding.systemArchitecture || 'å¾…ç¡®å®š'}
- ç³»ç»Ÿè¾¹ç•Œï¼š${understanding.systemBoundary || 'å¾…ç¡®å®š'}
- ç”¨æˆ·è§’è‰²ï¼š${(understanding.userRoles || []).join('ã€') || 'ç”¨æˆ·'}
- æ•°æ®å®ä½“ï¼š${(understanding.dataEntities || []).join('ã€') || 'å¾…è¯†åˆ«'}
- å¤–éƒ¨æ¥å£ï¼š${(understanding.externalInterfaces || []).join('ã€') || 'æ— '}
${triggerStats}${timedTasksList}
- é¢„ä¼°åŠŸèƒ½è¿‡ç¨‹æ€»æ•°ï¼š${understanding.totalEstimatedFunctions || 30}

**æ ¸å¿ƒæ¨¡å—åŠåŠŸèƒ½ï¼ˆå«è§¦å‘æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ï¼‰ï¼š**
${modulesList || 'æš‚æ— '}

---

**è¯·åŸºäºä»¥ä¸Šæ·±åº¦ç†è§£ï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è§„åˆ™è¿›è¡ŒCOSMICæ‹†åˆ†ï¼š**

1. **ç¡®ä¿æ‹†åˆ†çš„åŠŸèƒ½è¿‡ç¨‹ä¸æ–‡æ¡£å®é™…å†…å®¹ä¸€è‡´ï¼Œè¦†ç›–æ‰€æœ‰æ ¸å¿ƒæ¨¡å—çš„åŠŸèƒ½**
2. **ä¸¥æ ¼æŒ‰ç…§æ ‡æ³¨çš„è§¦å‘æ–¹å¼å¡«å†™"åŠŸèƒ½ç”¨æˆ·"å’Œ"è§¦å‘äº‹ä»¶"åˆ—**ï¼š
   - ç”¨æˆ·è§¦å‘ â†’ åŠŸèƒ½ç”¨æˆ·="ç”¨æˆ·è§¦å‘"ï¼Œè§¦å‘äº‹ä»¶="ç”¨æˆ·è¯·æ±‚"
   - æ—¶é’Ÿè§¦å‘ â†’ åŠŸèƒ½ç”¨æˆ·="æ—¶é’Ÿè§¦å‘"ï¼Œè§¦å‘äº‹ä»¶="å®šæ—¶ä»»åŠ¡"
   - æ¥å£è§¦å‘ â†’ åŠŸèƒ½ç”¨æˆ·="æ¥å£è§¦å‘"ï¼Œè§¦å‘äº‹ä»¶="æ¥å£è°ƒç”¨"
3. **ä¸è¦è‡†é€ æ–‡æ¡£ä¸­æ²¡æœ‰çš„åŠŸèƒ½**
4. **æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰å®Œæ•´çš„E+R+W+Xå››ä¸ªå­è¿‡ç¨‹**

`;
    }

    let userPrompt = '';
    if (round === 1) {
      // æ„å»ºç”¨æˆ·æŒ‡å¯¼æŒ‡å¯¼ä¸Šä¸‹æ–‡
      let guidelinesContext = '';
      if (userGuidelines) {
        guidelinesContext = `\n\n## ç”¨æˆ·ç‰¹å®šçš„æ‹†åˆ†è¦æ±‚ï¼ˆè¯·åŠ¡å¿…ä¸¥æ ¼éµå®ˆï¼‰ï¼š\n**${userGuidelines}**\n`;
      }

      userPrompt = `ä»¥ä¸‹æ˜¯åŠŸèƒ½æ–‡æ¡£å†…å®¹ï¼š
${guidelinesContext}
${documentContent}

${understandingContext}è¯·å¯¹æ–‡æ¡£ä¸­çš„åŠŸèƒ½è¿›è¡Œç«‹ä½“åŒ–COSMICæ‹†åˆ†ï¼Œè¾“å‡ºMarkdownè¡¨æ ¼ã€‚

## ä¸€ã€ é€»è¾‘é‡æ„é“å¾‹ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼ï¼‰

ä½ å¿…é¡»åœæ­¢å¹³é¢çš„"å¢åˆ æ”¹æŸ¥"æ€ç»´ï¼Œé‡‡ç”¨ 3D ç«‹ä½“å»ºæ¨¡ï¼š

1. **çºµå‘ï¼ˆæµç¨‹è½´ï¼‰**ï¼šæŒ–æ˜"å…¨ç”Ÿå‘½å‘¨æœŸ"ã€‚
   - ä¸¥ç¦åªå†™"æ‰§è¡Œ"ã€‚å¿…é¡»è‡ªåŠ¨æ‹†è§£å‡ºã€é¢„æ ¡éªŒ/å…¥åœºã€‘ã€ã€æ‰§è¡Œä¸­çŠ¶æ€æ›´æ–°ã€‘ã€ã€å¼‚å¸¸æ•è·ä¸é‡è¯•ã€‘ã€ã€ç»“æœå¼‚æ­¥ç¡®è®¤/å‡ºåœºã€‘ç­‰ç‹¬ç«‹è¿‡ç¨‹ã€‚
   
2. **æ¨ªå‘ï¼ˆç®¡ç†è½´ï¼‰**ï¼šæŒ–æ˜"éšè—åº•åº§"ã€‚
   - è‡ªåŠ¨è¡¥å…¨æ–‡æ¡£æœªè¨€æ˜çš„ç®¡ç†åŠŸèƒ½ï¼šæ“ä½œå®¡è®¡ï¼ˆAuditï¼‰ã€æƒé™æ ¸æŸ¥ï¼ˆAuthï¼‰ã€å­—å…¸å¯¹é½ï¼ˆMappingï¼‰ã€ç³»ç»Ÿæ—¥å¿—ï¼ˆLogï¼‰ã€åˆè§„è‡ªæ£€ï¼ˆCheckï¼‰ã€‚

3. **æ·±åº¦ï¼ˆé¢—ç²’åº¦ï¼‰**ï¼šæŒ–æ˜"åŸå­å­—æ®µ"ã€‚
   - å°†å¤åˆæ¥å£æŒ‰å­—æ®µæ˜ å°„æ‹†è§£ã€‚æ¯ä¸€ä¸ªæ ¸å¿ƒå­—æ®µï¼ˆçŠ¶æ€ç ã€æµæ°´å·ï¼‰çš„è¯»å†™éƒ½åº”è¢«è§†ä¸ºæ½œåœ¨çš„æ•°æ®ç§»åŠ¨ã€‚

## äºŒã€ ERWX åŸå­åŒ–å»ºæ¨¡è§„èŒƒ

æ¯ä¸€è¡Œæè¿°å¿…é¡»ç¬¦åˆä»¥ä¸‹åŸå­åŒ–å…¬å¼ï¼Œä¸¥ç¦ä½¿ç”¨"æ¥æ”¶è¯·æ±‚/ä¿å­˜æ•°æ®"ç­‰æ¨¡ç³Šè¯æ±‡ï¼š

- **E (Entry/é—¨å«)**ï¼šæ¥æ”¶ + [åœºæ™¯åŒ–ä¸šåŠ¡å¯¹è±¡] + [åè®®/å½¢æ€] + [æŒ‡ä»¤/åŒ…]ã€‚
- **R (Read/å¤§è„‘)**ï¼šæ£€ç´¢ + [ä¸šåŠ¡çŠ¶æ€/å­—å…¸] + [å…³è”å…³ç³»] + [é›†åˆ/æ•°æ®]ã€‚
- **W (Write/æ‰§è¡Œ)**ï¼šæŒä¹…åŒ–/æ›´æ–° + [è¡Œä¸ºæè¿°] + [è¡¨æ—å] + [äº‹åŠ¡æµæ°´/æ—¥å¿—]ã€‚
- **X (eXit/åé¦ˆ)**ï¼šå°è£… + [å“åº”ç­‰çº§] + [è¿”å›ç æ˜ å°„] + [å“åº”ä½“/å‡­è¯]ã€‚

## ä¸‰ã€ æ•°æ®å±æ€§ä¸æŸ¥é‡ï¼ˆç»å¯¹å”¯ä¸€æ€§ï¼‰

1. **åŸå­åŒ–å­—æ®µæ± **ï¼šä»æ–‡æ¡£ä¸­æ‰«ææ‰€æœ‰ä¸šåŠ¡å­—æ®µï¼ˆSNã€å‚å®¶ã€ç å€¼ï¼‰å’Œç®¡ç†å­—æ®µï¼ˆTimestampã€Operatorã€RetryCountï¼‰ã€‚
2. **ç‰¹å¾æŒ‡çº¹å»é‡**ï¼š
   - æ¯ä¸ªåŠŸèƒ½å¿…é¡»æœ‰ä¸€ä¸ª"é”šå®šå­—æ®µ"ã€‚
   - **æŒ‡çº¹äº’æ–¥**ï¼šç›¸é‚»åŠŸèƒ½çš„æ•°æ®å±æ€§ç»„åˆé‡åˆåº¦å¿…é¡»ä½äº 30%ã€‚é€šè¿‡éšæœºå¼‚ä½å¡«å……è¾…åŠ©å­—æ®µï¼ˆå¦‚åœ¨AåŠŸèƒ½å†™æ—¶é—´ï¼ŒBåŠŸèƒ½å†™ç‰ˆæœ¬å·ï¼‰å®ç°ç‰©ç†æŸ¥é‡ã€‚
3. **å‘½åå…¬å¼ (Object + Action + State)**ï¼šå¦‚ã€ä½ç©ºä»»åŠ¡ã€‘ã€å‚æ•°å˜æ›´ã€‘ã€æµæ°´è¡¨ã€‘ã€‚

è¯·ç«‹åˆ»å¼€å§‹æ·±åº¦æ‹†åˆ†ï¼Œç¡®ä¿è¾“å‡ºçš„åŠŸèƒ½è¿‡ç¨‹å…·å¤‡æé«˜çš„å®æˆ˜è¦†ç›–ç‡ã€‚

## é«˜è´¨é‡æ‹†åˆ†è¦æ±‚ï¼š
1. **åŠŸèƒ½è¿‡ç¨‹åç§°å¿…é¡»ç²¾å‡†åˆ°åœºæ™¯çº§åˆ«**ï¼šä¸ä»…è¦æœ‰"åŠ¨è¯+åè¯"ï¼Œè¿˜è¦æœ‰"çŠ¶æ€/ç±»å‹/èŒƒå›´"æè¿°
2. **å­è¿‡ç¨‹æè¿°å¿…é¡»é«˜åº¦åœºæ™¯åŒ–**ï¼šè¦è®©äººä¸€çœ¼çœ‹å‡ºè¿™æ˜¯ä»€ä¹ˆä¸šåŠ¡åœºæ™¯ä¸‹çš„ä»€ä¹ˆæ“ä½œ
3. **æ•°æ®ç»„å‘½åå¿…é¡»ä¸šåŠ¡åŒ–**ï¼šé¿å…ä½¿ç”¨"è¯·æ±‚ã€å“åº”ã€è¡¨ã€è®°å½•"ç­‰é€šç”¨è¯ï¼Œè¦ç”¨å…·ä½“çš„ä¸šåŠ¡æœ¯è¯­
4. **æ•°æ®å±æ€§å¿…é¡»å·®å¼‚åŒ–**ï¼šæ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹çš„å­—æ®µç»„åˆå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä½“ç°è¯¥åŠŸèƒ½çš„ç‰¹å®šéœ€æ±‚

## åŠŸèƒ½è¿‡ç¨‹ä¸å­è¿‡ç¨‹çš„å±‚çº§å…³ç³»ï¼š
**ä¸€ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»åŒ…å«å¤šä¸ªå­è¿‡ç¨‹ï¼ŒåŠŸèƒ½è¿‡ç¨‹åç§°åªåœ¨ç¬¬ä¸€è¡Œï¼ˆEè¡Œï¼‰å¡«å†™ï¼Œåç»­å­è¿‡ç¨‹è¡Œçš„åŠŸèƒ½è¿‡ç¨‹åˆ—å¿…é¡»ç•™ç©ºï¼**

æ­£ç¡®ç¤ºä¾‹ï¼ˆé«˜è´¨é‡æ‹†åˆ† - å±•ç¤ºä¸¤ä¸ªé«˜åº¦åŒºåˆ†åŒ–çš„åŠŸèƒ½ï¼‰ï¼š
| åŠŸèƒ½ç”¨æˆ· | è§¦å‘äº‹ä»¶ | åŠŸèƒ½è¿‡ç¨‹ | å­è¿‡ç¨‹æè¿° | æ•°æ®ç§»åŠ¨ç±»å‹ | æ•°æ®ç»„ | æ•°æ®å±æ€§ |
|:---|:---|:---|:---|:---|:---|:---|
| ç”¨æˆ·è§¦å‘ | ç”¨æˆ·è¯·æ±‚ | åˆ›å»ºæ–°çš„é£è¡Œè®¡åˆ’ä»»åŠ¡ | æ¥æ”¶æ–°é£è¡Œè®¡åˆ’ä»»åŠ¡åˆ›å»ºè¡¨å•æ•°æ® | E | é£è¡Œè®¡åˆ’ä»»åŠ¡æ–°å»ºè¡¨å•æäº¤æ•°æ® | é£è¡Œè®¡åˆ’æ¨¡æ¿IDã€è®¡åˆ’ä»»åŠ¡åç§°ã€è®¡åˆ’åˆ›å»ºäººã€èµ·é£é¢„å®šæ—¶é—´ã€èˆªçº¿é€‰æ‹©IDã€æ— äººæœºæŒ‡å®šIDã€ä»»åŠ¡ä¼˜å…ˆçº§ |
|||| è¯»å–å¯ç”¨èˆªçº¿åº“å’Œæ— äººæœºèµ„æºåˆ†é…æƒ…å†µ | R | å¯åˆ†é…èˆªçº¿ä¸æ— äººæœºèµ„æºæ±  | èˆªçº¿IDã€èˆªçº¿åç§°ã€èµ·ç‚¹åæ ‡ã€ç»ˆç‚¹åæ ‡ã€æ— äººæœºIDã€å½“å‰ä½ç½®ã€å‰©ä½™ç”µé‡ã€å¯ç”¨çŠ¶æ€ã€ç»´æŠ¤è®¡åˆ’ |
|||| ä¿å­˜é£è¡Œè®¡åˆ’ä»»åŠ¡åˆå§‹é…ç½®å’Œèµ„æºç»‘å®šå…³ç³» | W | é£è¡Œè®¡åˆ’ä»»åŠ¡åˆå§‹é…ç½®æŒä¹…åŒ–æ•°æ® | è®¡åˆ’ä»»åŠ¡IDã€è®¡åˆ’åç§°ã€åˆ›å»ºæ—¶é—´ã€è®¡åˆ’çŠ¶æ€ã€åˆ†é…èˆªçº¿ã€åˆ†é…æ— äººæœºã€é¢„è®¡èµ·é£æ—¶é—´ã€åˆ›å»ºäººID |
|||| è¿”å›é£è¡Œè®¡åˆ’ä»»åŠ¡åˆ›å»ºæˆåŠŸå‡­è¯å’Œèµ„æºæ¸…å• | X | é£è¡Œè®¡åˆ’ä»»åŠ¡åˆ›å»ºå‡­è¯ä¸èµ„æºæ¸…å• | è®¡åˆ’ä»»åŠ¡IDã€åˆ›å»ºçŠ¶æ€ã€é¢„è®¡èµ·é£æ—¶é—´ã€åˆ†é…çš„èˆªçº¿ä¿¡æ¯ã€åˆ†é…çš„æ— äººæœºä¿¡æ¯ã€ä»»åŠ¡ä¼˜å…ˆçº§ã€åˆ›å»ºæ—¶é—´æˆ³ |
| ç”¨æˆ·è§¦å‘ | ç”¨æˆ·è¯·æ±‚ | å¯ç”¨å·²æš‚åœçš„é£è¡Œä»»åŠ¡æ¢å¤æ‰§è¡Œ | æ¥æ”¶é£è¡Œä»»åŠ¡æ¢å¤æ‰§è¡ŒæŒ‡ä»¤å‚æ•° | E | é£è¡Œä»»åŠ¡æ¢å¤æ‰§è¡ŒæŒ‡ä»¤å‚æ•°é›† | æš‚åœä»»åŠ¡IDã€æ¢å¤æ‰§è¡Œæ“ä½œäººã€æ¢å¤æ—¶é—´ç‚¹ã€æš‚åœåŸå› ç ã€æ¢å¤åé¢„è®¡å®Œæˆæ—¶é—´ |
|||| è¯»å–é£è¡Œä»»åŠ¡æš‚åœå‰çš„æ‰§è¡Œè¿›åº¦å’Œè®¾å¤‡çŠ¶æ€ | R | é£è¡Œä»»åŠ¡æš‚åœå‰æ‰§è¡Œå¿«ç…§æ•°æ® | ä»»åŠ¡IDã€æš‚åœæ—¶èˆªç‚¹ä½ç½®ã€æš‚åœæ—¶é£è¡Œé«˜åº¦ã€æš‚åœå‰å·²é£è¡Œæ—¶é•¿ã€æš‚åœå‰å·²å®Œæˆèˆªç‚¹æ•°ã€æ— äººæœºæš‚åœæ—¶è®¾å¤‡çŠ¶æ€ã€å‰©ä½™ç”µé‡ç™¾åˆ†æ¯” |
|||| æ›´æ–°é£è¡Œä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ä¸ºè¿è¡Œä¸­å¹¶è®°å½•æ¢å¤æ—¶é—´ç‚¹ | W | é£è¡Œä»»åŠ¡çŠ¶æ€è½¬æ¢æ“ä½œæ—¥å¿— | ä»»åŠ¡IDã€çŠ¶æ€è½¬æ¢ç±»å‹ã€ä»æš‚åœåˆ°è¿è¡Œã€çŠ¶æ€è½¬æ¢æ—¶é—´ã€æ¢å¤æ“ä½œäººã€æ¢å¤åŸå› ã€é¢„è®¡æ¢å¤åå®Œæˆæ—¶é—´ |
|||| è¿”å›é£è¡Œä»»åŠ¡æ¢å¤æ‰§è¡Œç¡®è®¤åŠé¢„è®¡å®Œæˆæ—¶é—´ | X | é£è¡Œä»»åŠ¡æ¢å¤æ‰§è¡Œç¡®è®¤å›æ‰§ | ä»»åŠ¡IDã€æ¢å¤æ‰§è¡ŒçŠ¶æ€ã€æ¢å¤æ—¶é—´ç‚¹ã€å½“å‰èˆªç‚¹ä½ç½®ã€é¢„è®¡å®Œæˆæ—¶é—´ã€å‰©ä½™é£è¡Œæ—¶é•¿ã€æ“ä½œç¡®è®¤ç  |

## å…¶ä»–è§„åˆ™ï¼š
1. **æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰4ä¸ªå­è¿‡ç¨‹ï¼šE + R + W + Xï¼Œç¼ºä¸€ä¸å¯ï¼**
2. é¡ºåºå¿…é¡»æ˜¯ï¼šE â†’ R â†’ W â†’ X
3. åŠŸèƒ½è¿‡ç¨‹åç§°å¿…é¡»å”¯ä¸€ä¸”é«˜åº¦å¯åŒºåˆ†
4. **å®Œæ•´è¦†ç›–æ–‡æ¡£ä¸­çš„æ‰€æœ‰åŠŸèƒ½æè¿°ï¼Œä¸è¦é—æ¼**
5. **ä¸¥æ ¼é¿å…åŠŸèƒ½è¿‡ç¨‹ä¹‹é—´çš„æè¿°é›·åŒï¼Œæ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹éƒ½å¿…é¡»æœ‰æ˜æ˜¾çš„ä¸šåŠ¡ç‰¹å¾å·®å¼‚**`;
    } else {
      // è®¡ç®—å®Œæˆè¿›åº¦
      const estimatedTarget = understanding?.totalEstimatedFunctions || 30;
      const progress = Math.round((uniqueCompleted.length / estimatedTarget) * 100);
      const remaining = Math.max(0, estimatedTarget - uniqueCompleted.length);

      userPrompt = `ç»§ç»­åˆ†ææ–‡æ¡£ä¸­å°šæœªæ‹†åˆ†çš„åŠŸèƒ½è¿‡ç¨‹ã€‚

## ğŸ“Š å½“å‰è¿›åº¦
        - å·²å®Œæˆï¼š${uniqueCompleted.length} ä¸ªåŠŸèƒ½è¿‡ç¨‹
          - é¢„ä¼°æ€»æ•°ï¼š${estimatedTarget} ä¸ª
            - å®Œæˆè¿›åº¦ï¼š${progress}%
              - å¾…æ‹†åˆ†ï¼šçº¦ ${remaining} ä¸ª

## å·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹åˆ—è¡¨ï¼š
${uniqueCompleted.slice(0, 30).join('ã€')}${uniqueCompleted.length > 30 ? '...' : ''}

## âš ï¸ é‡è¦æç¤ºï¼šè¯·æ‹†åˆ†æ–‡æ¡£ç†è§£é˜¶æ®µè¯†åˆ«å‡ºçš„æ‰€æœ‰åŠŸèƒ½ï¼

      åœ¨ç¬¬ä¸€é˜¶æ®µæ–‡æ¡£ç†è§£ä¸­ï¼Œæˆ‘ä»¬è¯†åˆ«å‡ºäº†çº¦${estimatedTarget} ä¸ªåŠŸèƒ½è¿‡ç¨‹ï¼Œå½“å‰ä»…å®Œæˆ${uniqueCompleted.length} ä¸ªï¼ˆ${progress}%ï¼‰ã€‚
      è¯·æ ¹æ®æ–‡æ¡£å†…å®¹ï¼Œç»§ç»­æ‹†åˆ†å°šæœªå¤„ç†çš„åŠŸèƒ½è¿‡ç¨‹ï¼Œç¡®ä¿ä¸é—æ¼ä»»ä½•å·²è¯†åˆ«çš„åŠŸèƒ½ã€‚

## âš ï¸ æå…¶é‡è¦ï¼šé¿å…ä¸å·²å®ŒæˆåŠŸèƒ½è¿‡ç¨‹é›·åŒï¼

### åŠŸèƒ½è¿‡ç¨‹åŒºåˆ†åŒ–æ£€æŸ¥æ¸…å•ï¼š
      åœ¨æ‹†åˆ†æ–°çš„åŠŸèƒ½è¿‡ç¨‹ä¹‹å‰ï¼Œå¿…é¡»ç¡®ä¿ï¼š
      1. âœ… åŠŸèƒ½è¿‡ç¨‹åç§°ä¸å·²å®Œæˆçš„åŠŸèƒ½åœ¨ä¸šåŠ¡åœºæ™¯ä¸Šæœ‰æ˜æ˜¾å·®å¼‚
      2. âœ… å­è¿‡ç¨‹æè¿°ä¸èƒ½ä¸å·²å®ŒæˆåŠŸèƒ½çš„æè¿°æ¨¡å¼é›·åŒ
      3. âœ… æ•°æ®ç»„åç§°ä¸èƒ½ç®€å•å¤ç”¨"è¯·æ±‚/å“åº”/è¡¨/è®°å½•"ç­‰é€šç”¨æ¨¡å¼
      4. âœ… æ•°æ®å±æ€§ç»„åˆå¿…é¡»ä½“ç°è¯¥åŠŸèƒ½çš„ç‹¬ç‰¹ä¸šåŠ¡éœ€æ±‚

### é«˜åŒºåˆ†åº¦å‘½åè§„èŒƒï¼š
** åŠŸèƒ½è¿‡ç¨‹å‘½åå…¬å¼ **ï¼šåŠ¨è¯ + ä¸šåŠ¡çŠ¶æ€ / ç±»å‹ / èŒƒå›´ + å…·ä½“ä¸šåŠ¡å¯¹è±¡ + æ“ä½œåœºæ™¯

âŒ ç¦æ­¢æ³›åŒ–å‘½åï¼š
      - "å¯ç”¨XX" â†’ å¿…é¡»è¯´æ˜å¯ç”¨ä»€ä¹ˆçŠ¶æ€çš„XXï¼Œå¯ç”¨åè¿›å…¥ä»€ä¹ˆçŠ¶æ€
        - "åˆ›å»ºXX" â†’ å¿…é¡»è¯´æ˜åˆ›å»ºä»€ä¹ˆç±»å‹çš„XXï¼Œåˆ›å»ºçš„ä¸šåŠ¡åœºæ™¯æ˜¯ä»€ä¹ˆ
          - "æŸ¥è¯¢XX" â†’ å¿…é¡»è¯´æ˜æŸ¥è¯¢ä»€ä¹ˆèŒƒå›´çš„XXï¼ŒæŸ¥è¯¢çš„ç›®çš„æ˜¯ä»€ä¹ˆ
            - "ä¿®æ”¹XX" â†’ å¿…é¡»è¯´æ˜ä¿®æ”¹XXçš„å“ªä¸ªæ–¹é¢ï¼Œä¿®æ”¹çš„ä¸šåŠ¡åœºæ™¯æ˜¯ä»€ä¹ˆ

âœ… æ­£ç¡®çš„é«˜åŒºåˆ†åº¦å‘½åï¼š
      - "å¯ç”¨å·²æš‚åœçš„XXæ¢å¤æ‰§è¡Œ" vs "åˆ›å»ºæ–°çš„XXåˆå§‹åŒ–é…ç½®" - æ˜ç¡®äº†ä¸åŒçš„ä¸šåŠ¡çŠ¶æ€å’Œåœºæ™¯
        - "æŸ¥è¯¢XXå®æ—¶ç›‘æ§æ•°æ®åˆ—è¡¨" vs "æŸ¥è¯¢XXå†å²ç»Ÿè®¡æŠ¥è¡¨" - æ˜ç¡®äº†æ•°æ®çš„ä¸åŒç»´åº¦å’Œç”¨é€”
          - "ä¿®æ”¹XXæ‰§è¡Œä¸­çš„å‚æ•°é…ç½®" vs "ä¿®æ”¹XXåŸºç¡€ä¿¡æ¯æ¡£æ¡ˆ" - æ˜ç¡®äº†ä¿®æ”¹çš„ä¸åŒå†…å®¹å’Œæ—¶æœº

### å­è¿‡ç¨‹æè¿°åœºæ™¯åŒ–è¦æ±‚ï¼š
      æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹çš„E / R / W / Xå››ä¸ªå­è¿‡ç¨‹å¿…é¡»åœ¨æè¿°ä¸­æ¸…æ™°ä½“ç°è¯¥åŠŸèƒ½çš„ç‹¬ç‰¹ä¸šåŠ¡åœºæ™¯ï¼š

** Eï¼ˆEntryï¼‰** - å¿…é¡»ä½“ç°è¾“å…¥æ•°æ®çš„ä¸šåŠ¡åœºæ™¯ç‰¹å¾ï¼š
      - âŒ "æ¥æ”¶XXè¯·æ±‚å‚æ•°" â†’ âœ… "æ¥æ”¶XX[å…·ä½“ä¸šåŠ¡åœºæ™¯]æŒ‡ä»¤å‚æ•°é›†"
        - ä¾‹å¦‚ï¼š"æ¥æ”¶é£è¡Œä»»åŠ¡æ¢å¤æ‰§è¡ŒæŒ‡ä»¤å‚æ•°é›†" vs "æ¥æ”¶é£è¡Œè®¡åˆ’ä»»åŠ¡æ–°å»ºè¡¨å•æ•°æ®"

          ** Rï¼ˆReadï¼‰** - å¿…é¡»ä½“ç°éœ€è¦è¯»å–ä»€ä¹ˆä¸šåŠ¡æ•°æ®ã€ä¸ºä»€ä¹ˆè¦è¯»å–ï¼š
      - âŒ "è¯»å–XXä¿¡æ¯" â†’ âœ… "è¯»å–XX[ä¸šåŠ¡ç›®çš„]æ‰€éœ€çš„[å…·ä½“æ•°æ®èŒƒå›´]"
        - ä¾‹å¦‚ï¼š"è¯»å–é£è¡Œä»»åŠ¡æš‚åœå‰çš„æ‰§è¡Œè¿›åº¦å¿«ç…§" vs "è¯»å–å¯åˆ†é…çš„èˆªçº¿åº“å’Œæ— äººæœºèµ„æºæ± "

          ** Wï¼ˆWriteï¼‰** - å¿…é¡»ä½“ç°å†™å…¥ä»€ä¹ˆä¸šåŠ¡é€»è¾‘ã€å†™å…¥çš„ä¸šåŠ¡æ„ä¹‰ï¼š
      - âŒ "ä¿å­˜XXè®°å½•" â†’ âœ… "æ›´æ–°/ä¿å­˜/è®°å½•XX[ä¸šåŠ¡é€»è¾‘][ä¸šåŠ¡ç»“æœ]"
        - ä¾‹å¦‚ï¼š"æ›´æ–°é£è¡Œä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­å¹¶è®°å½•æ¢å¤æ—¶é—´ç‚¹" vs "ä¿å­˜é£è¡Œè®¡åˆ’åˆå§‹é…ç½®å’Œèµ„æºç»‘å®šå…³ç³»"

          ** Xï¼ˆeXitï¼‰** - å¿…é¡»ä½“ç°è¿”å›ä»€ä¹ˆä¸šåŠ¡ç»“æœã€ç»“æœçš„ä¸šåŠ¡ä»·å€¼ï¼š
      - âŒ "è¿”å›XXç»“æœ" â†’ âœ… "è¿”å›XX[ä¸šåŠ¡å‡­è¯/ç¡®è®¤][å…³é”®ä¸šåŠ¡ä¿¡æ¯]"
        - ä¾‹å¦‚ï¼š"è¿”å›é£è¡Œä»»åŠ¡æ¢å¤æ‰§è¡Œç¡®è®¤åŠé¢„è®¡å®Œæˆæ—¶é—´" vs "è¿”å›é£è¡Œè®¡åˆ’åˆ›å»ºå‡­è¯å’Œåˆ†é…çš„èµ„æºæ¸…å•"

### æ•°æ®ç»„å’Œæ•°æ®å±æ€§å·®å¼‚åŒ–è¦æ±‚ï¼š

** æ•°æ®ç»„å‘½å ** - å¿…é¡»ç”¨ä¸šåŠ¡æœ¯è¯­è€ŒéæŠ€æœ¯æœ¯è¯­ï¼š
      - âŒ "XXè¯·æ±‚"ã€"XXå“åº”"ã€"XXè¡¨"ã€"XXè®°å½•" â†’ æ³›åŒ–
        - âœ… "XX[ä¸šåŠ¡åœºæ™¯]æŒ‡ä»¤å‚æ•°é›†"ã€"XX[ä¸šåŠ¡ç»“æœ]ç¡®è®¤å›æ‰§"ã€"XX[æ•°æ®æ€§è´¨]å¿«ç…§æ•°æ®"ã€"XX[ä¸šåŠ¡é€»è¾‘]æŒä¹…åŒ–æ•°æ®"

          ** æ•°æ®å±æ€§ç»„åˆ ** - å¿…é¡»ä½“ç°åŠŸèƒ½çš„ç‹¬ç‰¹ä¸šåŠ¡éœ€æ±‚ï¼š
      - ä¸åŒåŠŸèƒ½è¿‡ç¨‹çš„æ•°æ®å±æ€§å¿…é¡»æœ‰æ˜æ˜¾å·®å¼‚ï¼Œä¸èƒ½åªæ˜¯æ¢ä¸ªåŠ¨è¯
        - æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹çš„å­—æ®µç»„åˆåº”è¯¥æ˜¯è¯¥åŠŸèƒ½ç‰¹æœ‰çš„ï¼Œä½“ç°è¯¥åŠŸèƒ½çš„ä¸šåŠ¡é€»è¾‘

## è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆæå…¶é‡è¦ï¼‰ï¼š
** åªè¾“å‡ºä¸€ä¸ªMarkdownæ•°æ®è¡¨æ ¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•æ ¼å¼è¯´æ˜æˆ–è§£é‡Šæ–‡å­—ï¼**

## å­è¿‡ç¨‹å®Œæ•´æ€§è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼ï¼‰ï¼š
** æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰4ä¸ªå­è¿‡ç¨‹ï¼šE + R + W + Xï¼Œç¼ºä¸€ä¸å¯ï¼**
        - æ‰€æœ‰åŠŸèƒ½ï¼šE â†’ R â†’ W â†’ Xï¼ˆ4ä¸ªå­è¿‡ç¨‹ï¼‰
- ** å³ä½¿æ˜¯æŸ¥è¯¢åŠŸèƒ½ï¼Œä¹Ÿè¦æœ‰Wï¼ˆè®°å½•æŸ¥è¯¢æ—¥å¿—ï¼‰**
- ** å³ä½¿æ˜¯ç®€å•æ“ä½œï¼Œä¹Ÿè¦æœ‰Rï¼ˆè¯»å–ç›¸å…³æ•°æ®ï¼‰**

        æ­£ç¡®ç¤ºä¾‹ï¼ˆå±•ç¤ºé«˜åŒºåˆ†åº¦æ‹†åˆ† - æ³¨æ„ä¸¤ä¸ªåŠŸèƒ½çš„é«˜åº¦å·®å¼‚åŒ–ï¼‰ï¼š
| åŠŸèƒ½ç”¨æˆ· | è§¦å‘äº‹ä»¶ | åŠŸèƒ½è¿‡ç¨‹ | å­è¿‡ç¨‹æè¿° | æ•°æ®ç§»åŠ¨ç±»å‹ | æ•°æ®ç»„ | æ•°æ®å±æ€§ |
|: ---|: ---|: ---|: ---|: ---|: ---|: ---|
| ç”¨æˆ·è§¦å‘ | ç”¨æˆ·è¯·æ±‚ | æŸ¥è¯¢è®¾å¤‡å®æ—¶ç›‘æ§æ•°æ®åˆ—è¡¨ | æ¥æ”¶è®¾å¤‡å®æ—¶ç›‘æ§æŸ¥è¯¢ç­›é€‰æ¡ä»¶ | E | è®¾å¤‡å®æ—¶ç›‘æ§æŸ¥è¯¢ç­›é€‰å‚æ•° | è®¾å¤‡ç±»å‹ç­›é€‰ã€åœ°ç†ä½ç½®èŒƒå›´ã€ç›‘æ§æ—¶é—´æ®µã€æ•°æ®åˆ·æ–°é¢‘ç‡ |
|||| è¯»å–è®¾å¤‡å½“å‰è¿è¡ŒçŠ¶æ€å’Œå®æ—¶ä¼ æ„Ÿå™¨æ•°æ®æµ | R | è®¾å¤‡å®æ—¶è¿è¡ŒçŠ¶æ€æ•°æ®æµ | è®¾å¤‡IDã€å½“å‰è¿è¡Œæ¨¡å¼ã€å®æ—¶æ¸©åº¦ã€å®æ—¶å‹åŠ›ã€å®æ—¶é€Ÿåº¦ã€æ•°æ®é‡‡é›†æ—¶é—´æˆ³ |
|||| è®°å½•è®¾å¤‡å®æ—¶ç›‘æ§æŸ¥è¯¢è®¿é—®æ—¥å¿—å’Œç­›é€‰æ¡ä»¶ | W | è®¾å¤‡ç›‘æ§è®¿é—®å®¡è®¡æ—¥å¿— | æŸ¥è¯¢ç”¨æˆ·IDã€æŸ¥è¯¢æ—¶é—´æˆ³ã€ç­›é€‰æ¡ä»¶è¯¦æƒ…ã€æŸ¥è¯¢ç»“æœæ•°é‡ã€æ•°æ®åŠ è½½è€—æ—¶ |
|||| è¿”å›è®¾å¤‡å®æ—¶ç›‘æ§æ•°æ®åˆ—è¡¨å’Œå›¾è¡¨å¯è§†åŒ–é…ç½® | X | è®¾å¤‡å®æ—¶ç›‘æ§æ•°æ®å¯è§†åŒ–å“åº” | è®¾å¤‡åˆ—è¡¨ã€å®æ—¶æ•°æ®æ•°ç»„ã€å›¾è¡¨é…ç½®å‚æ•°ã€æ•°æ®åˆ·æ–°é—´éš”ã€å‘Šè­¦é˜ˆå€¼è®¾ç½® |
| ç”¨æˆ·è§¦å‘ | ç”¨æˆ·è¯·æ±‚ | å¯¼å‡ºè®¾å¤‡å†å²è¿è¡Œæ•°æ®æŠ¥è¡¨ | æ¥æ”¶è®¾å¤‡å†å²æ•°æ®å¯¼å‡ºä»»åŠ¡åˆ›å»ºæŒ‡ä»¤ | E | è®¾å¤‡å†å²æ•°æ®å¯¼å‡ºä»»åŠ¡å‚æ•° | è®¾å¤‡IDåˆ—è¡¨ã€å†å²æ—¶é—´èŒƒå›´ã€æ•°æ®ç»´åº¦é€‰æ‹©ã€å¯¼å‡ºæ–‡ä»¶æ ¼å¼ã€æŠ¥è¡¨æ¨¡æ¿é€‰æ‹© |
|||| è¯»å–è®¾å¤‡æŒ‡å®šæ—¶é—´æ®µçš„å†å²è¿è¡Œè®°å½•å’Œç»Ÿè®¡æŒ‡æ ‡ | R | è®¾å¤‡å†å²è¿è¡Œæ•°æ®å½’æ¡£åº“ | è®¾å¤‡IDã€è¿è¡Œæ—¥æœŸã€æ—¥å‡è¿è¡Œæ—¶é•¿ã€æ•…éšœæ¬¡æ•°ã€ç»´æŠ¤è®°å½•ã€æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡ |
|||| ç”Ÿæˆè®¾å¤‡å†å²æ•°æ®å¯¼å‡ºæ–‡ä»¶å¹¶ä¿å­˜å¯¼å‡ºä»»åŠ¡è®°å½• | W | è®¾å¤‡æ•°æ®å¯¼å‡ºä»»åŠ¡æ‰§è¡Œè®°å½• | å¯¼å‡ºä»»åŠ¡IDã€å¯¼å‡ºæ–‡ä»¶è·¯å¾„ã€æ–‡ä»¶å¤§å°ã€å¯¼å‡ºæ•°æ®è¡Œæ•°ã€å¯¼å‡ºå¼€å§‹æ—¶é—´ã€å¯¼å‡ºå®Œæˆæ—¶é—´ã€å¯¼å‡ºæ“ä½œäºº |
|||| è¿”å›è®¾å¤‡å†å²æ•°æ®æŠ¥è¡¨ä¸‹è½½é“¾æ¥å’Œæ–‡ä»¶å…ƒä¿¡æ¯ | X | è®¾å¤‡æ•°æ®æŠ¥è¡¨ä¸‹è½½å‡­è¯ | å¯¼å‡ºä»»åŠ¡IDã€æ–‡ä»¶ä¸‹è½½URLã€æ–‡ä»¶æœ‰æ•ˆæœŸã€æ–‡ä»¶æ ¼å¼ã€æ–‡ä»¶å¤§å°ã€æ•°æ®è®°å½•æ•°ã€ç”Ÿæˆæ—¶é—´ |

## æ ¸å¿ƒè¦æ±‚ï¼š
      1. ** æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰Eã€Rã€Wã€Xå››ç§ç±»å‹ï¼Œç¼ºä¸€ä¸å¯ï¼**
        2. ** ç»å¯¹ç¦æ­¢ ** åªè¾“å‡ºEè¡Œè€Œæ²¡æœ‰åç»­Rã€Wã€Xè¡Œçš„æƒ…å†µï¼
      3. ** åŠŸèƒ½è¿‡ç¨‹åç§°åªåœ¨Eè¡Œå¡«å†™ **ï¼Œåç»­R / W / Xè¡Œçš„åŠŸèƒ½è¿‡ç¨‹åˆ—ç•™ç©º
      4. ** ä¸èƒ½ä¸å·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹é‡å¤æˆ–é«˜åº¦ç›¸ä¼¼ **
        5. ** æ¯ä¸ªæ–°åŠŸèƒ½è¿‡ç¨‹éƒ½å¿…é¡»åœ¨ä¸šåŠ¡åœºæ™¯ã€æè¿°æ¨¡å¼ã€æ•°æ®ç»„åˆä¸Šä¸å·²æœ‰åŠŸèƒ½æœ‰æ˜æ˜¾å·®å¼‚ **

          è¯·ç»§ç»­æ‹†åˆ†å°šæœªå¤„ç†çš„åŠŸèƒ½ï¼Œ** åªè¾“å‡ºæ•°æ®è¡¨æ ¼ **ã€‚
      å¦‚æœæ‰€æœ‰åŠŸèƒ½éƒ½å·²å®Œæˆï¼Œå›å¤"[ALL_DONE]"ã€‚`;
    }

    const systemMessage = {
      role: 'system',
      content: COSMIC_SYSTEM_PROMPT
    };

    console.log(`è´¨é‡ä¼˜å…ˆ - ç¬¬ ${round} è½®åˆ†æå¼€å§‹ï¼Œå·²å®Œæˆ ${uniqueCompleted.length} ä¸ªåŠŸèƒ½è¿‡ç¨‹...`);

    const completion = await callAIChat({
      messages: [
        systemMessage,
        { role: 'user', content: userPrompt }
      ],
      temperature: 0.5
    });


    const reply = completion.choices[0].message.content;
    console.log(`è´¨é‡ä¼˜å…ˆ - ç¬¬ ${round} è½®å®Œæˆï¼Œå“åº”é•¿åº¦: ${reply.length}`);

    // æ”¹è¿›çš„å®Œæˆåˆ¤æ–­é€»è¾‘ - æ›´ä¿å®ˆï¼Œé¿å…æå‰ç»ˆæ­¢
    let isDone = false;

    // ç»Ÿè®¡å·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹æ•°é‡
    const estimatedTarget = understanding?.totalEstimatedFunctions || targetFunctions || 30;

    // 1. æ£€æŸ¥å›å¤ä¸­æ˜¯å¦æœ‰æœ‰æ•ˆçš„è¡¨æ ¼æ•°æ®
    const hasValidTable = reply.includes('|') && (reply.includes('|E|') || reply.includes('| E |') || reply.match(/\|[^|]*\|[^|]*\|[^|]*\|[^|]*\|E\|/));

    // 2. æ˜ç¡®çš„å®Œæˆæ ‡è®°ï¼ˆå¿…é¡»åŒæ—¶æ»¡è¶³ï¼šæœ‰å®Œæˆæ ‡è®° ä¸” è¾¾åˆ°ç›®æ ‡æ•°é‡ï¼‰
    const hasCompleteMarker = reply.includes('[ALL_DONE]') ||
      reply.includes('å·²å®Œæˆæ‰€æœ‰') ||
      reply.includes('å…¨éƒ¨æ‹†åˆ†å®Œæˆ') ||
      reply.includes('æ— éœ€è¡¥å……');
    const reachedTarget = uniqueCompleted.length >= estimatedTarget;

    if (hasCompleteMarker && reachedTarget) {
      isDone = true;
      console.log(`è´¨é‡ä¼˜å…ˆ - æ£€æµ‹åˆ°å®Œæˆæ ‡è®°ä¸”å·²è¾¾åˆ°ç›®æ ‡æ•°é‡: ${uniqueCompleted.length} / ${estimatedTarget}`);
    }

    // 3. å¦‚æœå›å¤ä¸­æ²¡æœ‰æœ‰æ•ˆè¡¨æ ¼ä¸”ä¸æ˜¯ç¬¬ä¸€è½®ä¸”å·²è¾¾åˆ°ç›®æ ‡ï¼Œè®¤ä¸ºå®Œæˆ
    if (!hasValidTable && round > 1 && reachedTarget) {
      isDone = true;
      console.log(`è´¨é‡ä¼˜å…ˆ - æ— æœ‰æ•ˆè¡¨æ ¼ä¸”å·²è¾¾ç›®æ ‡: ${uniqueCompleted.length} / ${estimatedTarget}`);
    }

    // 4. å¦‚æœå›å¤å†…å®¹è¿‡çŸ­ï¼ˆå°‘äº100å­—ç¬¦ï¼‰ä¸”ä¸æ˜¯ç¬¬ä¸€è½®ä¸”å·²è¾¾åˆ°ç›®æ ‡
    if (reply.length < 100 && round > 1 && reachedTarget) {
      isDone = true;
      console.log(`è´¨é‡ä¼˜å…ˆ - å›å¤è¿‡çŸ­ä¸”å·²è¾¾ç›®æ ‡: ${uniqueCompleted.length} / ${estimatedTarget}`);
    }

    // 5. å¦‚æœè½®æ¬¡è¿‡å¤šï¼ˆè¶…è¿‡10è½®ï¼‰ï¼Œå¼ºåˆ¶åœæ­¢
    if (round >= 10) {
      isDone = true;
      console.log(`è´¨é‡ä¼˜å…ˆ - è½®æ¬¡è¾¾åˆ°ä¸Šé™(10è½®)ï¼Œå½“å‰${uniqueCompleted.length} / ${estimatedTarget}`);
    }

    // 6. å¦‚æœè¿˜æ²¡è¾¾åˆ°ç›®æ ‡æ•°é‡ï¼Œä¸è¦æå‰ç»ˆæ­¢
    if (!reachedTarget && hasValidTable) {
      isDone = false;
      console.log(`è´¨é‡ä¼˜å…ˆ - ç»§ç»­æ‹†åˆ†ï¼Œå½“å‰${uniqueCompleted.length} / ${estimatedTarget}ï¼Œæœ¬è½®æœ‰æ–°æ•°æ®`);
    }

    res.json({
      success: true,
      reply: reply,
      round: round,
      isDone: isDone,
      completedFunctions: uniqueCompleted.length,
      targetFunctions: estimatedTarget
    });
  } catch (error) {
    console.error('è´¨é‡ä¼˜å…ˆåˆ†æå¤±è´¥:', error);
    res.status(500).json({ error: 'åˆ†æå¤±è´¥: ' + error.message });
  }
});

// ========== è´¨é‡ä¼˜å…ˆæ™ºèƒ½æ‹†åˆ† APIï¼ˆä¸‰é˜¶æ®µæµç¨‹ï¼Œå·²å¼ƒç”¨ï¼‰ ==========
// å…ˆæ·±åº¦ç†è§£æ–‡æ¡£ï¼Œç¡®ä¿æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹çš„è´¨é‡ï¼Œå†é€æ­¥æ‰©å±•æ•°é‡
const QUALITY_FIRST_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªé¡¶çº§COSMICåŠŸèƒ½ç‚¹åˆ†æä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ·±åº¦ç†è§£éœ€æ±‚æ–‡æ¡£ï¼Œè¯†åˆ«å¹¶æ‹†åˆ†é«˜è´¨é‡çš„åŠŸèƒ½è¿‡ç¨‹ï¼Œè¶…è¶Šä¼ ç»Ÿçš„CRUDæ€ç»´ï¼Œå®ç°"ç«‹ä½“åŒ–"å»ºæ¨¡ã€‚

## 1. æ ¸å¿ƒåŸåˆ™ï¼šè´¨é‡ä¸ç»´åº¦
- ** ç«‹ä½“å»ºæ¨¡ **ï¼šä¸ä»…å…³æ³¨æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼ˆæµç¨‹è½´ï¼‰ï¼Œè¿˜è¦æŒ–æ˜éšè—çš„ç®¡ç†åº•åº§ï¼ˆå®¡è®¡ã€æ—¥å¿—ã€æƒé™ã€å­—å…¸åŒ¹é…ï¼‰ã€‚
- ** ERWX åŸå­åŒ– **ï¼šæ¯ä¸€ä¸ªè¿‡ç¨‹å¿…é¡»ç¬¦åˆã€é—¨å«Entryã€å¤§è„‘Readã€æ‰§è¡ŒWriteã€åé¦ˆExitã€‘çš„èŒè´£åˆ’åˆ†ã€‚
- ** é¢—ç²’åº¦æ‹†è§£ **ï¼šå¯¹äºå¤§å‹æ¥å£ï¼Œå°†å…¶åˆ‡ç‰‡ä¸ºæ”¯æ’‘ç»†ç²’åº¦å­—æ®µçš„åŠŸèƒ½è¿‡ç¨‹ã€‚

## 2. COSMICæ•°æ®ç§»åŠ¨ç±»å‹(ERWX æ¨¡å‹)
- ** E(Entry / é—¨å«) **: è·¨è¶Šè¾¹ç•Œï¼Œè§£æåè®®å¤´ï¼Œæ ¡éªŒèº«ä»½ï¼Œæ¥æ”¶æŒ‡ä»¤å‚æ•°é›†ã€‚
- ** R(Read / å¤§è„‘) **: æ£€ç´¢ä¸šåŠ¡å­—å…¸ï¼ŒæŸ¥é˜…å†å²çŠ¶æ€ï¼Œå¯¹é½é…ç½®è§„åˆ™ã€‚
- ** W(Write / æ‰§è¡Œ) **: åŸå­åŒ–å†™å…¥ä¸šåŠ¡è¡¨ï¼ŒæŒä¹…åŒ–äº‹åŠ¡æµæ°´ï¼Œè®°å½•å®¡è®¡æ—¥å¿—ã€‚
- ** X(eXit / åé¦ˆ) **: å°è£…å“åº”åè®®ä½“ï¼Œæ˜ å°„å¤šçº§åŠ¨ä½œå›æ˜¾ï¼Œè®°å½•æ¥å£è€—æ—¶ã€‚

## 3. åŠŸèƒ½ç‚¹è¯†åˆ«ä¸æŸ¥é‡
- ** å‘½åå…¬å¼ **ï¼š[æ ¸å¿ƒå¯¹è±¡] + [æ·±åº¦åŠ¨ä½œ] + [æµæ°´çŠ¶æ€]ã€‚
- ** äº’æ–¥å»é‡ **ï¼šä¸åŒåŠŸèƒ½çš„å­è¿‡ç¨‹æè¿°å’Œå­—æ®µç»„åˆå¿…é¡»å…·å¤‡ç‰©ç†å±‚é¢çš„æ˜¾è‘—å·®å¼‚ï¼Œä¸¥ç¦é›·åŒã€‚

  è¯·ä¸¥æ ¼æŒ‰ç…§æä¾›çš„Markdownè¡¨æ ¼æ ¼å¼è¾“å‡ºã€‚`;

// è´¨é‡ä¼˜å…ˆåˆ†æ - ç¬¬ä¸€é˜¶æ®µï¼šæ·±åº¦ç†è§£æ–‡æ¡£ï¼ˆå¢å¼ºç‰ˆ - ç¡®ä¿åŠŸèƒ½ç‚¹å®Œæ•´è¦†ç›–ï¼‰
app.post('/api/quality-analyze/understand', async (req, res) => {
  try {
    const { documentContent, imageDescriptions = [], userGuidelines = '' } = req.body;

    console.log('è´¨é‡ä¼˜å…ˆåˆ†æ - ç¬¬ä¸€é˜¶æ®µï¼šæ·±åº¦ç†è§£æ–‡æ¡£ï¼ˆå¢å¼ºç‰ˆï¼‰...', userGuidelines ? `ç”¨æˆ·æŒ‡å¯¼ï¼š${userGuidelines}` : '');


    // æ„å»ºå›¾ç‰‡æè¿°ä¸Šä¸‹æ–‡
    let imageContext = '';
    if (imageDescriptions && imageDescriptions.length > 0) {
      imageContext = `\n\næ–‡æ¡£ä¸­çš„å›¾ç‰‡ / ç•Œé¢æˆªå›¾æè¿°ï¼š\n${imageDescriptions.map((desc, i) => `å›¾${i + 1}: ${desc}`).join('\n')}\n\n ** è¯·ç‰¹åˆ«æ³¨æ„ï¼šå›¾ç‰‡ä¸­å±•ç¤ºçš„ç•Œé¢å…ƒç´ ã€æŒ‰é’®ã€èœå•ã€è¡¨æ ¼ç­‰éƒ½å¯èƒ½ä»£è¡¨ç‹¬ç«‹çš„åŠŸèƒ½ç‚¹ï¼Œå¿…é¡»è¯†åˆ«å¹¶åŒ…å«åœ¨åŠŸèƒ½åˆ—è¡¨ä¸­ï¼**\n`;
    }

    // æ„å»ºç”¨æˆ·æŒ‡å¯¼æŒ‡å¯¼ä¸Šä¸‹æ–‡
    let guidelinesContext = '';
    if (userGuidelines) {
      guidelinesContext = `\n\n## ç”¨æˆ·ç‰¹å®šçš„æ‹†åˆ†è¦æ±‚ï¼ˆè¯·åŠ¡å¿…ä¸¥æ ¼éµå®ˆï¼‰ï¼š\n**${userGuidelines}**\n`;
    }

    const understandPrompt = `ä½ æ˜¯ä¸€ä¸ªé¡¶çº§ä¸šåŠ¡æ¶æ„å¸ˆä¸COSMICåˆ†æä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹éœ€æ±‚æ–‡æ¡£è¿›è¡Œ"ç«‹ä½“åŒ–"æ·±åº¦åˆ†æï¼Œè¿ç”¨Geminiå››é˜¶æ®µæ–¹æ³•è®ºä¸­çš„ç¬¬ä¸€é˜¶æ®µï¼ˆæ–‡æ¡£è§£è€¦ï¼‰å’Œç¬¬äºŒé˜¶æ®µï¼ˆè¿‡ç¨‹è†¨èƒ€ï¼‰ã€‚
${guidelinesContext}
${documentContent}
${imageContext}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¬¬ä¸€é˜¶æ®µï¼šæ–‡æ¡£è§£è€¦ï¼ˆDocument Decouplingï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ä»»åŠ¡1ï¼šè¯†åˆ«è¾¹ç•Œäº¤äº’è€…ï¼ˆåŠŸèƒ½ç”¨æˆ·ï¼‰
æ— è§†ä¸šåŠ¡é€»è¾‘ï¼Œåªæ‰¾ã€Œè¾¹ç•Œäº¤äº’è€…ã€ï¼š
- **ç”¨æˆ·è§¦å‘**ï¼šäººå·¥æ“ä½œã€ç•Œé¢ç‚¹å‡»ã€æ‰‹åŠ¨è¾“å…¥çš„åŠŸèƒ½
- **æ—¶é’Ÿè§¦å‘**ï¼šå®šæ—¶ä»»åŠ¡ã€å‘¨æœŸæ‰§è¡Œã€è‡ªåŠ¨è°ƒåº¦çš„åŠŸèƒ½
- **æ¥å£è§¦å‘**ï¼šå¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ã€APIæ¨é€ã€æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½

## ä»»åŠ¡2ï¼šæå–æ•°æ®å¯¹è±¡ï¼ˆObject of Interestï¼‰
æ‰¾å‡ºæ–‡æ¡£ä¸­æ‰€æœ‰å…·æœ‰ç‹¬ç«‹çŠ¶æ€æˆ–å±æ€§é›†åˆçš„åè¯å®ä½“ï¼š
- ä¸šåŠ¡å®ä½“ï¼šå·¥å•ã€ç”¨æˆ·ã€è®¾å¤‡ã€ä»»åŠ¡ã€è®¢å•ã€é…ç½®é¡¹ç­‰
- ä¸ºæ¯ä¸ªå®ä½“å»ºç«‹**å­—æ®µæ± **ï¼ŒåŒ…å«è¯¥å®ä½“çš„æ‰€æœ‰å¯èƒ½å±æ€§

## ä»»åŠ¡3ï¼šè¯†åˆ«è§¦å‘äº‹ä»¶
ä¸ºæ¯ä¸ªåŠŸèƒ½ç¡®å®šå…¶å¯åŠ¨å¼€å…³ï¼šç‚¹å‡»æŒ‰é’®ã€è°ƒç”¨æ¥å£ã€å®šæ—¶å™¨åˆ°æœŸã€æ¶ˆæ¯åˆ°è¾¾ç­‰

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç¬¬äºŒé˜¶æ®µï¼šè¿‡ç¨‹è†¨èƒ€ä¸ç»´åº¦æ‰©å±•ï¼ˆProcess Expansionï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## 3Dè½´å‘åˆ†ææ¡†æ¶

### çºµå‘ï¼ˆæµç¨‹è½´ï¼‰- ç”Ÿå‘½å‘¨æœŸå…¨è·¯å¾„æ‹†è§£
å¯¹æ¯ä¸ªåŠŸèƒ½æ¨å¯¼å…¶å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä¸è¦åªçœ‹"æ‰§è¡Œ"ï¼š
1. **é¢„å®¡å‡†å…¥**ï¼šå‚æ•°æ ¡éªŒã€èº«ä»½é‰´æƒã€æ ¼å¼éªŒè¯ã€å‰ç½®æ¡ä»¶æ£€æŸ¥
2. **ä¸»ä½“æ‰§è¡Œ**ï¼šæ ¸å¿ƒæ•°æ®å¤„ç†ã€ä¸šåŠ¡é€»è¾‘è¿ç®—ã€çŠ¶æ€è½¬æ¢
3. **å¼‚æ­¥åé¦ˆ**ï¼šç»“æœé€šçŸ¥ã€å›è°ƒåŒæ­¥ã€æ¶ˆæ¯æ¨é€ã€äº‹ä»¶å‘å¸ƒ
4. **å®¡è®¡è¿½è¸ª**ï¼šæ“ä½œæ—¥å¿—ã€å¿«ç…§å¤‡ä»½ã€ç‰ˆæœ¬è®°å½•

### æ¨ªå‘ï¼ˆç®¡ç†è½´ï¼‰- ä¸“é¡¹ç®¡ç†ç»´åº¦æ‹†è§£
1. **å½’å› ç»´åº¦**ï¼šè¿½æº¯æ¥æºã€è®°å½•è·¯å¾„
2. **èµ„äº§ç»´åº¦**ï¼šå˜æ›´çŠ¶æ€ã€é”å®šèµ„æº
3. **æ•ˆèƒ½ç»´åº¦**ï¼šæŒ‡æ ‡é‡‡é›†ã€æ•°æ®æ±‡æ€»
4. **åˆè§„ç»´åº¦**ï¼šæ“ä½œå®¡è®¡ã€æ•°æ®è„±æ•

## è¯·è¾“å‡ºä»¥ä¸‹JSONæ ¼å¼çš„åˆ†ææŠ¥å‘Šï¼ˆä¸¥ç¦è¾“å‡ºä»»ä½•å¤šä½™æ–‡å­—ï¼‰ï¼š
{
  "projectName": "é¡¹ç›®åç§°",
  "projectDescription": "é¡¹ç›®æ ¸å¿ƒç›®æ ‡ç®€è¿°",
  "systemArchitecture": "ç³»ç»Ÿç±»å‹ï¼ˆå¦‚ï¼šå¾®æœåŠ¡ã€å•ä½“ã€åµŒå…¥å¼ï¼‰",
  "systemBoundary": "ç³»ç»Ÿçš„å¤–éƒ¨è¾¹ç•Œè¯´æ˜",
  "userRoles": ["è§’è‰²1", "è§’è‰²2"],
  "dataEntities": ["å®ä½“1", "å®ä½“2"],
  "externalInterfaces": ["å¤–éƒ¨æ¥å£1", "å¤–éƒ¨æ¥å£2"],
  "functionBreakdown": {
     "userTriggeredFunctions": 0,
     "timerTriggeredFunctions": 0,
     "interfaceTriggeredFunctions": 0
  },
  "coreModules": [
    {
      "moduleName": "æ¨¡å—åç§°",
      "estimatedFunctions": [
        {
            }
          ]
        }
      ],
        "timedTasks": [
          {
            "taskName": "å®šæ—¶ä»»åŠ¡åç§°",
            "schedule": "æ‰§è¡Œé¢‘ç‡",
            "description": "ä»»åŠ¡æè¿°"
          }
        ],
          "crossModuleFunctions": [
            {
              "functionName": "è·¨æ¨¡å—åŠŸèƒ½åç§°",
              "triggerType": "è§¦å‘ç±»å‹",
              "relatedModules": ["æ¨¡å—1", "æ¨¡å—2"]
            }
          ],
            "functionBreakdown": {
        "userTriggeredFunctions": 0,
          "timerTriggeredFunctions": 0,
            "interfaceTriggeredFunctions": 0
      },
      "totalEstimatedFunctions": 30
    }

** å…³é”®è¦æ±‚ **ï¼š
    1. fieldPoolå¿…é¡»å…¨é¢ï¼ŒåŒ…å«æ–‡æ¡£ä¸­æ‰€æœ‰å¯èƒ½çš„å­—æ®µ
    2. æ¯ä¸ªåŠŸèƒ½å¿…é¡»æŒ‡å®šanchorFieldï¼ˆé”šå®šå­—æ®µï¼‰
    3. suggestedAttributesè¦ä½“ç°å­—æ®µç»„åˆçš„äº’æ–¥æ€§
    4. åŠŸèƒ½åç§°å¿…é¡»ç¬¦åˆObject + Action + Stateæ ¼å¼
    5. å¿…é¡»åŒºåˆ†ä¸‰ç§è§¦å‘ç±»å‹ï¼Œå¹¶ç»Ÿè®¡æ•°é‡`;

    const completion = await callAIChat({
      messages: [
        { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªéœ€æ±‚åˆ†æä¸“å®¶ï¼Œæ“…é•¿ä»éœ€æ±‚æ–‡æ¡£ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯ã€‚è¯·åªè¾“å‡ºJSONæ ¼å¼ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ã€‚' },
        { role: 'user', content: understandPrompt }
      ],
      temperature: 0.3,
      max_tokens: 4000
    });


    let analysisResult;
    try {
      const content = completion.choices[0].message.content;
      // æå–JSONéƒ¨åˆ†
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        analysisResult = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error('æœªæ‰¾åˆ°JSONæ ¼å¼');
      }
    } catch (e) {
      console.error('è§£æç†è§£ç»“æœå¤±è´¥:', e);
      analysisResult = {
        projectName: 'æœªçŸ¥é¡¹ç›®',
        projectDescription: 'æ–‡æ¡£åˆ†æä¸­',
        systemBoundary: 'å¾…ç¡®å®š',
        userRoles: ['ç”¨æˆ·'],
        coreModules: [{ moduleName: 'æ ¸å¿ƒæ¨¡å—', moduleDescription: 'ä¸»è¦åŠŸèƒ½', estimatedFunctions: [] }],
        dataEntities: [],
        externalInterfaces: [],
        totalEstimatedFunctions: 30
      };
    }

    console.log('æ–‡æ¡£ç†è§£å®Œæˆ:', analysisResult.projectName, 'é¢„ä¼°åŠŸèƒ½æ•°:', analysisResult.totalEstimatedFunctions);

    res.json({
      success: true,
      understanding: analysisResult,
      message: `å·²æ·±åº¦ç†è§£æ–‡æ¡£ï¼Œè¯†åˆ«åˆ° ${analysisResult.coreModules?.length || 0} ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œé¢„ä¼° ${analysisResult.totalEstimatedFunctions || 30} ä¸ªåŠŸèƒ½è¿‡ç¨‹`
    });
  } catch (error) {
    console.error('æ–‡æ¡£ç†è§£å¤±è´¥:', error);
    res.status(500).json({ error: 'æ–‡æ¡£ç†è§£å¤±è´¥: ' + error.message });
  }
});

// è´¨é‡ä¼˜å…ˆåˆ†æ - ç¬¬äºŒé˜¶æ®µï¼šæŒ‰æ¨¡å—é€æ­¥æ‹†åˆ†
app.post('/api/quality-analyze/split', async (req, res) => {
  try {
    const { documentContent, understanding, moduleIndex = 0, previousResults = [] } = req.body;

    const modules = understanding?.coreModules || [];

    if (moduleIndex >= modules.length) {
      return res.json({
        success: true,
        isDone: true,
        message: 'æ‰€æœ‰æ¨¡å—å·²åˆ†æå®Œæˆ'
      });
    }

    const currentModule = modules[moduleIndex];
    console.log(`è´¨é‡ä¼˜å…ˆåˆ†æ - ç¬¬äºŒé˜¶æ®µï¼šæ‹†åˆ†æ¨¡å— ${moduleIndex + 1}/${modules.length}: ${currentModule.moduleName}`);

    // æ„å»ºå·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹åˆ—è¡¨
    const completedFunctions = previousResults.map(r => r.functionalProcess).filter(Boolean);
    const uniqueCompleted = [...new Set(completedFunctions)];

    const splitPrompt = `åŸºäºä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ï¼Œå¯¹"${currentModule.moduleName}"æ¨¡å—è¿›è¡ŒCOSMICåŠŸèƒ½è¿‡ç¨‹æ‹†åˆ†ã€‚

## æ–‡æ¡£å†…å®¹
${documentContent}

## å½“å‰æ¨¡å—ä¿¡æ¯
- æ¨¡å—åç§°ï¼š${currentModule.moduleName}
- æ¨¡å—æè¿°ï¼š${currentModule.moduleDescription}
- é¢„æœŸåŠŸèƒ½ï¼š${currentModule.estimatedFunctions?.join('ã€') || 'å¾…è¯†åˆ«'}

## é¡¹ç›®èƒŒæ™¯
- é¡¹ç›®åç§°ï¼š${understanding.projectName}
- ç”¨æˆ·è§’è‰²ï¼š${understanding.userRoles?.join('ã€') || 'ç”¨æˆ·'}
- æ•°æ®å®ä½“ï¼š${understanding.dataEntities?.join('ã€') || 'å¾…è¯†åˆ«'}

${uniqueCompleted.length > 0 ? `## å·²å®Œæˆçš„åŠŸèƒ½è¿‡ç¨‹ï¼ˆè¯·å‹¿é‡å¤ï¼‰\n${uniqueCompleted.join('ã€')}` : ''}

## è¾“å‡ºè¦æ±‚
1. åªæ‹†åˆ†"${currentModule.moduleName}"æ¨¡å—ç›¸å…³çš„åŠŸèƒ½è¿‡ç¨‹
2. æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»å®Œæ•´ï¼ˆEâ†’R/Wâ†’Xï¼‰
3. åŠŸèƒ½è¿‡ç¨‹åç§°å¿…é¡»å”¯ä¸€ä¸”å…·ä½“
4. æ•°æ®ç»„å’Œæ•°æ®å±æ€§å¿…é¡»ä¸ä¸šåŠ¡åœºæ™¯ç›¸å…³

è¯·è¾“å‡ºMarkdownè¡¨æ ¼æ ¼å¼ï¼š

|åŠŸèƒ½ç”¨æˆ·|è§¦å‘äº‹ä»¶|åŠŸèƒ½è¿‡ç¨‹|å­è¿‡ç¨‹æè¿°|æ•°æ®ç§»åŠ¨ç±»å‹|æ•°æ®ç»„|æ•°æ®å±æ€§|`;

    const completion = await callAIChat({
      messages: [
        { role: 'system', content: QUALITY_FIRST_SYSTEM_PROMPT },
        { role: 'user', content: splitPrompt }
      ],
      temperature: 0.5
    });


    const reply = completion.choices[0].message.content;
    console.log(`æ¨¡å— ${currentModule.moduleName} æ‹†åˆ†å®Œæˆï¼Œå“åº”é•¿åº¦: ${reply.length}`);

    res.json({
      success: true,
      reply: reply,
      moduleIndex: moduleIndex,
      moduleName: currentModule.moduleName,
      totalModules: modules.length,
      isDone: moduleIndex >= modules.length - 1,
      message: `æ¨¡å— ${moduleIndex + 1}/${modules.length} "${currentModule.moduleName}" æ‹†åˆ†å®Œæˆ`
    });
  } catch (error) {
    console.error('æ¨¡å—æ‹†åˆ†å¤±è´¥:', error);
    res.status(500).json({ error: 'æ¨¡å—æ‹†åˆ†å¤±è´¥: ' + error.message });
  }
});

// è´¨é‡ä¼˜å…ˆåˆ†æ - ç¬¬ä¸‰é˜¶æ®µï¼šè´¨é‡å®¡æŸ¥ä¸è¡¥å……
app.post('/api/quality-analyze/review', async (req, res) => {
  try {
    const { documentContent, understanding, tableData } = req.body;

    console.log('è´¨é‡ä¼˜å…ˆåˆ†æ - ç¬¬ä¸‰é˜¶æ®µï¼šè´¨é‡å®¡æŸ¥...');


    // ç»Ÿè®¡å½“å‰åŠŸèƒ½è¿‡ç¨‹
    const uniqueFunctions = [...new Set(tableData.map(r => r.functionalProcess).filter(Boolean))];
    const expectedCount = understanding?.totalEstimatedFunctions || 30;

    const reviewPrompt = `è¯·å®¡æŸ¥ä»¥ä¸‹COSMICæ‹†åˆ†ç»“æœï¼Œå¹¶è¡¥å……é—æ¼çš„åŠŸèƒ½è¿‡ç¨‹ã€‚

## åŸå§‹æ–‡æ¡£
${documentContent.substring(0, 3000)}${documentContent.length > 3000 ? '...(æ–‡æ¡£å·²æˆªæ–­)' : ''}

## é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®åç§°ï¼š${understanding?.projectName || 'æœªçŸ¥'}
- é¢„ä¼°åŠŸèƒ½æ•°ï¼š${expectedCount}
- å½“å‰å·²æ‹†åˆ†ï¼š${uniqueFunctions.length} ä¸ªåŠŸèƒ½è¿‡ç¨‹

## å·²æ‹†åˆ†çš„åŠŸèƒ½è¿‡ç¨‹
${uniqueFunctions.join('ã€')}

## å®¡æŸ¥ä»»åŠ¡
1. æ£€æŸ¥æ˜¯å¦æœ‰é—æ¼çš„é‡è¦åŠŸèƒ½è¿‡ç¨‹
2. å¦‚æœå½“å‰æ•°é‡(${uniqueFunctions.length})æ˜æ˜¾å°‘äºé¢„ä¼°(${expectedCount})ï¼Œè¯·è¡¥å……é—æ¼çš„åŠŸèƒ½
3. è¡¥å……çš„åŠŸèƒ½è¿‡ç¨‹å¿…é¡»æ˜¯æ–‡æ¡£ä¸­æ˜ç¡®æè¿°æˆ–åˆç†æ¨æ–­çš„

${uniqueFunctions.length < expectedCount * 0.7 ? `
## éœ€è¦è¡¥å……
å½“å‰åŠŸèƒ½è¿‡ç¨‹æ•°é‡åå°‘ï¼Œè¯·ä»ä»¥ä¸‹è§’åº¦è¡¥å……ï¼š
- æŸ¥è¯¢ç±»åŠŸèƒ½ï¼ˆåˆ—è¡¨æŸ¥è¯¢ã€è¯¦æƒ…æŸ¥è¯¢ã€æ¡ä»¶æœç´¢ï¼‰
- ç®¡ç†ç±»åŠŸèƒ½ï¼ˆæ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ã€å®¡æ‰¹ï¼‰
- ç»Ÿè®¡ç±»åŠŸèƒ½ï¼ˆæ•°æ®ç»Ÿè®¡ã€æŠ¥è¡¨ç”Ÿæˆã€è¶‹åŠ¿åˆ†æï¼‰
- å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
- ç³»ç»Ÿé…ç½®åŠŸèƒ½
` : ''}

è¯·è¾“å‡ºéœ€è¦è¡¥å……çš„åŠŸèƒ½è¿‡ç¨‹ï¼ˆMarkdownè¡¨æ ¼æ ¼å¼ï¼‰ï¼Œå¦‚æœæ— éœ€è¡¥å……è¯·å›å¤"[REVIEW_DONE]"ã€‚`;

    const completion = await callAIChat({
      messages: [
        { role: 'system', content: QUALITY_FIRST_SYSTEM_PROMPT },
        { role: 'user', content: reviewPrompt }
      ],
      temperature: 0.5
    });


    const reply = completion.choices[0].message.content;
    const isDone = reply.includes('[REVIEW_DONE]') || reply.includes('æ— éœ€è¡¥å……') || reply.includes('å·²å®Œæ•´');

    console.log('è´¨é‡å®¡æŸ¥å®Œæˆï¼Œæ˜¯å¦éœ€è¦è¡¥å……:', !isDone);

    res.json({
      success: true,
      reply: reply,
      isDone: isDone,
      currentCount: uniqueFunctions.length,
      expectedCount: expectedCount,
      message: isDone ? 'è´¨é‡å®¡æŸ¥é€šè¿‡ï¼Œæ— éœ€è¡¥å……' : 'å‘ç°é—æ¼åŠŸèƒ½ï¼Œæ­£åœ¨è¡¥å……'
    });
  } catch (error) {
    console.error('è´¨é‡å®¡æŸ¥å¤±è´¥:', error);
    res.status(500).json({ error: 'è´¨é‡å®¡æŸ¥å¤±è´¥: ' + error.message });
  }
});

// ========== ä¸‰å±‚åˆ†ææ¡†æ¶æ¨¡å¼ APIï¼ˆä½¿ç”¨æ™ºè°±APIï¼‰ ==========
app.post('/api/three-layer-analyze', (req, res) => {
  threeLayerAnalyze(req, res, getOpenAIClient);
});

// ========== ä¸¤é˜¶æ®µåŠ¨æ€é©±åŠ¨åˆ†æ API ==========
// é˜¶æ®µ1ï¼šæå–åŠŸèƒ½æ¸…å•ï¼ˆè®©ç”¨æˆ·ç¡®è®¤ã€ä¿®æ”¹ã€è¡¥å……ï¼‰
app.post('/api/extract-function-list', (req, res) => {
  extractFunctionList(req, res);
});

// é˜¶æ®µ2ï¼šåŸºäºç¡®è®¤çš„åŠŸèƒ½æ¸…å•è¿›è¡ŒERWXæ‹†åˆ†
app.post('/api/split-from-function-list', (req, res) => {
  splitFromFunctionList(req, res);
});

// å¯¼å‡ºExcel
app.post('/api/export-excel', async (req, res) => {
  try {
    const { tableData, filename } = req.body;

    if (!tableData || !Array.isArray(tableData) || tableData.length === 0) {
      return res.status(400).json({ error: 'æ— æœ‰æ•ˆæ•°æ®å¯å¯¼å‡º' });
    }

    // ========== é¢„å¤„ç†ï¼šè‡ªåŠ¨å¡«å……ç©ºç™½æ ¼ ==========
    // å°†åŠŸèƒ½ç”¨æˆ·ã€è§¦å‘äº‹ä»¶ã€åŠŸèƒ½è¿‡ç¨‹å‘ä¸‹å¡«å……åˆ°ç©ºç™½è¡Œ
    const filledTableData = fillEmptyCells(tableData);

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Cosmicæ‹†åˆ†ç»“æœ');

    // è®¾ç½®åˆ—
    worksheet.columns = [
      { header: 'åŠŸèƒ½ç”¨æˆ·', key: 'functionalUser', width: 25 },
      { header: 'è§¦å‘äº‹ä»¶', key: 'triggerEvent', width: 15 },
      { header: 'åŠŸèƒ½è¿‡ç¨‹', key: 'functionalProcess', width: 30 },
      { header: 'å­è¿‡ç¨‹æè¿°', key: 'subProcessDesc', width: 35 },
      { header: 'æ•°æ®ç§»åŠ¨ç±»å‹', key: 'dataMovementType', width: 15 },
      { header: 'æ•°æ®ç»„', key: 'dataGroup', width: 25 },
      { header: 'æ•°æ®å±æ€§', key: 'dataAttributes', width: 50 }
    ];

    // è®¾ç½®è¡¨å¤´æ ·å¼
    const headerRow = worksheet.getRow(1);
    headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
    headerRow.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FF4472C4' }
    };
    headerRow.alignment = { vertical: 'middle', horizontal: 'center' };
    headerRow.height = 25;

    // æ·»åŠ æ•°æ®
    filledTableData.forEach((row, index) => {
      const dataRow = worksheet.addRow({
        functionalUser: row.functionalUser || '',
        triggerEvent: row.triggerEvent || '',
        functionalProcess: row.functionalProcess || '',
        subProcessDesc: row.subProcessDesc || '',
        dataMovementType: row.dataMovementType || '',
        dataGroup: row.dataGroup || '',
        dataAttributes: row.dataAttributes || ''
      });

      // äº¤æ›¿è¡Œé¢œè‰²
      if (index % 2 === 1) {
        dataRow.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FFF2F2F2' }
        };
      }

      dataRow.alignment = { vertical: 'middle', wrapText: true };
    });

    // æ·»åŠ è¾¹æ¡†
    worksheet.eachRow((row, rowNumber) => {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        };
      });
    });

    // ç”Ÿæˆæ–‡ä»¶
    const buffer = await workbook.xlsx.writeBuffer();

    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(filename || 'cosmic_result')}.xlsx"`);
    res.send(buffer);
  } catch (error) {
    console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
    res.status(500).json({ error: 'å¯¼å‡ºExcelå¤±è´¥: ' + error.message });
  }
});

// ========== è‡ªåŠ¨å¡«å……ç©ºç™½æ ¼å‡½æ•° ==========
// å°†åŠŸèƒ½ç”¨æˆ·ã€è§¦å‘äº‹ä»¶ã€åŠŸèƒ½è¿‡ç¨‹å‘ä¸‹å¡«å……åˆ°ç©ºç™½è¡Œï¼ˆåƒExcelåˆå¹¶å•å…ƒæ ¼çš„æ•ˆæœï¼‰
function fillEmptyCells(tableData) {
  if (!tableData || tableData.length === 0) return tableData;

  const result = [];
  let lastFunctionalUser = '';
  let lastTriggerEvent = '';
  let lastFunctionalProcess = '';

  for (let i = 0; i < tableData.length; i++) {
    const row = { ...tableData[i] };

    // å¦‚æœå½“å‰è¡Œæœ‰åŠŸèƒ½ç”¨æˆ·ï¼Œæ›´æ–°è®°å½•ï¼›å¦åˆ™ä½¿ç”¨ä¸Šä¸€ä¸ªæœ‰æ•ˆå€¼
    if (row.functionalUser && row.functionalUser.trim()) {
      lastFunctionalUser = row.functionalUser.trim();
    } else {
      row.functionalUser = lastFunctionalUser;
    }

    // å¦‚æœå½“å‰è¡Œæœ‰è§¦å‘äº‹ä»¶ï¼Œæ›´æ–°è®°å½•ï¼›å¦åˆ™ä½¿ç”¨ä¸Šä¸€ä¸ªæœ‰æ•ˆå€¼
    if (row.triggerEvent && row.triggerEvent.trim()) {
      lastTriggerEvent = row.triggerEvent.trim();
    } else {
      row.triggerEvent = lastTriggerEvent;
    }

    // å¦‚æœå½“å‰è¡Œæœ‰åŠŸèƒ½è¿‡ç¨‹ï¼Œæ›´æ–°è®°å½•ï¼›å¦åˆ™ä½¿ç”¨ä¸Šä¸€ä¸ªæœ‰æ•ˆå€¼
    if (row.functionalProcess && row.functionalProcess.trim()) {
      lastFunctionalProcess = row.functionalProcess.trim();
    } else {
      row.functionalProcess = lastFunctionalProcess;
    }

    result.push(row);
  }

  console.log(`è‡ªåŠ¨å¡«å……å®Œæˆ: ${result.length} è¡Œæ•°æ®`);
  return result;
}

// AIæ™ºèƒ½å»é‡ - åˆ†æå‰é¢æ•°æ®ç»„å†…å®¹ï¼Œç»“åˆå­è¿‡ç¨‹å…³é”®å­—ç”Ÿæˆæ–°åç§°
// ä¾‹å¦‚ï¼š"ç”¨æˆ·ä¿¡æ¯" é‡å¤æ—¶ï¼Œæ ¹æ®å­è¿‡ç¨‹"åˆ é™¤ç”¨æˆ·"ç”Ÿæˆ "ç”¨æˆ·ä¿¡æ¯åˆ é™¤è¡¨"
async function aiGenerateUniqueName(originalName, subProcessDesc, functionalProcess, existingNames) {
  try {
    const prompt = `ä½ æ˜¯ä¸€ä¸ªæ•°æ®å‘½åä¸“å®¶ã€‚ç°åœ¨æœ‰ä¸€ä¸ªæ•°æ®ç»„/æ•°æ®å±æ€§åç§°"${originalName}"ä¸å·²æœ‰åç§°é‡å¤ã€‚


ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
- åŠŸèƒ½è¿‡ç¨‹ï¼š${functionalProcess}
- å­è¿‡ç¨‹æè¿°ï¼š${subProcessDesc}
- å·²å­˜åœ¨çš„ç±»ä¼¼åç§°ï¼š${existingNames.slice(0, 5).join(', ')}

è¯·æ ¹æ®å­è¿‡ç¨‹æè¿°çš„ä¸šåŠ¡å«ä¹‰ï¼Œç›´æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„å®Œæ•´åç§°ï¼Œå°†åŸåç§°ä¸å­è¿‡ç¨‹çš„å…³é”®åŠ¨ä½œ/å¯¹è±¡ç»“åˆã€‚

è¦æ±‚ï¼š
1. ä¸è¦ä½¿ç”¨æ‹¬å·ï¼Œç›´æ¥å°†å…³é”®è¯èå…¥åç§°
2. æ–°åç§°è¦ä½“ç°å­è¿‡ç¨‹çš„å…·ä½“ä¸šåŠ¡åŠ¨ä½œ
3. åªè¾“å‡ºæ–°åç§°æœ¬èº«ï¼Œä¸è¦å…¶ä»–è§£é‡Š
4. åç§°è¦ç®€æ´ï¼Œä¸è¶…è¿‡15ä¸ªå­—

ç¤ºä¾‹ï¼š
- åŸåç§°"ç”¨æˆ·ä¿¡æ¯"ï¼Œå­è¿‡ç¨‹"åˆ é™¤ç”¨æˆ·è®°å½•" -> ç”¨æˆ·ä¿¡æ¯åˆ é™¤è¡¨
- åŸåç§°"è®¾å¤‡æ•°æ®"ï¼Œå­è¿‡ç¨‹"è¯»å–è®¾å¤‡çŠ¶æ€" -> è®¾å¤‡çŠ¶æ€è¯»å–æ•°æ®
- åŸåç§°"å‘Šè­¦è®°å½•"ï¼Œå­è¿‡ç¨‹"å†™å…¥å‘Šè­¦å¤„ç†ç»“æœ" -> å‘Šè­¦å¤„ç†ç»“æœè®°å½•
- åŸåç§°"è®¢å•ä¿¡æ¯"ï¼Œå­è¿‡ç¨‹"æŸ¥è¯¢å†å²è®¢å•" -> å†å²è®¢å•æŸ¥è¯¢ä¿¡æ¯`;

    const completion = await callAIChat({
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.3
    });

    const newName = completion.choices[0].message.content.trim();

    // æ¸…ç†å¯èƒ½çš„å¤šä½™å†…å®¹ï¼ŒåŒ…æ‹¬ã€ã€‘æ‹¬å·åŠå…¶å†…å®¹
    const cleanName = newName
      .replace(/["'\n\r]/g, '')
      .replace(/ã€[^ã€‘]*ã€‘/g, '')  // å»é™¤ã€xxxã€‘æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
      .replace(/\[[^\]]*\]/g, '')  // å»é™¤[xxx]æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
      .trim()
      .slice(0, 20);
    return cleanName || generateUniqueNameLocal(originalName, subProcessDesc);
  } catch (error) {
    console.log('AIç”Ÿæˆåç§°å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æå–:', error.message);
    return generateUniqueNameLocal(originalName, subProcessDesc);
  }
}

// æœ¬åœ°åç§°ç”Ÿæˆï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰- å°†åŸåç§°ä¸å­è¿‡ç¨‹å…³é”®è¯ç»“åˆï¼ˆç”¨äºæ•°æ®ç»„ï¼‰
function generateUniqueNameLocal(originalName, subProcessDesc = '') {
  // ä»å­è¿‡ç¨‹æè¿°ä¸­æå–å…³é”®åŠ¨è¯å’Œåè¯
  const cleaned = subProcessDesc
    .replace(/[\d]/g, '')
    .replace(/[ï¼Œã€‚ã€ã€Šã€‹ï¼ˆï¼‰()ï¼Ÿï¼šï¼›\-Â·]/g, ' ')
    .trim();

  if (!cleaned) {
    return originalName + 'æ‰©å±•è¡¨';
  }

  // å¸¸è§åŠ¨è¯åˆ—è¡¨
  const actionWords = ['æŸ¥è¯¢', 'è¯»å–', 'å†™å…¥', 'åˆ é™¤', 'æ›´æ–°', 'æ–°å¢', 'ä¿®æ”¹', 'è·å–', 'æäº¤', 'ä¿å­˜', 'å¯¼å‡º', 'å¯¼å…¥', 'åˆ†æ', 'ç»Ÿè®¡', 'å¤„ç†', 'å®¡æ ¸', 'éªŒè¯', 'ç¡®è®¤'];

  // æå–åŠ¨è¯
  let action = '';
  for (const word of actionWords) {
    if (cleaned.includes(word)) {
      action = word;
      break;
    }
  }

  // æå–åè¯ï¼ˆå»æ‰åŠ¨è¯åçš„å†…å®¹ï¼‰
  const tokens = cleaned.split(/\s+/).filter(Boolean);
  const noun = tokens.find(t => t.length >= 2 && !actionWords.includes(t)) || '';

  // ç»„åˆæ–°åç§°
  if (action && noun) {
    return originalName + action + noun;
  } else if (action) {
    return originalName + action + 'è¡¨';
  } else if (noun) {
    return originalName + noun + 'è¡¨';
  } else {
    // ç›´æ¥å–å­è¿‡ç¨‹æè¿°çš„å‰å‡ ä¸ªå­—
    const prefix = tokens.slice(0, 2).map(t => t.slice(0, 3)).join('');
    return originalName + (prefix || 'æ‰©å±•') + 'è¡¨';
  }
}

// AIæ™ºèƒ½å»é‡ - ä¸“é—¨ç”¨äºæ•°æ®å±æ€§ï¼Œä½¿ç”¨æ›´å¤šå­—æ®µç»„åˆ
async function aiGenerateUniqueAttrName(originalName, subProcessDesc, functionalProcess, existingNames, dataGroup) {
  const client = getOpenAIClient();
  if (!client) {
    return generateUniqueAttrNameLocal(originalName, subProcessDesc, dataGroup);
  }

  try {
    const prompt = `ä½ æ˜¯ä¸€ä¸ªæ•°æ®å±æ€§å‘½åä¸“å®¶ã€‚ç°åœ¨æœ‰ä¸€ä¸ªæ•°æ®å±æ€§åç§°"${originalName}"ä¸å·²æœ‰åç§°é‡å¤ã€‚

ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
- åŠŸèƒ½è¿‡ç¨‹ï¼š${functionalProcess}
- å­è¿‡ç¨‹æè¿°ï¼š${subProcessDesc}
- æ‰€å±æ•°æ®ç»„ï¼š${dataGroup}
- å·²å­˜åœ¨çš„ç±»ä¼¼åç§°ï¼š${existingNames.slice(0, 5).join(', ')}

è¯·æ ¹æ®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®å±æ€§åç§°ã€‚

è¦æ±‚ï¼š
1. ä¸è¦ä½¿ç”¨æ‹¬å·ï¼Œç›´æ¥å°†å…³é”®è¯èå…¥åç§°
2. æ–°åç§°è¦ä½“ç°æ•°æ®å±æ€§çš„å…·ä½“ç‰¹å¾ï¼ˆå¦‚IDã€ç±»å‹ã€å‚æ•°ã€ç‰ˆæœ¬ã€çŠ¶æ€ç­‰ï¼‰
3. å¯ä»¥ç»“åˆæ•°æ®ç»„åç§°ã€å­è¿‡ç¨‹åŠ¨ä½œæ¥åŒºåˆ†
4. åªè¾“å‡ºæ–°åç§°æœ¬èº«ï¼Œä¸è¦å…¶ä»–è§£é‡Š
5. åç§°è¦ç®€æ´ï¼Œä¸è¶…è¿‡15ä¸ªå­—

ç¤ºä¾‹ï¼š
- åŸåç§°"æ¨¡å‹ID"ï¼Œå­è¿‡ç¨‹"æŸ¥è¯¢æ¨¡å‹ä¿¡æ¯"ï¼Œæ•°æ®ç»„"æ¨¡å‹æ•°æ®" -> æŸ¥è¯¢æ¨¡å‹æ ‡è¯†
- åŸåç§°"è®¾å¤‡ç±»å‹"ï¼Œå­è¿‡ç¨‹"æ›´æ–°è®¾å¤‡çŠ¶æ€"ï¼Œæ•°æ®ç»„"è®¾å¤‡ä¿¡æ¯" -> è®¾å¤‡çŠ¶æ€ç±»å‹
- åŸåç§°"æ¨¡å‹æ•°æ®"ï¼Œå­è¿‡ç¨‹"è¯»å–æ¨¡å‹ç‰ˆæœ¬"ï¼Œæ•°æ®ç»„"æ¨¡å‹ä¿¡æ¯" -> æ¨¡å‹ç‰ˆæœ¬æ•°æ®
- åŸåç§°"è®¾å¤‡å‚æ•°"ï¼Œå­è¿‡ç¨‹"å¯¼å‡ºè®¾å¤‡é…ç½®"ï¼Œæ•°æ®ç»„"è®¾å¤‡å¯¼å‡º" -> å¯¼å‡ºé…ç½®å‚æ•°`;

    const completion = await client.chat.completions.create({
      model: process.env.OPENAI_MODEL || 'glm-4-flash',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.4,
      max_tokens: 50
    });

    const newName = completion.choices[0].message.content.trim();
    // æ¸…ç†å¯èƒ½çš„å¤šä½™å†…å®¹ï¼ŒåŒ…æ‹¬ã€ã€‘æ‹¬å·åŠå…¶å†…å®¹
    const cleanName = newName
      .replace(/["'\n\r]/g, '')
      .replace(/ã€[^ã€‘]*ã€‘/g, '')  // å»é™¤ã€xxxã€‘æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
      .replace(/\[[^\]]*\]/g, '')  // å»é™¤[xxx]æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
      .trim()
      .slice(0, 20);
    return cleanName || generateUniqueAttrNameLocal(originalName, subProcessDesc, dataGroup);
  } catch (error) {
    console.log('AIç”Ÿæˆå±æ€§åç§°å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æå–:', error.message);
    return generateUniqueAttrNameLocal(originalName, subProcessDesc, dataGroup);
  }
}

// æœ¬åœ°å±æ€§åç§°ç”Ÿæˆï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰- ä½¿ç”¨æ›´å¤šå­—æ®µç»„åˆ
function generateUniqueAttrNameLocal(originalName, subProcessDesc = '', dataGroup = '') {
  const cleaned = subProcessDesc
    .replace(/[\d]/g, '')
    .replace(/[ï¼Œã€‚ã€ã€Šã€‹ï¼ˆï¼‰()ï¼Ÿï¼šï¼›\-Â·]/g, ' ')
    .trim();

  // å±æ€§ç›¸å…³çš„åç¼€è¯
  const attrSuffixes = ['æ ‡è¯†', 'ç¼–å·', 'ç±»å‹', 'å‚æ•°', 'ç‰ˆæœ¬', 'çŠ¶æ€', 'é…ç½®', 'å±æ€§', 'å­—æ®µ', 'å€¼'];
  // å¸¸è§åŠ¨è¯åˆ—è¡¨
  const actionWords = ['æŸ¥è¯¢', 'è¯»å–', 'å†™å…¥', 'åˆ é™¤', 'æ›´æ–°', 'æ–°å¢', 'ä¿®æ”¹', 'è·å–', 'æäº¤', 'ä¿å­˜', 'å¯¼å‡º', 'å¯¼å…¥', 'åˆ†æ', 'ç»Ÿè®¡', 'å¤„ç†', 'å®¡æ ¸', 'éªŒè¯', 'ç¡®è®¤'];

  // æå–åŠ¨è¯
  let action = '';
  for (const word of actionWords) {
    if (cleaned.includes(word)) {
      action = word;
      break;
    }
  }

  // ä»æ•°æ®ç»„ä¸­æå–å…³é”®è¯
  const groupKeyword = dataGroup.replace(/[æ•°æ®è¡¨ä¿¡æ¯è®°å½•]/g, '').slice(0, 4);

  // éšæœºé€‰æ‹©ä¸€ä¸ªå±æ€§åç¼€
  const randomSuffix = attrSuffixes[Math.floor(Math.random() * attrSuffixes.length)];

  // ç»„åˆæ–°åç§° - ä½¿ç”¨ä¸åŒäºæ•°æ®ç»„çš„ç»„åˆæ–¹å¼
  if (action && groupKeyword) {
    return action + groupKeyword + randomSuffix;
  } else if (action) {
    return action + originalName + randomSuffix;
  } else if (groupKeyword) {
    return groupKeyword + originalName.slice(0, 4) + randomSuffix;
  } else {
    const tokens = cleaned.split(/\s+/).filter(Boolean);
    const prefix = tokens.slice(0, 2).map(t => t.slice(0, 2)).join('');
    return (prefix || 'æ‰©å±•') + originalName + randomSuffix;
  }
}

// ========== åŠŸèƒ½è¿‡ç¨‹å»é‡å‡½æ•° ==========
// åˆ é™¤é‡å¤çš„åŠŸèƒ½è¿‡ç¨‹åŠå…¶ä¸‹çš„æ‰€æœ‰å­è¿‡ç¨‹
function removeDuplicateFunctionalProcesses(tableData) {
  if (!tableData || tableData.length === 0) return tableData;

  const seenProcesses = new Set(); // å·²å‡ºç°çš„åŠŸèƒ½è¿‡ç¨‹åç§°
  const result = [];
  let currentProcess = ''; // å½“å‰æ­£åœ¨å¤„ç†çš„åŠŸèƒ½è¿‡ç¨‹
  let skipCurrentProcess = false; // æ˜¯å¦è·³è¿‡å½“å‰åŠŸèƒ½è¿‡ç¨‹

  for (let i = 0; i < tableData.length; i++) {
    const row = tableData[i];

    // è·å–å½“å‰è¡Œçš„åŠŸèƒ½è¿‡ç¨‹ï¼ˆå¯èƒ½ä¸ºç©ºï¼Œéœ€è¦ç»§æ‰¿ï¼‰
    const rowProcess = (row.functionalProcess || '').trim();
    const parentProcess = (row._parentProcess || '').trim();
    const effectiveProcess = rowProcess || parentProcess || currentProcess;

    // å¦‚æœæ˜¯Eç±»å‹ï¼ˆå…¥å£ï¼‰ï¼Œè¯´æ˜æ˜¯æ–°åŠŸèƒ½è¿‡ç¨‹çš„å¼€å§‹
    if (row.dataMovementType === 'E' && rowProcess) {
      currentProcess = rowProcess;

      // æ£€æŸ¥æ˜¯å¦é‡å¤
      const processKey = rowProcess.toLowerCase();
      if (seenProcesses.has(processKey)) {
        console.log(`å‘ç°é‡å¤åŠŸèƒ½è¿‡ç¨‹: "${rowProcess}"ï¼Œè·³è¿‡è¯¥åŠŸèƒ½è¿‡ç¨‹çš„æ‰€æœ‰å­è¿‡ç¨‹`);
        skipCurrentProcess = true;
        continue; // è·³è¿‡è¿™ä¸€è¡Œ
      } else {
        seenProcesses.add(processKey);
        skipCurrentProcess = false;
      }
    }

    // å¦‚æœå½“å‰åŠŸèƒ½è¿‡ç¨‹è¢«æ ‡è®°ä¸ºè·³è¿‡ï¼Œåˆ™è·³è¿‡è¯¥è¡Œ
    if (skipCurrentProcess) {
      // æ£€æŸ¥æ˜¯å¦è¿›å…¥äº†æ–°çš„åŠŸèƒ½è¿‡ç¨‹ï¼ˆé€šè¿‡Eç±»å‹åˆ¤æ–­ï¼‰
      if (row.dataMovementType === 'E' && rowProcess && rowProcess !== currentProcess) {
        // æ–°åŠŸèƒ½è¿‡ç¨‹å¼€å§‹ï¼Œé‡æ–°æ£€æŸ¥
        currentProcess = rowProcess;
        const processKey = rowProcess.toLowerCase();
        if (seenProcesses.has(processKey)) {
          console.log(`å‘ç°é‡å¤åŠŸèƒ½è¿‡ç¨‹: "${rowProcess}"ï¼Œè·³è¿‡è¯¥åŠŸèƒ½è¿‡ç¨‹çš„æ‰€æœ‰å­è¿‡ç¨‹`);
          skipCurrentProcess = true;
          continue;
        } else {
          seenProcesses.add(processKey);
          skipCurrentProcess = false;
        }
      } else {
        continue; // ç»§ç»­è·³è¿‡
      }
    }

    result.push(row);
  }

  console.log(`åŠŸèƒ½è¿‡ç¨‹å»é‡: åŸ ${tableData.length} æ¡ -> ç° ${result.length} æ¡ï¼Œå…± ${seenProcesses.size} ä¸ªå”¯ä¸€åŠŸèƒ½è¿‡ç¨‹`);
  return result;
}

// ========== åŠŸèƒ½è¿‡ç¨‹å®Œæ•´æ€§æ£€æŸ¥å’Œè¡¥å…¨å‡½æ•° ==========
// æ£€æŸ¥æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹æ˜¯å¦æœ‰å®Œæ•´çš„E+R+W+Xå››ä¸ªå­è¿‡ç¨‹ï¼Œå¦‚æœç¼ºå¤±åˆ™è‡ªåŠ¨è¡¥å…¨
function ensureProcessCompleteness(tableData) {
  if (!tableData || tableData.length === 0) return tableData;

  console.log('========== å¼€å§‹åŠŸèƒ½è¿‡ç¨‹å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå¿…é¡»æœ‰E+R+W+Xå››ä¸ªå­è¿‡ç¨‹ï¼‰ ==========');

  // æŒ‰åŠŸèƒ½è¿‡ç¨‹åˆ†ç»„
  const processMap = new Map();
  let currentProcess = '';

  for (const row of tableData) {
    const processName = row.functionalProcess || row._parentProcess || currentProcess;
    if (row.dataMovementType === 'E' && row.functionalProcess) {
      currentProcess = row.functionalProcess;
    }

    const effectiveProcess = processName || currentProcess;
    if (!processMap.has(effectiveProcess)) {
      processMap.set(effectiveProcess, []);
    }
    processMap.get(effectiveProcess).push({ ...row, _effectiveProcess: effectiveProcess });
  }

  const result = [];

  for (const [processName, rows] of processMap.entries()) {
    if (!processName) {
      result.push(...rows);
      continue;
    }

    // ç»Ÿè®¡å„ç±»å‹ - å¿…é¡»æœ‰Eã€Rã€Wã€Xå››ç§ç±»å‹
    const hasE = rows.some(r => r.dataMovementType === 'E');
    const hasR = rows.some(r => r.dataMovementType === 'R');
    const hasW = rows.some(r => r.dataMovementType === 'W');
    const hasX = rows.some(r => r.dataMovementType === 'X');

    // è·å–ç¬¬ä¸€è¡Œçš„åŸºç¡€ä¿¡æ¯
    const baseRow = rows[0] || {};
    const functionalUser = baseRow.functionalUser || 'ç”¨æˆ·è§¦å‘';
    const triggerEvent = baseRow.triggerEvent || 'ç”¨æˆ·è¯·æ±‚';

    // å¦‚æœç¼ºå°‘Eï¼Œåœ¨å¼€å¤´è¡¥å……
    if (!hasE) {
      console.log(`åŠŸèƒ½è¿‡ç¨‹"${processName}"ç¼ºå°‘Eï¼Œè‡ªåŠ¨è¡¥å……`);
      result.push({
        functionalUser,
        triggerEvent,
        functionalProcess: processName,
        subProcessDesc: `æ¥æ”¶${processName}è¯·æ±‚å‚æ•°`,
        dataMovementType: 'E',
        dataGroup: `${processName}è¯·æ±‚`,
        dataAttributes: `è¯·æ±‚å‚æ•°ã€æ“ä½œäººã€è¯·æ±‚æ—¶é—´`
      });
    }

    // æ·»åŠ åŸæœ‰çš„Eè¡Œ
    const eRows = rows.filter(r => r.dataMovementType === 'E');
    for (const row of eRows) {
      const { _effectiveProcess, ...cleanRow } = row;
      result.push(cleanRow);
    }

    // å¦‚æœç¼ºå°‘Rï¼Œè¡¥å……ä¸€ä¸ªR
    if (!hasR) {
      console.log(`åŠŸèƒ½è¿‡ç¨‹"${processName}"ç¼ºå°‘Rï¼Œè‡ªåŠ¨è¡¥å……`);
      result.push({
        functionalUser: '',
        triggerEvent: '',
        functionalProcess: '',
        subProcessDesc: `è¯»å–${processName}ç›¸å…³æ•°æ®`,
        dataMovementType: 'R',
        dataGroup: `${processName}æ•°æ®è¡¨`,
        dataAttributes: `æ•°æ®IDã€æ•°æ®å†…å®¹ã€æ›´æ–°æ—¶é—´`
      });
    }

    // æ·»åŠ åŸæœ‰çš„Rè¡Œ
    const rRows = rows.filter(r => r.dataMovementType === 'R');
    for (const row of rRows) {
      const { _effectiveProcess, ...cleanRow } = row;
      result.push(cleanRow);
    }

    // å¦‚æœç¼ºå°‘Wï¼Œè¡¥å……ä¸€ä¸ªW
    if (!hasW) {
      console.log(`åŠŸèƒ½è¿‡ç¨‹"${processName}"ç¼ºå°‘Wï¼Œè‡ªåŠ¨è¡¥å……`);
      result.push({
        functionalUser: '',
        triggerEvent: '',
        functionalProcess: '',
        subProcessDesc: `è®°å½•${processName}æ“ä½œæ—¥å¿—`,
        dataMovementType: 'W',
        dataGroup: `${processName}æ—¥å¿—è¡¨`,
        dataAttributes: `æ“ä½œäººã€æ“ä½œæ—¶é—´ã€æ“ä½œå†…å®¹`
      });
    }

    // æ·»åŠ åŸæœ‰çš„Wè¡Œ
    const wRows = rows.filter(r => r.dataMovementType === 'W');
    for (const row of wRows) {
      const { _effectiveProcess, ...cleanRow } = row;
      result.push(cleanRow);
    }

    // å¦‚æœç¼ºå°‘Xï¼Œåœ¨æœ«å°¾è¡¥å……
    if (!hasX) {
      console.log(`åŠŸèƒ½è¿‡ç¨‹"${processName}"ç¼ºå°‘Xï¼Œè‡ªåŠ¨è¡¥å……`);
      result.push({
        functionalUser: '',
        triggerEvent: '',
        functionalProcess: '',
        subProcessDesc: `è¿”å›${processName}æ“ä½œç»“æœ`,
        dataMovementType: 'X',
        dataGroup: `${processName}å“åº”`,
        dataAttributes: `æ“ä½œçŠ¶æ€ã€ç»“æœæ¶ˆæ¯ã€å¤„ç†æ—¶é—´`
      });
    }

    // æ·»åŠ åŸæœ‰çš„Xè¡Œ
    const xRows = rows.filter(r => r.dataMovementType === 'X');
    for (const row of xRows) {
      const { _effectiveProcess, ...cleanRow } = row;
      result.push(cleanRow);
    }
  }

  console.log(`å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ: ${tableData.length} -> ${result.length} æ¡`);
  return result;
}

// ========== æœ€ç»ˆç³»ç»Ÿæ€§å»é‡å‡½æ•° ==========
// å¯¹æ•´ä¸ªè¡¨æ ¼æ•°æ®è¿›è¡Œæœ€ç»ˆæ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®ç»„å’Œæ•°æ®å±æ€§æ²¡æœ‰å®Œå…¨é‡å¤
async function performFinalDeduplication(tableData) {
  if (!tableData || tableData.length === 0) return tableData;

  console.log('========== å¼€å§‹æœ€ç»ˆç³»ç»Ÿæ€§å»é‡æ£€æŸ¥ ==========');

  // æ¸…ç†åºå·å’Œæ‹¬å·çš„è¾…åŠ©å‡½æ•°ï¼ˆåŒ…æ‹¬æ‹¬å·å†…çš„å†…å®¹ï¼‰
  const cleanNumberSuffix = (text) => {
    if (!text) return text;
    return String(text)
      .replace(/\(\d+\)/g, '')  // å»é™¤ (2)ã€(3) ç­‰åºå·
      .replace(/ï¼ˆ\d+ï¼‰/g, '')  // å»é™¤ä¸­æ–‡æ‹¬å·åºå·
      .replace(/ã€[^ã€‘]*ã€‘/g, '')  // å»é™¤ã€xxxã€‘æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
      .replace(/\[[^\]]*\]/g, '')  // å»é™¤[xxx]æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
      .replace(/\s+/g, ' ')
      .trim();
  };

  // å…ˆæ¸…ç†æ‰€æœ‰è¡Œçš„ã€ã€‘æ‹¬å·å’Œåºå·
  tableData = tableData.map(row => ({
    ...row,
    functionalProcess: cleanNumberSuffix(row.functionalProcess),
    subProcessDesc: cleanNumberSuffix(row.subProcessDesc),
    dataGroup: cleanNumberSuffix(row.dataGroup),
    dataAttributes: cleanNumberSuffix(row.dataAttributes)
  }));

  // ========== ç¬¬é›¶æ­¥ï¼šåŠŸèƒ½è¿‡ç¨‹å»é‡ ==========
  // å¦‚æœåŠŸèƒ½è¿‡ç¨‹é‡å¤ï¼Œåˆ é™¤é‡å¤åŠŸèƒ½è¿‡ç¨‹çš„æ•´ç»„æ•°æ®ï¼ˆåŒ…æ‹¬å…¶ä¸‹çš„æ‰€æœ‰å­è¿‡ç¨‹ï¼‰
  tableData = removeDuplicateFunctionalProcesses(tableData);
  console.log(`åŠŸèƒ½è¿‡ç¨‹å»é‡åå‰©ä½™ ${tableData.length} æ¡æ•°æ®`);

  // ========== ç¬¬ä¸€æ­¥ï¼šå­è¿‡ç¨‹æè¿°å»é‡ï¼ˆæ™ºèƒ½è¯­ä¹‰åŒ–å»é‡ï¼‰ ==========
  const seenSubProcessDescs = new Map();
  tableData = tableData.map(row => {
    const key = (row.subProcessDesc || '').toLowerCase().trim();
    if (key && seenSubProcessDescs.has(key)) {
      // å…ˆæ¸…ç†åŠŸèƒ½è¿‡ç¨‹ä¸­çš„ã€ã€‘ï¼Œå†ç”¨äºç”Ÿæˆæ–°æè¿°
      const funcProcess = cleanNumberSuffix(row._parentProcess || row.functionalProcess || '');

      // æ™ºèƒ½è¯­ä¹‰åŒ–å»é‡ï¼šæ ¹æ®åŠŸèƒ½è¿‡ç¨‹çš„ä¸šåŠ¡å¯¹è±¡æ¥åŒºåˆ†
      // ä¾‹å¦‚ï¼š"å®¡æ ¸ä½œä¸šç‚¹çº§æ•°æ®" -> ä¸šåŠ¡å¯¹è±¡æ˜¯"ä½œä¸šç‚¹çº§æ•°æ®å®¡æ ¸"
      // ä¾‹å¦‚ï¼š"å‘å¸ƒä½œä¸šç‚¹çº§æ•°æ®" -> ä¸šåŠ¡å¯¹è±¡æ˜¯"ä½œä¸šç‚¹çº§æ•°æ®å‘å¸ƒ"
      let newDesc = generateSemanticSubProcessDesc(row.subProcessDesc, funcProcess);
      // å†æ¬¡æ¸…ç†ç”Ÿæˆçš„æ–°æè¿°ï¼Œç¡®ä¿ä¸åŒ…å«ã€ã€‘
      newDesc = cleanNumberSuffix(newDesc);

      if (newDesc !== row.subProcessDesc) {
        console.log(`å­è¿‡ç¨‹æè¿°è¯­ä¹‰åŒ–å»é‡: "${row.subProcessDesc}" -> "${newDesc}"`);
        row = { ...row, subProcessDesc: newDesc };
      }
    }
    seenSubProcessDescs.set((row.subProcessDesc || '').toLowerCase().trim(), true);
    return row;
  });

  const result = [];
  const seenDataGroups = new Map(); // key: æ•°æ®ç»„åç§°(å°å†™), value: { count, indices }
  const seenDataAttrs = new Map();  // key: æ•°æ®å±æ€§åç§°(å°å†™), value: { count, indices }

  // ç¬¬ä¸€éï¼šæ”¶é›†æ‰€æœ‰é‡å¤é¡¹
  tableData.forEach((row, idx) => {
    const groupKey = (row.dataGroup || '').toLowerCase().trim();
    const attrKey = (row.dataAttributes || '').toLowerCase().trim();

    if (groupKey) {
      if (!seenDataGroups.has(groupKey)) {
        seenDataGroups.set(groupKey, { count: 0, indices: [], original: row.dataGroup });
      }
      const entry = seenDataGroups.get(groupKey);
      entry.count++;
      entry.indices.push(idx);
    }

    if (attrKey) {
      if (!seenDataAttrs.has(attrKey)) {
        seenDataAttrs.set(attrKey, { count: 0, indices: [], original: row.dataAttributes });
      }
      const entry = seenDataAttrs.get(attrKey);
      entry.count++;
      entry.indices.push(idx);
    }
  });

  // æ‰¾å‡ºé‡å¤çš„æ•°æ®ç»„å’Œæ•°æ®å±æ€§
  const duplicateGroups = Array.from(seenDataGroups.entries()).filter(([_, v]) => v.count > 1);
  const duplicateAttrs = Array.from(seenDataAttrs.entries()).filter(([_, v]) => v.count > 1);

  console.log(`å‘ç° ${duplicateGroups.length} ä¸ªé‡å¤æ•°æ®ç»„ï¼Œ${duplicateAttrs.length} ä¸ªé‡å¤æ•°æ®å±æ€§`);

  // ç¬¬äºŒéï¼šå¤„ç†é‡å¤é¡¹ï¼Œä¸ºæ¯ä¸ªé‡å¤é¡¹ç”Ÿæˆå”¯ä¸€åç§°
  const processedGroups = new Set(); // å·²å¤„ç†çš„æ•°æ®ç»„ç´¢å¼•
  const processedAttrs = new Set();  // å·²å¤„ç†çš„æ•°æ®å±æ€§ç´¢å¼•

  for (let i = 0; i < tableData.length; i++) {
    const row = { ...tableData[i] };
    const groupKey = (row.dataGroup || '').toLowerCase().trim();
    const attrKey = (row.dataAttributes || '').toLowerCase().trim();

    // å¤„ç†é‡å¤çš„æ•°æ®ç»„
    if (groupKey && seenDataGroups.has(groupKey)) {
      const entry = seenDataGroups.get(groupKey);
      if (entry.count > 1) {
        const positionInDuplicates = entry.indices.indexOf(i);
        if (positionInDuplicates > 0) { // ç¬¬ä¸€ä¸ªä¿æŒä¸å˜ï¼Œåç»­çš„éœ€è¦ä¿®æ”¹
          // ç”Ÿæˆå”¯ä¸€åç§°
          const existingNames = result.map(r => r.dataGroup).filter(Boolean);
          const newName = await generateUniqueGroupName(
            row.dataGroup,
            row.subProcessDesc,
            row._parentProcess || row.functionalProcess || '',
            existingNames,
            positionInDuplicates
          );
          console.log(`æ•°æ®ç»„å»é‡[${i}]: "${row.dataGroup}" -> "${newName}"`);
          row.dataGroup = newName;
        }
      }
    }

    // å¤„ç†é‡å¤çš„æ•°æ®å±æ€§
    if (attrKey && seenDataAttrs.has(attrKey)) {
      const entry = seenDataAttrs.get(attrKey);
      if (entry.count > 1) {
        const positionInDuplicates = entry.indices.indexOf(i);
        if (positionInDuplicates > 0) { // ç¬¬ä¸€ä¸ªä¿æŒä¸å˜ï¼Œåç»­çš„éœ€è¦ä¿®æ”¹
          // ç”Ÿæˆå”¯ä¸€å±æ€§
          const existingAttrs = result.map(r => r.dataAttributes).filter(Boolean);
          const newAttrs = await generateUniqueAttrString(
            row.dataAttributes,
            row.subProcessDesc,
            row._parentProcess || row.functionalProcess || '',
            existingAttrs,
            row.dataGroup,
            positionInDuplicates
          );
          console.log(`æ•°æ®å±æ€§å»é‡[${i}]: "${row.dataAttributes}" -> "${newAttrs}"`);
          row.dataAttributes = newAttrs;
        }
      }
    }

    result.push(row);
  }

  // ========== æœ€ç»ˆæ¸…ç†ï¼šç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½ä¸åŒ…å«ã€ã€‘æ‹¬å·åŠå…¶å†…å®¹ ==========
  const finalCleanedResult = result.map(row => {
    const cleanBrackets = (text) => {
      if (!text) return text;
      return String(text)
        .replace(/ã€[^ã€‘]*ã€‘/g, '')  // å»é™¤ã€xxxã€‘æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
        .replace(/\[[^\]]*\]/g, '')  // å»é™¤[xxx]æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
        .replace(/([\u4e00-\u9fa5]{2,4})\1+/g, '$1')  // å»é™¤é‡å¤è¯
        .replace(/\s+/g, ' ')
        .trim();
    };

    return {
      ...row,
      functionalProcess: cleanBrackets(row.functionalProcess),
      subProcessDesc: cleanBrackets(row.subProcessDesc),
      dataGroup: cleanBrackets(row.dataGroup),
      dataAttributes: cleanBrackets(row.dataAttributes)
    };
  });

  console.log('========== æœ€ç»ˆå»é‡æ£€æŸ¥å®Œæˆ ==========');
  return finalCleanedResult;
}

// ç”Ÿæˆå”¯ä¸€çš„æ•°æ®ç»„åç§°
async function generateUniqueGroupName(originalName, subProcessDesc, functionalProcess, existingNames, duplicateIndex) {
  // ä»åŠŸèƒ½è¿‡ç¨‹ä¸­æå–åŠ¨è¯å…³é”®è¯
  const actionVerbs = ['æŸ¥è¯¢', 'åˆ›å»º', 'åˆ é™¤', 'ä¿®æ”¹', 'æ›´æ–°', 'å¯¼å‡º', 'å¯¼å…¥', 'æ–°å¢', 'ç¼–è¾‘', 'å®¡æ‰¹', 'å®¡æ ¸', 'æäº¤', 'æ’¤é”€', 'å¯ç”¨', 'ç¦ç”¨', 'é…ç½®', 'è®¾ç½®', 'åˆ†é…', 'å–æ¶ˆ', 'ç”Ÿæˆ', 'ä¿å­˜', 'è¯»å–'];
  let processAction = '';
  for (const verb of actionVerbs) {
    if (functionalProcess.includes(verb)) {
      processAction = verb;
      break;
    }
  }

  // æ ¹æ®å­è¿‡ç¨‹æè¿°æå–å…³é”®è¯
  const keywords = extractKeywords(subProcessDesc);
  const actionWord = keywords.action || '';
  const nounWord = keywords.noun || '';

  // å°è¯•ä¸åŒçš„ç»„åˆç­–ç•¥ï¼ˆä½¿ç”¨åŠŸèƒ½è¿‡ç¨‹åŠ¨è¯åŒºåˆ†ï¼Œä¸ç”¨åºå·ï¼‰
  const strategies = [
    () => processAction ? `${processAction}${originalName}` : null,
    () => `${originalName}Â·${processAction || actionWord}${nounWord}`,
    () => `${functionalProcess.slice(0, 6)}Â·${originalName}`,
    () => `${actionWord}${originalName}Â·${nounWord}`,
    () => `${originalName}Â·${functionalProcess.slice(0, 8)}`
  ];

  for (const strategy of strategies) {
    const candidate = strategy();
    if (candidate && candidate.length > 2 && !existingNames.some(n => n.toLowerCase() === candidate.toLowerCase())) {
      return candidate.slice(0, 25);
    }
  }

  // æœ€åå…œåº•ï¼šä½¿ç”¨åŠŸèƒ½è¿‡ç¨‹å…¨å
  return `${functionalProcess.slice(0, 10)}Â·${originalName}`.slice(0, 25);
}

// ç”Ÿæˆå”¯ä¸€çš„æ•°æ®å±æ€§å­—ç¬¦ä¸²
async function generateUniqueAttrString(originalAttrs, subProcessDesc, functionalProcess, existingAttrs, dataGroup, duplicateIndex) {
  // å°†åŸæœ‰å±æ€§æ‹†åˆ†æˆæ•°ç»„
  let fieldsArray = originalAttrs.split(/[|,ã€ï¼Œ]/).map(f => f.trim()).filter(Boolean);

  // ä»åŠŸèƒ½è¿‡ç¨‹ä¸­æå–åŠ¨è¯å…³é”®è¯
  const actionVerbs = ['æŸ¥è¯¢', 'åˆ›å»º', 'åˆ é™¤', 'ä¿®æ”¹', 'æ›´æ–°', 'å¯¼å‡º', 'å¯¼å…¥', 'æ–°å¢', 'ç¼–è¾‘', 'å®¡æ‰¹', 'å®¡æ ¸', 'æäº¤', 'æ’¤é”€', 'å¯ç”¨', 'ç¦ç”¨', 'é…ç½®', 'è®¾ç½®', 'åˆ†é…', 'å–æ¶ˆ', 'ç”Ÿæˆ', 'ä¿å­˜', 'è¯»å–'];
  let processAction = '';
  for (const verb of actionVerbs) {
    if (functionalProcess.includes(verb)) {
      processAction = verb;
      break;
    }
  }

  // æå–å…³é”®è¯
  const keywords = extractKeywords(subProcessDesc);
  const actionWord = keywords.action || '';
  const nounWord = keywords.noun || '';
  const groupKeyword = (dataGroup || '').replace(/[æ•°æ®è¡¨ä¿¡æ¯è®°å½•Â·]/g, '').slice(0, 4);

  // ç”Ÿæˆæ–°çš„å­—æ®µåï¼ˆä½¿ç”¨åŠŸèƒ½è¿‡ç¨‹åŠ¨è¯åŒºåˆ†ï¼Œä¸ç”¨åºå·ï¼‰
  const newFieldCandidates = [
    processAction ? `${processAction}${nounWord}å‚æ•°` : null,
    `${groupKeyword}${processAction || actionWord}å­—æ®µ`,
    `${functionalProcess.slice(0, 6)}å±æ€§`,
    `${nounWord}${processAction || actionWord}çŠ¶æ€`,
    `${processAction || actionWord}ç»“æœæ ‡è¯†`,
    `${functionalProcess.slice(0, 4)}æ‰©å±•å­—æ®µ`
  ].filter(f => f && f.length > 2);

  // é€‰æ‹©ä¸€ä¸ªä¸é‡å¤çš„æ–°å­—æ®µ
  for (const candidate of newFieldCandidates) {
    if (!fieldsArray.includes(candidate)) {
      fieldsArray.push(candidate);
      break;
    }
  }

  // æ‰“ä¹±é¡ºåº
  for (let i = fieldsArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [fieldsArray[i], fieldsArray[j]] = [fieldsArray[j], fieldsArray[i]];
  }

  return fieldsArray.join(', ');
}

// ä»å­è¿‡ç¨‹æè¿°ä¸­æå–å…³é”®è¯
function extractKeywords(subProcessDesc = '') {
  const cleaned = subProcessDesc
    .replace(/[\d]/g, '')
    .replace(/[ï¼Œã€‚ã€ã€Šã€‹ï¼ˆï¼‰()ï¼Ÿï¼šï¼›\-Â·]/g, ' ')
    .trim();

  const actionWords = ['æŸ¥è¯¢', 'è¯»å–', 'å†™å…¥', 'åˆ é™¤', 'æ›´æ–°', 'æ–°å¢', 'ä¿®æ”¹', 'è·å–', 'æäº¤', 'ä¿å­˜', 'å¯¼å‡º', 'å¯¼å…¥', 'åˆ†æ', 'ç»Ÿè®¡', 'å¤„ç†', 'å®¡æ ¸', 'éªŒè¯', 'ç¡®è®¤', 'æ¥æ”¶', 'è¿”å›', 'åˆå§‹åŒ–', 'ç”Ÿæˆ', 'æ¨¡æ‹Ÿ', 'å¯¼å‡º'];

  let action = '';
  for (const word of actionWords) {
    if (cleaned.includes(word)) {
      action = word;
      break;
    }
  }

  const tokens = cleaned.split(/\s+/).filter(Boolean);
  const noun = tokens.find(t => t.length >= 2 && !actionWords.includes(t)) || '';

  return { action, noun };
}

// ========== æ™ºèƒ½è¯­ä¹‰åŒ–å­è¿‡ç¨‹æè¿°å»é‡ ==========
// æ ¸å¿ƒæ€è·¯ï¼šå°†åŠŸèƒ½è¿‡ç¨‹çš„ä¸šåŠ¡åŠ¨ä½œè½¬åŒ–ä¸ºä¸šåŠ¡å¯¹è±¡çš„ä¿®é¥°è¯­ï¼Œè‡ªç„¶èå…¥å­è¿‡ç¨‹æè¿°
// ä¾‹å¦‚ï¼š"å®¡æ ¸ä½œä¸šç‚¹çº§æ•°æ®" çš„å­è¿‡ç¨‹ "æ¥æ”¶è¯·æ±‚å‚æ•°" -> "æ¥æ”¶ä½œä¸šç‚¹çº§æ•°æ®å®¡æ ¸è¯·æ±‚å‚æ•°"
// ä¾‹å¦‚ï¼š"å‘å¸ƒä½œä¸šç‚¹çº§æ•°æ®" çš„å­è¿‡ç¨‹ "è¯»å–å½“å‰çŠ¶æ€" -> "è¯»å–ä½œä¸šç‚¹çº§æ•°æ®å‘å¸ƒçŠ¶æ€ä¿¡æ¯"
function generateSemanticSubProcessDesc(originalDesc, functionalProcess) {
  if (!originalDesc || !functionalProcess) return originalDesc;

  // ä»åŠŸèƒ½è¿‡ç¨‹ä¸­æå–åŠ¨è¯å’Œä¸šåŠ¡å¯¹è±¡
  const actionVerbs = ['æŸ¥è¯¢', 'åˆ›å»º', 'åˆ é™¤', 'ä¿®æ”¹', 'æ›´æ–°', 'å¯¼å‡º', 'å¯¼å…¥', 'æ–°å¢', 'ç¼–è¾‘', 'å®¡æ‰¹', 'å®¡æ ¸', 'æäº¤', 'æ’¤é”€', 'å¯ç”¨', 'ç¦ç”¨', 'é…ç½®', 'è®¾ç½®', 'åˆ†é…', 'å–æ¶ˆ', 'å‘å¸ƒ', 'ç”Ÿæˆ', 'åŒæ­¥', 'å¤‡ä»½', 'æ¢å¤', 'éªŒè¯', 'ç¡®è®¤'];

  let actionVerb = '';
  let businessObject = functionalProcess;

  for (const verb of actionVerbs) {
    if (functionalProcess.includes(verb)) {
      actionVerb = verb;
      // æå–ä¸šåŠ¡å¯¹è±¡ï¼ˆå»æ‰åŠ¨è¯åçš„éƒ¨åˆ†ï¼‰
      const verbIndex = functionalProcess.indexOf(verb);
      businessObject = functionalProcess.slice(verbIndex + verb.length).trim() || functionalProcess.slice(0, verbIndex).trim();
      break;
    }
  }

  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŠ¨è¯ï¼Œä½¿ç”¨åŠŸèƒ½è¿‡ç¨‹çš„ååŠéƒ¨åˆ†ä½œä¸ºä¸šåŠ¡å¯¹è±¡
  if (!actionVerb) {
    businessObject = functionalProcess.slice(Math.max(0, functionalProcess.length - 8));
  }

  // æ„å»ºè¯­ä¹‰åŒ–çš„ä¸šåŠ¡ä¸Šä¸‹æ–‡ï¼ˆä¸šåŠ¡å¯¹è±¡+åŠ¨ä½œï¼‰
  const businessContext = actionVerb ? `${businessObject}${actionVerb}` : businessObject;

  // å­è¿‡ç¨‹æè¿°çš„åŠ¨è¯å‰ç¼€
  const subProcessPrefixes = ['æ¥æ”¶', 'è¯»å–', 'æŸ¥è¯¢', 'è·å–', 'ä¿å­˜', 'å†™å…¥', 'æ›´æ–°', 'åˆ é™¤', 'è¿”å›', 'è¾“å‡º', 'ç”Ÿæˆ', 'æ‰§è¡Œ', 'å¤„ç†', 'éªŒè¯', 'ç¡®è®¤', 'æäº¤', 'å¯¼å‡º', 'å¯¼å…¥', 'è°ƒç”¨', 'è®°å½•'];

  // æ£€æŸ¥åŸæè¿°æ˜¯å¦å·²ç»åŒ…å«ä¸šåŠ¡ä¸Šä¸‹æ–‡
  if (originalDesc.includes(businessContext) || originalDesc.includes(businessObject)) {
    return originalDesc;
  }

  // åœ¨å­è¿‡ç¨‹æè¿°ä¸­è‡ªç„¶èå…¥ä¸šåŠ¡ä¸Šä¸‹æ–‡
  for (const prefix of subProcessPrefixes) {
    if (originalDesc.startsWith(prefix)) {
      const rest = originalDesc.slice(prefix.length);
      // æ„å»ºæ–°æè¿°ï¼šåŠ¨è¯ + ä¸šåŠ¡ä¸Šä¸‹æ–‡ + åŸæœ‰å†…å®¹
      return `${prefix}${businessContext}${rest}`;
    }
  }

  // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å‰ç¼€ï¼Œåœ¨å¼€å¤´æ·»åŠ ä¸šåŠ¡ä¸Šä¸‹æ–‡
  return `${businessContext}${originalDesc}`;
}

// åœ¨å­è¿‡ç¨‹æè¿°ä¸­æ’å…¥åŠŸèƒ½è¿‡ç¨‹å…³é”®è¯ï¼ˆä¿ç•™åŸå‡½æ•°ä½œä¸ºå¤‡ç”¨ï¼‰
function insertProcessKeyword(subProcessDesc, processKeyword) {
  // å¸¸è§çš„åŠ¨è¯å‰ç¼€
  const actionPrefixes = ['æ¥æ”¶', 'è¯»å–', 'æŸ¥è¯¢', 'è·å–', 'ä¿å­˜', 'å†™å…¥', 'æ›´æ–°', 'åˆ é™¤', 'è¿”å›', 'è¾“å‡º', 'ç”Ÿæˆ', 'æ‰§è¡Œ', 'å¤„ç†', 'éªŒè¯', 'ç¡®è®¤', 'æäº¤', 'å¯¼å‡º', 'å¯¼å…¥', 'è°ƒç”¨'];

  for (const prefix of actionPrefixes) {
    if (subProcessDesc.startsWith(prefix)) {
      // åœ¨åŠ¨è¯åæ’å…¥åŠŸèƒ½è¿‡ç¨‹å…³é”®è¯
      const rest = subProcessDesc.slice(prefix.length);
      // å¦‚æœå‰©ä½™éƒ¨åˆ†å·²ç»åŒ…å«å…³é”®è¯ï¼Œåˆ™ä¸é‡å¤æ’å…¥
      if (rest.includes(processKeyword)) {
        return subProcessDesc;
      }
      return `${prefix}${processKeyword}${rest}`;
    }
  }

  // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°åŠ¨è¯å‰ç¼€ï¼Œç›´æ¥åœ¨å¼€å¤´æ·»åŠ å…³é”®è¯
  return `${processKeyword}${subProcessDesc}`;
}

function ensureMinimumAttributes(attrStr = '', functionalProcess = '', subProcessDesc = '') {
  const fields = Array.from(
    new Set(
      attrStr
        .split(/[|,ã€ï¼Œ]/)
        .map(f => f.trim())
        .filter(Boolean)
    )
  );

  const candidates = [
    `${functionalProcess || 'åŠŸèƒ½è¿‡ç¨‹'}æ ‡è¯†`,
    `${functionalProcess || 'åŠŸèƒ½è¿‡ç¨‹'}ç¼–å·`,
    `${subProcessDesc || 'å­è¿‡ç¨‹'}å‚æ•°`,
    `${subProcessDesc || 'å­è¿‡ç¨‹'}ç»“æœ`,
    'è®°å½•æ—¶é—´',
    'æ›´æ–°æ—¶é—´',
    'æ“ä½œäºº',
    'çŠ¶æ€æ ‡è®°'
  ];

  for (const candidate of candidates) {
    if (fields.length >= 3) break;
    if (candidate && !fields.includes(candidate)) {
      fields.push(candidate);
    }
  }

  // å…œåº•ï¼šå¦‚æœä»ç„¶ä¸è¶³3ä¸ªï¼Œä½¿ç”¨é€šç”¨å­—æ®µ
  const fallback = ['è®°å½•ç¼–å·', 'ä¸šåŠ¡æè¿°', 'åœ°å¸‚', 'æ—¶é—´', 'ID', 'å‚æ•°', 'ç¼–å·', 'å¤„ç†çŠ¶æ€'];
  for (const candidate of fallback) {
    if (fields.length >= 3) break;
    if (!fields.includes(candidate)) {
      fields.push(candidate);
    }
  }

  return fields.slice(0, Math.max(fields.length, 3)).join(', ');
}

// è§£æMarkdownè¡¨æ ¼ä¸ºç»“æ„åŒ–æ•°æ®
app.post('/api/parse-table', async (req, res) => {
  try {
    const { markdown } = req.body;

    if (!markdown) {
      return res.status(400).json({ error: 'æ— Markdownå†…å®¹' });
    }

    // æå–è¡¨æ ¼å†…å®¹
    const tableMatch = markdown.match(/\|[^\n]+\|[\s\S]*?\|[^\n]+\|/g);
    if (!tableMatch) {
      return res.status(400).json({ error: 'æœªæ‰¾åˆ°æœ‰æ•ˆçš„Markdownè¡¨æ ¼' });
    }

    const rawLines = markdown.split('\n');
    const lines = rawLines.filter(line => line.trim().startsWith('|'));

    if (lines.length < 3) {
      return res.status(400).json({ error: 'è¡¨æ ¼æ•°æ®ä¸å®Œæ•´' });
    }

    // è·³è¿‡è¡¨å¤´å’Œåˆ†éš”è¡Œ
    const dataLines = lines.slice(2);

    let currentFunctionalUser = '';
    let currentTriggerEvent = '';
    let currentFunctionalProcess = '';
    const pendingRows = [];

    // æ¸…ç†æ–‡æœ¬ï¼šå»é™¤åºå·(2)ã€(3)ç­‰ï¼Œæ›¿æ¢è¿å­—ç¬¦ï¼Œå»é™¤ã€ã€‘æ‹¬å·åŠå…¶å†…å®¹ï¼Œæ¸…ç†é‡å¤è¯
    const sanitizeText = (value = '') => {
      if (!value) return '';
      let text = String(value)
        .replace(/\(\d+\)/g, '')  // å»é™¤ (2)ã€(3) ç­‰åºå·
        .replace(/ï¼ˆ\d+ï¼‰/g, '')  // å»é™¤ä¸­æ–‡æ‹¬å·åºå·
        .replace(/ã€[^ã€‘]*ã€‘/g, '')  // å»é™¤ã€xxxã€‘æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
        .replace(/\[[^\]]*\]/g, '')  // å»é™¤[xxx]æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
        .replace(/-/g, 'Â·')
        .replace(/\s+/g, ' ')
        .trim();

      // æ¸…ç†é‡å¤è¯ï¼šå¦‚"è¯»å–è¯»å–"ã€"ä¿å­˜ä¿å­˜"ã€"æŸ¥è¯¢æŸ¥è¯¢"ç­‰
      // åŒ¹é…ä¸­æ–‡è¯æ±‡é‡å¤çš„æƒ…å†µ
      const commonVerbs = ['è¯»å–', 'ä¿å­˜', 'æŸ¥è¯¢', 'è·å–', 'å†™å…¥', 'åˆ é™¤', 'æ›´æ–°', 'ä¿®æ”¹', 'åˆ›å»º', 'æ–°å¢', 'æäº¤', 'è¿”å›', 'æ¥æ”¶', 'å‘é€', 'æ ¡éªŒ', 'éªŒè¯', 'æ£€æŸ¥', 'è®¡ç®—', 'ç»Ÿè®¡', 'åˆ†æ', 'å¤„ç†', 'æ‰§è¡Œ', 'è°ƒç”¨', 'è§¦å‘', 'å¯åŠ¨', 'åœæ­¢', 'æš‚åœ', 'æ¢å¤', 'å–æ¶ˆ', 'ç¡®è®¤', 'å®¡æ‰¹', 'å®¡æ ¸', 'å¯¼å‡º', 'å¯¼å…¥', 'ä¸Šä¼ ', 'ä¸‹è½½', 'é…ç½®', 'è®¾ç½®', 'ç¼–è¾‘'];

      for (const verb of commonVerbs) {
        // åŒ¹é…è¿ç»­é‡å¤çš„åŠ¨è¯ï¼Œæ›¿æ¢ä¸ºå•ä¸ª
        const duplicatePattern = new RegExp(`(${verb})\\1+`, 'g');
        text = text.replace(duplicatePattern, verb);
      }

      // é€šç”¨é‡å¤è¯æ£€æµ‹ï¼šåŒ¹é…ä»»æ„2-4ä¸ªæ±‰å­—çš„é‡å¤
      text = text.replace(/([\u4e00-\u9fa5]{2,4})\1+/g, '$1');

      return text;
    };

    // ğŸ”§ æ¸…æ´—æ•°æ®å±æ€§ï¼šå°†è‹±æ–‡å­—æ®µåè½¬ä¸ºä¸­æ–‡ï¼Œå°†è‹±æ–‡é€—å·è½¬ä¸ºé¡¿å·
    const cleanDataAttributes = (attrs = '') => {
      if (!attrs) return '';

      // è‹±æ–‡å­—æ®µååˆ°ä¸­æ–‡çš„æ˜ å°„
      const fieldMapping = {
        // æ ‡è¯†ç±»
        'cell_id': 'å°åŒºæ ‡è¯†', 'cellid': 'å°åŒºæ ‡è¯†', 'CELL_ID': 'å°åŒºæ ‡è¯†',
        'gNBId': 'åŸºç«™ç¼–å·', 'gnbid': 'åŸºç«™ç¼–å·', 'gNB_ID': 'åŸºç«™ç¼–å·',
        'task_id': 'ä»»åŠ¡ç¼–å·', 'taskid': 'ä»»åŠ¡ç¼–å·', 'TASK_ID': 'ä»»åŠ¡ç¼–å·',
        'user_id': 'ç”¨æˆ·ç¼–å·', 'userid': 'ç”¨æˆ·ç¼–å·', 'USER_ID': 'ç”¨æˆ·ç¼–å·',
        'request_id': 'è¯·æ±‚æ ‡è¯†', 'requestid': 'è¯·æ±‚æ ‡è¯†', 'REQUEST_ID': 'è¯·æ±‚æ ‡è¯†',
        'node_id': 'èŠ‚ç‚¹ç¼–å·', 'nodeid': 'èŠ‚ç‚¹ç¼–å·', 'NODE_ID': 'èŠ‚ç‚¹ç¼–å·', 'NODEB_ID': 'åŸºç«™ç¼–å·',
        'scene_name': 'åœºæ™¯åç§°', 'scenename': 'åœºæ™¯åç§°', 'SCENE_NAME': 'åœºæ™¯åç§°',

        // ç½‘ç»œç›¸å…³
        'DU_me_moid': 'è®¾å¤‡æ ‡è¯†', 'du_me_moid': 'è®¾å¤‡æ ‡è¯†',
        'NR_PHYSICAL_CELL_DU_ID': 'ç‰©ç†å°åŒºæ ‡è¯†', 'nr_physical_cell_du_id': 'ç‰©ç†å°åŒºæ ‡è¯†',
        'gNBIdLength': 'åŸºç«™ç¼–å·é•¿åº¦', 'gnbidlength': 'åŸºç«™ç¼–å·é•¿åº¦',
        'CGI': 'å°åŒºå…¨å±€æ ‡è¯†', 'cgi': 'å°åŒºå…¨å±€æ ‡è¯†',
        'NGI': 'ç½‘ç»œå…¨å±€æ ‡è¯†', 'ngi': 'ç½‘ç»œå…¨å±€æ ‡è¯†',
        'TCP_POOR_RT': 'TCPå·®æ¯”ç‡', 'tcp_poor_rt': 'TCPå·®æ¯”ç‡',
        'TCP_POOR_SESN_CNT': 'TCPå·®ä¼šè¯æ•°', 'tcp_poor_sesn_cnt': 'TCPå·®ä¼šè¯æ•°',
        'DL_SESN_DUR': 'ä¸‹è¡Œä¼šè¯æ—¶é•¿', 'dl_sesn_dur': 'ä¸‹è¡Œä¼šè¯æ—¶é•¿',
        'UL_SESN_DUR': 'ä¸Šè¡Œä¼šè¯æ—¶é•¿', 'ul_sesn_dur': 'ä¸Šè¡Œä¼šè¯æ—¶é•¿',
        'DL_RTT_LAT': 'ä¸‹è¡Œæ—¶å»¶', 'dl_rtt_lat': 'ä¸‹è¡Œæ—¶å»¶',
        'UL_RTT_LAT': 'ä¸Šè¡Œæ—¶å»¶', 'ul_rtt_lat': 'ä¸Šè¡Œæ—¶å»¶',
        'DL_DATA_MB': 'ä¸‹è¡Œæ•°æ®é‡', 'dl_data_mb': 'ä¸‹è¡Œæ•°æ®é‡',
        'UL_DATA_MB': 'ä¸Šè¡Œæ•°æ®é‡', 'ul_data_mb': 'ä¸Šè¡Œæ•°æ®é‡',
        'TOTAL_SESN_CNT': 'æ€»ä¼šè¯æ•°', 'total_sesn_cnt': 'æ€»ä¼šè¯æ•°',
        'AVG_TCP_RET_DATA': 'å¹³å‡TCPé‡ä¼ ', 'avg_tcp_ret_data': 'å¹³å‡TCPé‡ä¼ ',
        'TCP_ESTB_ACK_LAT': 'TCPå»ºé“¾ç¡®è®¤æ—¶å»¶', 'tcp_estb_ack_lat': 'TCPå»ºé“¾ç¡®è®¤æ—¶å»¶',
        'TCP_ESTB_RSP_LAT': 'TCPå»ºé“¾å“åº”æ—¶å»¶', 'tcp_estb_rsp_lat': 'TCPå»ºé“¾å“åº”æ—¶å»¶',
        'SESN_ACK_FIR_DAT_LAT': 'é¦–åŒ…ç¡®è®¤æ—¶å»¶', 'sesn_ack_fir_dat_lat': 'é¦–åŒ…ç¡®è®¤æ—¶å»¶',
        'UL_SESN_RATE_KBPS': 'ä¸Šè¡Œä¼šè¯é€Ÿç‡', 'ul_sesn_rate_kbps': 'ä¸Šè¡Œä¼šè¯é€Ÿç‡',
        'DL_SESN_RATE_KBPS': 'ä¸‹è¡Œä¼šè¯é€Ÿç‡', 'dl_sesn_rate_kbps': 'ä¸‹è¡Œä¼šè¯é€Ÿç‡',
        'AVG_TCP_ORD_PKT_CNT': 'å¹³å‡æœ‰åºåŒ…æ•°', 'avg_tcp_ord_pkt_cnt': 'å¹³å‡æœ‰åºåŒ…æ•°',
        'AVG_TCP_LST_PKT_CNT': 'å¹³å‡ä¸¢åŒ…æ•°', 'avg_tcp_lst_pkt_cnt': 'å¹³å‡ä¸¢åŒ…æ•°',
        'UDP_SESN_CNT': 'UDPä¼šè¯æ•°', 'udp_sesn_cnt': 'UDPä¼šè¯æ•°',

        // æ—¶é—´ç±»
        'create_time': 'åˆ›å»ºæ—¶é—´', 'createtime': 'åˆ›å»ºæ—¶é—´', 'CREATE_TIME': 'åˆ›å»ºæ—¶é—´',
        'update_time': 'æ›´æ–°æ—¶é—´', 'updatetime': 'æ›´æ–°æ—¶é—´', 'UPDATE_TIME': 'æ›´æ–°æ—¶é—´',
        'start_time': 'å¼€å§‹æ—¶é—´', 'starttime': 'å¼€å§‹æ—¶é—´', 'START_TIME': 'å¼€å§‹æ—¶é—´',
        'end_time': 'ç»“æŸæ—¶é—´', 'endtime': 'ç»“æŸæ—¶é—´', 'END_TIME': 'ç»“æŸæ—¶é—´',
        'timestamp': 'æ—¶é—´æˆ³', 'TIMESTAMP': 'æ—¶é—´æˆ³',

        // çŠ¶æ€ç±»
        'status': 'çŠ¶æ€', 'STATUS': 'çŠ¶æ€',
        'state': 'çŠ¶æ€', 'STATE': 'çŠ¶æ€',
        'flag': 'æ ‡å¿—', 'FLAG': 'æ ‡å¿—',

        // é€šç”¨ç±»
        'name': 'åç§°', 'NAME': 'åç§°',
        'type': 'ç±»å‹', 'TYPE': 'ç±»å‹',
        'count': 'æ•°é‡', 'COUNT': 'æ•°é‡',
        'total': 'æ€»è®¡', 'TOTAL': 'æ€»è®¡',
        'vendor': 'å‚å•†', 'VENDOR': 'å‚å•†',
        'city': 'åŸå¸‚', 'CITY': 'åŸå¸‚',
        'county': 'åŒºå¿', 'COUNTY': 'åŒºå¿',
        'frequency': 'é¢‘ç‡', 'FREQUENCY': 'é¢‘ç‡',
        'total_traffic_gb': 'æ€»æµé‡', 'TOTAL_TRAFFIC_GB': 'æ€»æµé‡',
        'FILE_NAME': 'æ–‡ä»¶åç§°', 'file_name': 'æ–‡ä»¶åç§°',
        'CELL_NAME': 'å°åŒºåç§°', 'cell_name': 'å°åŒºåç§°',
      };

      let cleaned = attrs;

      // 1. æ›¿æ¢å·²çŸ¥çš„è‹±æ–‡å­—æ®µåä¸ºä¸­æ–‡
      for (const [eng, chn] of Object.entries(fieldMapping)) {
        const regex = new RegExp(`\\b${eng}\\b`, 'gi');
        cleaned = cleaned.replace(regex, chn);
      }

      // 2. å°†è‹±æ–‡é€—å·æ›¿æ¢ä¸ºä¸­æ–‡é¡¿å·
      cleaned = cleaned.replace(/,\s*/g, 'ã€');

      // 3. å°† | åˆ†éš”ç¬¦æ›¿æ¢ä¸ºé¡¿å·
      cleaned = cleaned.replace(/\s*\|\s*/g, 'ã€');

      // 4. æ¸…ç†å¤šä½™çš„é¡¿å·
      cleaned = cleaned.replace(/ã€+/g, 'ã€');
      cleaned = cleaned.replace(/^ã€|ã€$/g, '');

      // 5. æˆªæ–­è¿‡é•¿çš„å±æ€§åˆ—è¡¨ï¼ˆæœ€å¤šä¿ç•™8ä¸ªå­—æ®µï¼‰
      const fields = cleaned.split('ã€').map(f => f.trim()).filter(f => f);
      if (fields.length > 8) {
        cleaned = fields.slice(0, 8).join('ã€');
      }

      return cleaned;
    };

    // ğŸ”§ ç®€åŒ–å­è¿‡ç¨‹æè¿°ï¼ˆä¸è¶…è¿‡15ä¸ªå­—ï¼‰
    const simplifySubProcessDesc = (desc = '') => {
      if (!desc || desc.length <= 15) return desc;

      let simplified = desc
        // ç®€åŒ–æ¥æ”¶ç±»æè¿°
        .replace(/æ¥æ”¶.*?æ•°æ®.*?[ï¼Œ,].*?ç”Ÿæˆ.*/, (m) => {
          const match = m.match(/æ¥æ”¶(.{2,6}?).*?æ•°æ®/);
          return match ? `æ¥æ”¶${match[1]}æ•°æ®` : 'æ¥æ”¶è¯·æ±‚æ•°æ®';
        })
        // ç®€åŒ–è¯»å–ç±»æè¿°
        .replace(/è¯»å–.*?ç›¸å…³.*?æ•°æ®/, (m) => {
          const match = m.match(/è¯»å–(.{2,8}?)(ç›¸å…³|åŸºç¡€|é…ç½®)/);
          return match ? `è¯»å–${match[1]}æ•°æ®` : 'è¯»å–ç›¸å…³æ•°æ®';
        })
        // ç®€åŒ–è®°å½•ç±»æè¿°
        .replace(/è®°å½•.*?æ“ä½œ.*?æ—¥å¿—/, 'è®°å½•æ“ä½œæ—¥å¿—')
        // ç®€åŒ–è¿”å›ç±»æè¿°
        .replace(/è¿”å›.*?æ“ä½œ.*?ç»“æœ/, 'è¿”å›æ“ä½œç»“æœ')
        // ç®€åŒ–ç”Ÿæˆç±»æè¿°
        .replace(/ç”Ÿæˆ.*?æ•°æ®/, (m) => {
          const match = m.match(/ç”Ÿæˆ(.{2,6}?)æ•°æ®/);
          return match ? `ç”Ÿæˆ${match[1]}æ•°æ®` : 'ç”Ÿæˆæ•°æ®';
        });

      // ä¸å†å¼ºåˆ¶æˆªæ–­å­è¿‡ç¨‹æè¿°ï¼Œä¿ç•™å®Œæ•´çš„ä¸šåŠ¡è¯­ä¹‰
      // ä¹‹å‰çš„æˆªæ–­ä¼šå¯¼è‡´ä¿¡æ¯ä¸¢å¤±å’Œçœç•¥å·é—®é¢˜

      return simplified;
    };

    const normalizeCells = (line) => {
      // ä¿ç•™æ‰€æœ‰å•å…ƒæ ¼ï¼ŒåŒ…æ‹¬ç©ºçš„ï¼ˆç”¨äºåˆå¹¶å•å…ƒæ ¼ï¼‰
      const rawCells = line.split('|');
      // å»æ‰é¦–å°¾çš„ç©ºå­—ç¬¦ä¸²ï¼ˆç”±äº | å¼€å¤´å’Œç»“å°¾äº§ç”Ÿï¼‰
      if (rawCells.length > 0 && rawCells[0].trim() === '') rawCells.shift();
      if (rawCells.length > 0 && rawCells[rawCells.length - 1].trim() === '') rawCells.pop();
      return rawCells.map(cell => cell.trim());
    };

    // ========== æ™ºèƒ½åˆ¤æ–­åŠŸèƒ½è§¦å‘ç±»å‹ ==========
    // æ ¸å¿ƒåŸåˆ™ï¼šçœ‹åŠŸèƒ½çš„"å¯åŠ¨æº"æ˜¯ä»€ä¹ˆï¼
    // - ç”¨æˆ·è§¦å‘ï¼šç”¨æˆ·ç‚¹å‡»æŒ‰é’®ã€æäº¤è¡¨å•ç­‰æ˜¾å¼æ“ä½œå‘èµ·çš„ï¼ˆå³ä½¿æ˜¯åå°æ‰§è¡Œçš„è€—æ—¶ä»»åŠ¡ï¼‰
    // - æ—¶é’Ÿè§¦å‘ï¼šç³»ç»ŸæŒ‰é¢„è®¾æ—¶é—´è‡ªåŠ¨æ‰§è¡Œçš„ï¼ˆå¿…é¡»æœ‰æ˜ç¡®çš„å®šæ—¶/å‘¨æœŸå…³é”®è¯ï¼‰
    // - æ¥å£è§¦å‘ï¼šå¤–éƒ¨ç³»ç»Ÿæ¨é€/å›è°ƒè§¦å‘çš„
    const intelligentTriggerAnalysis = (functionalProcess = '') => {
      const process = functionalProcess.trim();

      // ===== ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šæ—¶é’Ÿè§¦å‘ =====
      // å¿…é¡»æœ‰æ˜ç¡®çš„å®šæ—¶/å‘¨æœŸ/è‡ªåŠ¨æ‰§è¡Œå…³é”®è¯
      // è¿™ç±»åŠŸèƒ½æ˜¯ç³»ç»ŸæŒ‰æ—¶é—´è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
      const timerPatterns = [
        /å®šæ—¶/,           // å®šæ—¶æ¸…ç†ã€å®šæ—¶åŒæ­¥ã€å®šæ—¶ç»Ÿè®¡
        /å‘¨æœŸ/,           // å‘¨æœŸæ‰§è¡Œã€å‘¨æœŸæ£€æŸ¥
        /æ¯æ—¥/,           // æ¯æ—¥ç»Ÿè®¡ã€æ¯æ—¥æŠ¥è¡¨
        /æ¯å‘¨/,           // æ¯å‘¨æ±‡æ€»
        /æ¯æœˆ/,           // æ¯æœˆæŠ¥å‘Š
        /æ¯å¹´/,           // æ¯å¹´å½’æ¡£
        /æ¯å°æ—¶/,         // æ¯å°æ—¶åˆ·æ–°
        /è‡ªåŠ¨æ‰§è¡Œ/,       // è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡
        /è‡ªåŠ¨æ¸…ç†/,       // è‡ªåŠ¨æ¸…ç†æ—¥å¿—
        /è‡ªåŠ¨åŒæ­¥/,       // è‡ªåŠ¨åŒæ­¥æ•°æ®
        /è‡ªåŠ¨å¤‡ä»½/,       // è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
        /è‡ªåŠ¨ç”Ÿæˆ/,       // è‡ªåŠ¨ç”ŸæˆæŠ¥è¡¨
        /è‡ªåŠ¨åˆ·æ–°/,       // è‡ªåŠ¨åˆ·æ–°ç¼“å­˜
        /è‡ªåŠ¨æ¨é€/,       // è‡ªåŠ¨æ¨é€æ¶ˆæ¯
        /å‡Œæ™¨/,           // å‡Œæ™¨æ‰§è¡Œ
        /å¤œé—´/,           // å¤œé—´å¤„ç†
        /å®šæœŸ/,           // å®šæœŸå¤‡ä»½ã€å®šæœŸæ¸…ç†
      ];

      for (const pattern of timerPatterns) {
        if (pattern.test(process)) {
          return { user: 'æ—¶é’Ÿè§¦å‘', trigger: 'å®šæ—¶ä»»åŠ¡' };
        }
      }

      // ===== ç¬¬äºŒä¼˜å…ˆçº§ï¼šæ¥å£è§¦å‘ =====
      // åªæœ‰å¤–éƒ¨ç³»ç»Ÿæ¨é€/å›è°ƒæ‰æ˜¯æ¥å£è§¦å‘
      const interfacePatterns = [
        /æ¥æ”¶.*æ¨é€/,     // æ¥æ”¶å¤–éƒ¨æ¨é€
        /æ¥æ”¶.*é€šçŸ¥/,     // æ¥æ”¶ç³»ç»Ÿé€šçŸ¥
        /æ¥æ”¶.*å›è°ƒ/,     // æ¥æ”¶å›è°ƒ
        /Webhook/i,       // Webhookå›è°ƒ
        /å›è°ƒå¤„ç†/,       // å¤„ç†å›è°ƒ
        /å¤–éƒ¨.*æ¨é€/,     // å¤–éƒ¨ç³»ç»Ÿæ¨é€
        /ç¬¬ä¸‰æ–¹.*æ¨é€/,   // ç¬¬ä¸‰æ–¹æ¨é€
        /æ¶ˆæ¯é˜Ÿåˆ—/,       // æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹
        /äº‹ä»¶ç›‘å¬/,       // äº‹ä»¶ç›‘å¬
      ];

      for (const pattern of interfacePatterns) {
        if (pattern.test(process)) {
          return { user: 'æ¥å£è§¦å‘', trigger: 'æ¥å£è°ƒç”¨' };
        }
      }

      // ===== é»˜è®¤ï¼šç”¨æˆ·è§¦å‘ =====
      // æ‰€æœ‰ç”¨æˆ·ç‚¹å‡»æŒ‰é’®å‘èµ·çš„æ“ä½œéƒ½æ˜¯ç”¨æˆ·è§¦å‘
      // åŒ…æ‹¬ï¼šæŸ¥è¯¢ã€åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ã€æ­å»ºã€åŠ å·¥ã€æ‰¹é‡å¤„ç†ç­‰
      // å³ä½¿æ˜¯åå°æ‰§è¡Œçš„è€—æ—¶ä»»åŠ¡ï¼Œåªè¦æ˜¯ç”¨æˆ·å‘èµ·çš„ï¼Œå°±æ˜¯ç”¨æˆ·è§¦å‘
      return { user: 'ç”¨æˆ·è§¦å‘', trigger: 'ç”¨æˆ·è¯·æ±‚' };
    };

    const normalizeUserTrigger = (userVal = '', triggerVal = '', functionalProcess = '') => {
      const user = (userVal || '').trim();
      const trigger = (triggerVal || '').trim();

      // å¦‚æœå·²ç»æœ‰æ˜ç¡®çš„è§¦å‘ç±»å‹ï¼Œä¼˜å…ˆä½¿ç”¨
      if (/ç”¨æˆ·|å‰å°|ç•Œé¢/.test(user)) return { user: 'ç”¨æˆ·è§¦å‘', trigger: trigger || 'ç”¨æˆ·è¯·æ±‚' };
      if (/æ—¶é’Ÿ|å®šæ—¶/.test(user)) return { user: 'æ—¶é’Ÿè§¦å‘', trigger: trigger || 'å®šæ—¶ä»»åŠ¡' };
      if (/æ¥å£|äº‹ä»¶|é˜Ÿåˆ—|Webhook/i.test(user)) return { user: 'æ¥å£è§¦å‘', trigger: trigger || 'æ¥å£è°ƒç”¨' };
      if (/ç”¨æˆ·|å‰å°|ç•Œé¢/.test(trigger)) return { user: 'ç”¨æˆ·è§¦å‘', trigger: trigger || 'ç”¨æˆ·è¯·æ±‚' };
      if (/å®šæ—¶|å‘¨æœŸ/.test(trigger)) return { user: 'æ—¶é’Ÿè§¦å‘', trigger: trigger || 'å®šæ—¶ä»»åŠ¡' };
      if (/æ¥å£|äº‹ä»¶|é˜Ÿåˆ—|Webhook/i.test(trigger)) return { user: 'æ¥å£è§¦å‘', trigger: trigger || 'æ¥å£è°ƒç”¨' };

      // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„è§¦å‘ç±»å‹ï¼Œæ ¹æ®åŠŸèƒ½è¿‡ç¨‹æ™ºèƒ½åˆ¤æ–­
      if (functionalProcess) {
        return intelligentTriggerAnalysis(functionalProcess);
      }

      return { user: user || 'ç”¨æˆ·è§¦å‘', trigger: trigger || 'ç”¨æˆ·è¯·æ±‚' };
    };

    dataLines.forEach((line, rowIdx) => {
      const cells = normalizeCells(line);
      console.log(`è¡Œ ${rowIdx}: cells.length=${cells.length}, cells=`, cells.slice(0, 7));

      // åªè¦æœ‰è¶³å¤Ÿçš„åˆ—å°±å¤„ç†ï¼ˆåˆå¹¶å•å…ƒæ ¼æ—¶å‰å‡ åˆ—å¯èƒ½ä¸ºç©ºï¼‰
      if (cells.length >= 4) {
        let subProcessDesc = cells[3] || '';
        let dataMovementType = cells[4] || '';
        let dataGroup = cells[5] || '';
        let dataAttributes = cells[6] || '';

        const moveSet = new Set(['E', 'R', 'W', 'X']);
        const normalizedMove = (dataMovementType || '').toUpperCase();
        if (!moveSet.has(normalizedMove)) {
          const idx = cells.findIndex(cell => moveSet.has((cell || '').toUpperCase()));
          if (idx !== -1) {
            dataMovementType = (cells[idx] || '').toUpperCase();
            subProcessDesc = cells[idx - 1] || subProcessDesc;
            dataGroup = cells[idx + 1] || dataGroup;
            const attrCells = cells.slice(idx + 2);
            dataAttributes = attrCells.filter(Boolean).join(' | ') || dataAttributes;
          }
        } else {
          dataMovementType = normalizedMove;
        }

        // å¦‚æœä»ç„¶ç¼ºå¤±ï¼Œå°è¯•ä»è¡Œæ•°æ¨æ–­
        if (!dataMovementType) {
          const fallbackIdx = cells.findIndex(cell => moveSet.has((cell || '').toUpperCase()));
          if (fallbackIdx !== -1) {
            dataMovementType = (cells[fallbackIdx] || '').toUpperCase();
          }
        }

        // ã€å…³é”®ä¿®æ­£ã€‘å¤„ç†åŠŸèƒ½è¿‡ç¨‹ä¸å­è¿‡ç¨‹çš„å±‚çº§å…³ç³»
        // è§„åˆ™ï¼šåªæœ‰ E ç±»å‹çš„è¡Œæ‰æœ‰æ–°çš„åŠŸèƒ½è¿‡ç¨‹åç§°ï¼ŒR/W/X è¡Œç»§æ‰¿ä¸Šä¸€ä¸ª E è¡Œçš„åŠŸèƒ½è¿‡ç¨‹
        // ä½†åœ¨æ•°æ®ä¸­ä¿ç•™å®Œæ•´ä¿¡æ¯ç”¨äºç»Ÿè®¡ï¼Œå‰ç«¯æ˜¾ç¤ºæ—¶å†å¤„ç†ç•™ç©ºé€»è¾‘
        let rowFunctionalProcess = '';
        let rowFunctionalUser = '';
        let rowTriggerEvent = '';

        if (dataMovementType === 'E') {
          // E ç±»å‹è¡Œï¼šå¦‚æœæœ‰åŠŸèƒ½è¿‡ç¨‹åç§°ï¼Œæ›´æ–°å½“å‰åŠŸèƒ½è¿‡ç¨‹
          if (cells[2]) {
            currentFunctionalProcess = cells[2];
          }
          // æ™ºèƒ½åˆ¤æ–­è§¦å‘ç±»å‹ï¼šä¼ å…¥åŠŸèƒ½è¿‡ç¨‹åç§°è¿›è¡Œåˆ†æ
          const normalized = normalizeUserTrigger(cells[0], cells[1], currentFunctionalProcess);
          if (cells[0] || cells[1] || currentFunctionalProcess) {
            currentFunctionalUser = normalized.user;
            currentTriggerEvent = normalized.trigger;
          }

          // Eè¡Œæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          rowFunctionalProcess = currentFunctionalProcess;
          rowFunctionalUser = normalized.user || currentFunctionalUser;
          rowTriggerEvent = normalized.trigger || currentTriggerEvent;
        } else {
          // R/W/X ç±»å‹è¡Œï¼šç»§æ‰¿ä¸Šä¸€ä¸ªEè¡Œçš„åŠŸèƒ½è¿‡ç¨‹ï¼ˆç”¨äºç»Ÿè®¡å’Œå»é‡ï¼‰
          // ä½†å‰ç«¯æ˜¾ç¤ºæ—¶è¿™ä¸‰åˆ—åº”è¯¥ç•™ç©ºï¼ˆç¬¦åˆCOSMICè§„èŒƒï¼‰
          if (cells[2] && cells[2] !== currentFunctionalProcess) {
            console.log(`ä¿®æ­£: è¡Œ ${rowIdx} çš„åŠŸèƒ½è¿‡ç¨‹ "${cells[2]}" å±äºå½“å‰åŠŸèƒ½è¿‡ç¨‹: "${currentFunctionalProcess}"`);
          }
          // æ•°æ®ä¸­ä¿ç•™å®Œæ•´ä¿¡æ¯ç”¨äºç»Ÿè®¡ï¼Œå‰ç«¯æ˜¾ç¤ºæ—¶æ ¹æ® dataMovementType åˆ¤æ–­æ˜¯å¦æ˜¾ç¤º
          rowFunctionalProcess = currentFunctionalProcess; // ä¿ç•™ç”¨äºç»Ÿè®¡
          // R/W/Xè¡Œç»§æ‰¿Eè¡Œçš„è§¦å‘ç±»å‹ï¼ˆå·²ç»æ ¹æ®åŠŸèƒ½è¿‡ç¨‹æ™ºèƒ½åˆ¤æ–­è¿‡äº†ï¼‰
          rowFunctionalUser = currentFunctionalUser; // ä¿ç•™ç”¨äºç»Ÿè®¡
          rowTriggerEvent = currentTriggerEvent; // ä¿ç•™ç”¨äºç»Ÿè®¡
        }

        // å¦‚æœæ•°æ®ç»„æˆ–æ•°æ®å±æ€§ç¼ºå¤±ï¼Œè‡ªåŠ¨æ‹¼æ¥åŠŸèƒ½è¿‡ç¨‹+å­è¿‡ç¨‹æè¿°ï¼Œå°½é‡ä¿æŒå”¯ä¸€
        if (!dataGroup) {
          dataGroup = `${currentFunctionalProcess || 'åŠŸèƒ½è¿‡ç¨‹'}Â·${subProcessDesc || 'æ•°æ®'}`;
        }

        if (!dataAttributes) {
          dataAttributes = `${currentFunctionalProcess || 'åŠŸèƒ½è¿‡ç¨‹'}ID | ${subProcessDesc || 'å­è¿‡ç¨‹'}å­—æ®µ | è®°å½•æ—¶é—´`;
        }

        dataAttributes = ensureMinimumAttributes(dataAttributes, currentFunctionalProcess, subProcessDesc);

        // æ¸…ç†æ‰€æœ‰æ–‡æœ¬å­—æ®µä¸­çš„ã€ã€‘æ ‡ç­¾å’Œåºå·
        subProcessDesc = sanitizeText(subProcessDesc);
        dataGroup = sanitizeText(dataGroup);
        dataAttributes = sanitizeText(dataAttributes);
        // åŒæ—¶æ¸…ç†åŠŸèƒ½è¿‡ç¨‹åç§°ä¸­çš„ã€ã€‘æ ‡ç­¾
        if (currentFunctionalProcess) {
          currentFunctionalProcess = sanitizeText(currentFunctionalProcess);
        }
        rowFunctionalProcess = sanitizeText(rowFunctionalProcess);

        // ğŸ”§ åº”ç”¨æ•°æ®å±æ€§æ¸…æ´—ï¼ˆè‹±æ–‡è½¬ä¸­æ–‡ã€é€—å·è½¬é¡¿å·ã€æˆªæ–­è¿‡é•¿ï¼‰
        dataAttributes = cleanDataAttributes(dataAttributes);

        // ğŸ”§ ç®€åŒ–å­è¿‡ç¨‹æè¿°ï¼ˆä¸è¶…è¿‡15ä¸ªå­—ï¼‰
        subProcessDesc = simplifySubProcessDesc(subProcessDesc);

        // å¦‚æœæ•°æ®ç»„åç§°å¤ªç®€å•ï¼ˆå°‘äº5ä¸ªå­—ç¬¦ï¼‰ï¼Œè‡ªåŠ¨è¡¥å……åŠŸèƒ½è¿‡ç¨‹å…³é”®è¯
        if (dataGroup && dataGroup.length < 5) {
          const processKeyword = currentFunctionalProcess.slice(0, 6) || 'ä¸šåŠ¡';
          dataGroup = `${processKeyword}Â·${dataGroup}`;
          console.log(`æ•°æ®ç»„åç§°è¿‡çŸ­ï¼Œå·²è¡¥å……: ${dataGroup}`);
        }

        // è®°å½•å¾…å¤„ç†çš„è¡Œæ•°æ®ï¼Œç¨åç»Ÿä¸€å¤„ç†é‡å¤
        pendingRows.push({
          functionalUser: rowFunctionalUser,
          triggerEvent: rowTriggerEvent,
          functionalProcess: rowFunctionalProcess,
          subProcessDesc,
          dataMovementType,
          dataGroup,
          dataAttributes,
          rowIdx,
          _parentProcess: currentFunctionalProcess // å†…éƒ¨ä½¿ç”¨ï¼Œè®°å½•æ‰€å±çš„åŠŸèƒ½è¿‡ç¨‹
        });
      }
    });

    // ç¬¬1.5éï¼šéªŒè¯æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹çš„å­è¿‡ç¨‹å®Œæ•´æ€§
    // æ ¸å¿ƒåŸåˆ™ï¼šæ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹å¿…é¡»æœ‰å®Œæ•´çš„ E + R + W + X å››ä¸ªå­è¿‡ç¨‹
    const processSubMap = new Map(); // è®°å½•æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹çš„å­è¿‡ç¨‹

    // å…ˆæŒ‰åŠŸèƒ½è¿‡ç¨‹åˆ†ç»„
    for (const row of pendingRows) {
      const processName = row._parentProcess || row.functionalProcess || '';
      if (!processSubMap.has(processName)) {
        processSubMap.set(processName, []);
      }
      processSubMap.get(processName).push(row);
    }

    const filteredRows = [];

    // å¯¹æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹è¿›è¡ŒéªŒè¯å’Œå¤„ç†
    for (const [processName, rows] of processSubMap.entries()) {
      // ç»Ÿè®¡å„ç±»å‹å­è¿‡ç¨‹
      const typeCount = { E: 0, R: 0, W: 0, X: 0 };
      const typeRows = { E: [], R: [], W: [], X: [] };

      for (const row of rows) {
        const moveType = (row.dataMovementType || '').toUpperCase();
        if (typeCount.hasOwnProperty(moveType)) {
          typeCount[moveType]++;
          typeRows[moveType].push(row);
        }
      }

      // æ£€æŸ¥å®Œæ•´æ€§ - å¿…é¡»æœ‰Eã€Rã€Wã€Xå››ç§ç±»å‹
      const hasE = typeCount.E > 0;
      const hasR = typeCount.R > 0;
      const hasW = typeCount.W > 0;
      const hasX = typeCount.X > 0;

      if (!hasE || !hasR || !hasW || !hasX) {
        console.log(`åŠŸèƒ½è¿‡ç¨‹"${processName}"å­è¿‡ç¨‹ä¸å®Œæ•´: E=${typeCount.E}, R=${typeCount.R}, W=${typeCount.W}, X=${typeCount.X}`);
      }

      // ä¿ç•™æ‰€æœ‰å­è¿‡ç¨‹ï¼Œæ¯ç§ç±»å‹ä¿ç•™1ä¸ª
      let keptRows = [];

      // ä¿ç•™Eï¼ˆ1ä¸ªï¼‰
      if (typeRows.E.length > 0) {
        keptRows.push(typeRows.E[0]);
      }

      // ä¿ç•™Rï¼ˆ1ä¸ªï¼‰
      if (typeRows.R.length > 0) {
        keptRows.push(typeRows.R[0]);
      }

      // ä¿ç•™Wï¼ˆ1ä¸ªï¼‰
      if (typeRows.W.length > 0) {
        keptRows.push(typeRows.W[0]);
      }

      // ä¿ç•™Xï¼ˆ1ä¸ªï¼‰
      if (typeRows.X.length > 0) {
        keptRows.push(typeRows.X[0]);
      }

      // æŒ‰æ­£ç¡®é¡ºåºæ’åºï¼ˆE -> R -> W -> Xï¼‰
      keptRows.sort((a, b) => {
        const order = { E: 0, R: 1, W: 2, X: 3 };
        const aOrder = order[(a.dataMovementType || '').toUpperCase()] ?? 99;
        const bOrder = order[(b.dataMovementType || '').toUpperCase()] ?? 99;
        return aOrder - bOrder;
      });

      filteredRows.push(...keptRows);

      if (rows.length !== keptRows.length) {
        console.log(`åŠŸèƒ½è¿‡ç¨‹"${processName}": ${rows.length} -> ${keptRows.length} æ¡å­è¿‡ç¨‹`);
      }
    }

    console.log(`å­è¿‡ç¨‹éªŒè¯å®Œæˆ: ${pendingRows.length} -> ${filteredRows.length} æ¡`);

    // ç¬¬äºŒéï¼šå¤„ç†é‡å¤çš„å­è¿‡ç¨‹æè¿°ã€æ•°æ®ç»„å’Œæ•°æ®å±æ€§ï¼ˆè°ƒç”¨AIæ™ºèƒ½å»é‡ï¼‰
    const tableData = [];
    const seenSubProcessMap = new Map(); // è®°å½•å·²å‡ºç°çš„å­è¿‡ç¨‹æè¿°åŠå…¶æ¥æº
    const seenGroupsMap = new Map(); // è®°å½•å·²å‡ºç°çš„æ•°æ®ç»„åŠå…¶æ¥æº
    const seenAttrsMap = new Map();  // è®°å½•å·²å‡ºç°çš„æ•°æ®å±æ€§åŠå…¶æ¥æº

    for (const row of filteredRows) {
      let { dataGroup, dataAttributes, subProcessDesc, functionalProcess, _parentProcess } = row;
      // ä½¿ç”¨ _parentProcess ä½œä¸ºå®é™…çš„åŠŸèƒ½è¿‡ç¨‹åç§°ï¼ˆç”¨äºå»é‡å’Œç”Ÿæˆï¼‰
      // å…ˆæ¸…ç†ã€ã€‘æ‹¬å·
      const actualProcess = sanitizeText(_parentProcess || functionalProcess || '');

      // å¤„ç†å­è¿‡ç¨‹æè¿°é‡å¤ - ä½¿ç”¨æ™ºèƒ½è¯­ä¹‰åŒ–å»é‡
      const subProcessKey = subProcessDesc.toLowerCase().trim();
      if (subProcessKey && seenSubProcessMap.has(subProcessKey)) {
        // ä½¿ç”¨æ™ºèƒ½è¯­ä¹‰åŒ–å»é‡å‡½æ•°ï¼Œå°†åŠŸèƒ½è¿‡ç¨‹çš„ä¸šåŠ¡åŠ¨ä½œè‡ªç„¶èå…¥å­è¿‡ç¨‹æè¿°
        let newSubProcessDesc = generateSemanticSubProcessDesc(subProcessDesc, actualProcess);
        // å†æ¬¡æ¸…ç†ç”Ÿæˆçš„æ–°æè¿°
        newSubProcessDesc = sanitizeText(newSubProcessDesc);
        if (newSubProcessDesc !== subProcessDesc) {
          console.log(`å­è¿‡ç¨‹æè¿°è¯­ä¹‰åŒ–å»é‡: "${subProcessDesc}" -> "${newSubProcessDesc}"`);
          subProcessDesc = newSubProcessDesc;
        }
      }
      seenSubProcessMap.set(subProcessDesc.toLowerCase().trim(), { name: subProcessDesc, process: actualProcess });

      // å¤„ç†æ•°æ®ç»„é‡å¤ - ç›´æ¥ç»“åˆå…³é”®è¯ç”Ÿæˆæ–°åç§°ï¼Œä¸ä½¿ç”¨æ‹¬å·
      const groupKey = dataGroup.toLowerCase();
      if (seenGroupsMap.has(groupKey)) {
        const existingNames = Array.from(seenGroupsMap.values()).map(v => v.name);
        // è°ƒç”¨AIç”Ÿæˆæ–°çš„å®Œæ•´åç§°ï¼ˆå…³é”®è¯+åŸå†…å®¹ç»“åˆï¼‰
        const newName = await aiGenerateUniqueName(dataGroup, subProcessDesc, actualProcess, existingNames);
        console.log(`æ•°æ®ç»„å»é‡: "${dataGroup}" -> "${newName}"`);
        dataGroup = newName;
      }
      seenGroupsMap.set(dataGroup.toLowerCase(), { name: dataGroup, desc: subProcessDesc });

      // å¤„ç†æ•°æ®å±æ€§é‡å¤ - å°†æ–°ç”Ÿæˆçš„å­—æ®µæ·»åŠ åˆ°åŸæœ‰å­—æ®µä¸­ï¼Œå¹¶æ‰“ä¹±é¡ºåº
      const attrKey = dataAttributes.toLowerCase();
      if (seenAttrsMap.has(attrKey)) {
        const existingNames = Array.from(seenAttrsMap.values()).map(v => v.name);
        // è°ƒç”¨ä¸“é—¨çš„å±æ€§å»é‡å‡½æ•°ï¼Œç”Ÿæˆæ–°å­—æ®µå
        const newFieldName = await aiGenerateUniqueAttrName(dataAttributes, subProcessDesc, actualProcess, existingNames, dataGroup);

        // å°†åŸæœ‰å­—æ®µæ‹†åˆ†æˆæ•°ç»„ï¼ˆæ”¯æŒ | æˆ– , æˆ– ã€ åˆ†éš”ï¼‰
        let fieldsArray = dataAttributes.split(/[|,ã€]/).map(f => f.trim()).filter(Boolean);

        // å°†æ–°ç”Ÿæˆçš„å­—æ®µæ·»åŠ åˆ°æ•°ç»„ä¸­
        fieldsArray.push(newFieldName);

        // æ‰“ä¹±å­—æ®µé¡ºåºï¼ˆFisher-Yates æ´—ç‰Œç®—æ³•ï¼‰
        for (let i = fieldsArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [fieldsArray[i], fieldsArray[j]] = [fieldsArray[j], fieldsArray[i]];
        }

        // é‡æ–°ç»„åˆæˆå­—ç¬¦ä¸²
        const newDataAttributes = ensureMinimumAttributes(fieldsArray.join(', '), actualProcess, subProcessDesc);
        console.log(`æ•°æ®å±æ€§å»é‡: "${dataAttributes}" -> "${newDataAttributes}"`);
        dataAttributes = newDataAttributes;
      }
      seenAttrsMap.set(dataAttributes.toLowerCase(), { name: dataAttributes, desc: subProcessDesc });

      // æœ€ç»ˆæ¸…ç†ï¼šç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½ä¸åŒ…å«ã€ã€‘æ‹¬å·åŠå…¶å†…å®¹ï¼Œå¹¶å»é™¤é‡å¤è¯
      const finalClean = (text) => {
        if (!text) return text;
        return String(text)
          .replace(/ã€[^ã€‘]*ã€‘/g, '')  // å»é™¤ã€xxxã€‘æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
          .replace(/\[[^\]]*\]/g, '')  // å»é™¤[xxx]æ ‡ç­¾ï¼ˆåŒ…æ‹¬å†…å®¹ï¼‰- ä¿®æ­£æ­£åˆ™
          .replace(/([\u4e00-\u9fa5]{2,4})\1+/g, '$1')
          .replace(/\s+/g, ' ')
          .trim();
      };

      subProcessDesc = finalClean(subProcessDesc);
      dataGroup = finalClean(dataGroup);
      dataAttributes = finalClean(dataAttributes);
      // åŒæ—¶æ¸…ç†åŠŸèƒ½è¿‡ç¨‹åç§°
      const cleanedFunctionalProcess = finalClean(row.functionalProcess || '');

      // ç§»é™¤å†…éƒ¨å­—æ®µ _parentProcessï¼Œä¸è¾“å‡ºåˆ°æœ€ç»ˆç»“æœ
      const { _parentProcess: _, ...cleanRow } = row;
      tableData.push({
        ...cleanRow,
        functionalProcess: cleanedFunctionalProcess,
        subProcessDesc,
        dataGroup,
        dataAttributes
      });
    }

    // ========== åŠŸèƒ½è¿‡ç¨‹å®Œæ•´æ€§æ£€æŸ¥ ==========
    // ç¡®ä¿æ¯ä¸ªåŠŸèƒ½è¿‡ç¨‹éƒ½æœ‰å®Œæ•´çš„E+R/W+Xå­è¿‡ç¨‹é“¾
    const completeTableData = ensureProcessCompleteness(tableData);

    // ========== æœ€ç»ˆç³»ç»Ÿæ€§å»é‡æ£€æŸ¥ ==========
    // å¯¹æ•´ä¸ª tableData è¿›è¡Œæœ€ç»ˆçš„å»é‡æ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®ç»„å’Œæ•°æ®å±æ€§æ²¡æœ‰é‡å¤
    const finalTableData = await performFinalDeduplication(completeTableData);

    // ========== æœ€ç»ˆå¼ºåˆ¶æ¸…ç†ã€ã€‘æ‹¬å· ==========
    // ç¡®ä¿è¿”å›çš„æ•°æ®ç»å¯¹ä¸åŒ…å«ã€ã€‘æ‹¬å·
    // ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿å½»åº•æ¸…ç†
    const removeBrackets = (text) => {
      if (!text) return text;
      let result = String(text);
      // æ–¹æ³•1: æ­£åˆ™åŒ¹é…ã€xxxã€‘
      result = result.replace(/ã€[^ã€‘]*ã€‘/g, '');
      // æ–¹æ³•2: æ­£åˆ™åŒ¹é…[xxx]
      result = result.replace(/\[[^\]]*\]/g, '');
      // æ–¹æ³•3: å¾ªç¯æ¸…ç†ï¼Œé˜²æ­¢åµŒå¥—
      while (result.includes('ã€') || result.includes('ã€‘') || result.includes('[') || result.includes(']')) {
        result = result.replace(/ã€[^ã€‘]*ã€‘/g, '');
        result = result.replace(/\[[^\]]*\]/g, '');
        // å¦‚æœè¿˜æœ‰å•ç‹¬çš„æ‹¬å·ï¼Œç›´æ¥åˆ é™¤
        result = result.replace(/[ã€ã€‘\[\]]/g, '');
      }
      return result.replace(/\s+/g, ' ').trim();
    };

    const cleanedFinalData = finalTableData.map(row => {
      const cleaned = {
        ...row,
        functionalProcess: removeBrackets(row.functionalProcess),
        subProcessDesc: removeBrackets(row.subProcessDesc),
        dataGroup: removeBrackets(row.dataGroup),
        dataAttributes: removeBrackets(row.dataAttributes)
      };
      // æ‰“å°æ—¥å¿—ç¡®è®¤æ¸…ç†æ•ˆæœ
      if (row.subProcessDesc && row.subProcessDesc.includes('ã€')) {
        console.log(`æ¸…ç†å‰: "${row.subProcessDesc}" -> æ¸…ç†å: "${cleaned.subProcessDesc}"`);
      }
      return cleaned;
    });

    res.json({ success: true, tableData: cleanedFinalData });
  } catch (error) {
    console.error('è§£æè¡¨æ ¼å¤±è´¥:', error);
    res.status(500).json({ error: 'è§£æè¡¨æ ¼å¤±è´¥: ' + error.message });
  }
});

// é™æ€èµ„æºæ‰˜ç®¡ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
const CLIENT_DIST_PATH = path.join(__dirname, '../client/dist');
if (fs.existsSync(CLIENT_DIST_PATH)) {
  app.use(express.static(CLIENT_DIST_PATH));

  app.get('*', (req, res, next) => {
    if (req.path.startsWith('/api')) {
      return next();
    }
    res.sendFile(path.join(CLIENT_DIST_PATH, 'index.html'));
  });
} else {
  console.warn('âš ï¸  æœªæ£€æµ‹åˆ° client/dist æ„å»ºç›®å½•ï¼Œç”Ÿäº§ç¯å¢ƒå°†æ— æ³•æä¾›å‰ç«¯é™æ€èµ„æº');
}

// å¯åŠ¨æœåŠ¡å™¨ï¼ˆå¸¦ç«¯å£å ç”¨é‡è¯•ï¼‰
function startServer(port, retries = 5) {
  const server = app.listen(port, () => {
    const hasGemini = !!process.env.GEMINI_API_KEY;
    const hasOpenAI = !!process.env.OPENAI_API_KEY;
    const hasZhipu = !!process.env.ZHIPU_API_KEY;
    const hasGroq = !!process.env.GROQ_API_KEY;

    let status = 'æœªé…ç½®';
    if (hasGemini) status = 'å·²é…ç½® (Gemini)';
    else if (hasZhipu) status = 'å·²é…ç½® (æ™ºè°±)';
    else if (hasOpenAI) status = 'å·²é…ç½® (OpenAI)';
    else if (hasGroq) status = 'å·²é…ç½® (Groq)';

    console.log(`ğŸš€ Cosmicæ‹†åˆ†æ™ºèƒ½ä½“æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${port}`);
    console.log(`ğŸ“‹ APIå¯†é’¥çŠ¶æ€: ${status}`);
    if (fs.existsSync(CLIENT_DIST_PATH)) {
      console.log('ğŸ–¥ï¸  é™æ€å‰ç«¯: å·²å¯ç”¨ client/dist äº§ç‰©');
    }
  });

  server.on('error', (err) => {
    if (err.code === 'EADDRINUSE' && retries > 0) {
      const nextPort = port + 1;
      console.warn(`âš ï¸  ç«¯å£ ${port} è¢«å ç”¨ï¼Œå°è¯•ä½¿ç”¨ç«¯å£ ${nextPort}...`);
      setTimeout(() => startServer(nextPort, retries - 1), 300);
    } else {
      console.error('æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', err);
      process.exit(1);
    }
  });
}

startServer(PORT);
