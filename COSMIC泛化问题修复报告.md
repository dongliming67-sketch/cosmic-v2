# COSMIC拆分泛化问题修复报告

## 问题现象

从用户提供的截图可以看到,拆分结果中存在以下问题:

### 红框标注的问题数据

| 子过程描述 | 数据组 | 问题分析 |
|-----------|--------|---------|
| 接收询问低空保障任务请求 | 任务请求 | ❌ 子过程描述和数据组都缺少"低空保障"业务关键词 |
| 读取任务信息表本表 | 任务场景表本表 | ❌ 只有"任务"二字,太笼统,应包含"低空保障任务" |
| 调用任务信息表 | 任务信息表 | ❌ 同上 |
| 返回满意成功提示示 | 响应 | ❌ "响应"过于泛化,应包含业务关键词 |

## 根本原因分析

### 1. AI生成问题
尽管Prompt中明确要求:
- **第零步:业务关键词识别** (lines 493-577 in three-layer-api.js)
- **子过程描述必须复用功能过程的业务关键词** (line 574)
- **数据组必须与功能过程业务对象保持一致** (line 575)

但AI在实际生成时,可能由于:
- 理解不够深入
- 简化倾向
- 上下文遗忘

导致生成了泛化的描述。

### 2. 后处理不足
原有的`cleanupAIResponse`函数(lines 826-1134)虽然有数据清洗逻辑,但:
- 只检测"功能过程"是否笼统(lines 1032-1044)
- **没有检测和修复子过程描述的泛化问题**
- **没有检测和修复数据组的泛化问题**

## 解决方案

### 修复1: 增强后处理逻辑 (three-layer-api.js)

在`cleanupAIResponse`函数中,新增**业务关键词智能注入逻辑**:

#### 步骤1: 从功能过程中提取业务关键词
```javascript
// 移除通用动词(新增、修改、删除、查询、创建等)
// 保留核心业务对象(至少4个字)
// 例如: "创建低空保障任务" → businessKeywords = "低空保障任务"
```

#### 步骤2: 智能增强子过程描述
```javascript
// 检测泛化模式: 
//   - 接收.*?请求
//   - 读取.*?表
//   - 记录.*?日志
//   - 返回.*?结果
// 如果检测到泛化且不包含业务关键词,则注入:
//   "接收请求" → "接收低空保障任务创建请求"
```

#### 步骤3: 智能增强数据组
```javascript
// 检测超级泛化名词: 请求、响应、数据、信息、表、日志
// 如果检测到且不包含业务关键词,则注入:
//   "请求" → "低空保障任务请求"
//   "响应" → "低空保障任务响应"
```

### 修复2: 强化Prompt要求 (enhanced-prompts.js)

在ERWX详细填充规则部分,为每个数据移动类型增加:

#### E/R/W/X 核心要求
- **🚨 子过程描述必须包含功能过程中的完整业务关键词**
- **业务关键词必须至少4个字**

#### 错误示例对比
```
❌ 禁止泛化: 接收请求数据 (缺少业务场景)
❌ 禁止泛化: 接收任务请求 ("任务"太笼统)
✅ 正确示例: 接收低空保障任务创建请求 (包含"低空保障"业务关键词)
```

#### 业务关键词提取方法
```
1. 移除通用动词: "创建参数自动化派单任务" → "参数自动化派单任务"
2. 保留核心业务对象: 必须至少4个字, 包含具体业务场景
3. 应用到所有ERWX子过程:
   - E: 接收**参数自动化派单任务**创建请求
   - R: 读取**参数自动化派单**规则配置
   - W: 记录**参数自动化派单任务**创建流水
   - X: 返回**参数自动化派单任务**创建回执
```

## 预期效果

### 修复前
```
功能过程: 低空保障任务查询
|E|接收请求|任务请求|...
|R|读取表|任务信息表|...
|W|记录日志|日志表|...
|X|返回响应|响应|...
```

### 修复后
```
功能过程: 低空保障任务查询
|E|接收低空保障任务查询请求|低空保障任务查询请求|...
|R|读取低空保障任务配置数据|低空保障任务配置表|...
|W|记录低空保障任务查询日志|低空保障任务查询日志表|...
|X|返回低空保障任务查询结果|低空保障任务查询响应|...
```

## 验证方法

1. **重新运行拆分**: 上传同样的文档,观察新生成的表格
2. **检查控制台日志**: 查看是否有🔧标记的增强日志
3. **验证检查清单**:
   - [ ] 所有E子过程描述都包含业务关键词(至少4个字)?
   - [ ] 所有R子过程描述都包含业务关键词?
   - [ ] 所有W子过程描述都包含业务关键词?
   - [ ] 所有X子过程描述都包含业务关键词?
   - [ ] 所有数据组名称都包含业务关键词?
   - [ ] 没有"请求"、"响应"、"数据"、"信息"等超级泛化词单独出现?

## 技术细节

### 修改文件
1. `server/three-layer-api.js` (lines 1032-1107): 新增业务关键词智能注入逻辑
2. `serverenhanced-prompts.js` (lines 388-484): 强化ERWX子过程描述要求

### 核心算法
- **业务关键词提取**: 去除通用动词,保留至少4个字的核心业务对象
- **泛化检测**: 正则模式匹配,识别常见泛化描述
- **智能注入**: 在动词后插入业务关键词,确保语义流畅

## 建议

1. **立即测试**: 重新运行之前出问题的文档拆分
2. **观察日志**: 查看后端控制台的🔧增强日志
3. **反馈调整**: 如果发现新的泛化模式,可以继续补充检测规则

---

**修复完成时间**: 2026-01-23  
**修复复杂度**: 7/10  
**预期改善**: 显著减少子过程描述和数据组的泛化问题,提升拆分质量
